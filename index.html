<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workezz ‚Äì Sheet Merger</title>
<link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Modern light theme - warm off-white base */
  --bg:#eef0f5;
  --white:#ffffff;
  --surface:#f7f8fb;
  --surface2:#eceef4;
  --border:#dde0ea;
  --border2:#c8ccda;
  --accent:#2563eb;
  --accent-light:#dbeafe;
  --accent-hover:#1d4ed8;
  --text:#1e2235;
  --text2:#4a5072;
  --muted:#8890aa;
  --success:#15803d;
  --success-bg:#dcfce7;
  --success-border:#86efac;
  --warning:#92400e;
  --warning-bg:#fef3c7;
  --warning-border:#fcd34d;
  --danger:#b91c1c;
  --danger-bg:#fee2e2;
  --danger-border:#fca5a5;
  --updated:#6d28d9;
  --updated-bg:#ede9fe;
  --updated-border:#c4b5fd;
  --shadow:0 1px 3px rgba(30,34,53,.07),0 1px 2px rgba(30,34,53,.05);
  --shadow-md:0 4px 16px rgba(30,34,53,.09),0 2px 4px rgba(30,34,53,.05);
  --shadow-lg:0 8px 32px rgba(30,34,53,.12);
  --radius:10px;
  --radius-sm:6px;
}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

/* HEADER */
header{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-md);flex-shrink:0;position:sticky;top:0;z-index:100;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;letter-spacing:-.02em;color:var(--text);}
.logo span{color:var(--accent);}
.logo-sub{font-size:.62rem;color:var(--muted);font-family:'IBM Plex Sans',sans-serif;font-weight:500;letter-spacing:.04em;margin-top:-2px;}
.logo-mark svg rect{transition:fill .2s;}
body.dark .logo-mark svg rect{fill:#4f8eff;}
.version-badge{font-size:.65rem;background:var(--accent-light);color:var(--accent);padding:3px 10px;border-radius:100px;font-weight:600;letter-spacing:.04em;}

/* STEPPER */
.stepper{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;display:flex;align-items:center;flex-shrink:0;}
.step{display:flex;align-items:center;gap:8px;padding:14px 16px 14px 0;font-size:.78rem;font-weight:500;color:var(--muted);transition:color .2s;cursor:default;}
.step.active{color:var(--accent);}
.step.done{color:var(--success);}
.step-num{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.7rem;font-weight:600;background:var(--surface2);color:var(--muted);transition:all .2s;flex-shrink:0;}
.step.active .step-num{background:var(--accent);color:#fff;box-shadow:0 0 0 3px var(--accent-light);}
.step.done .step-num{background:var(--success);color:#fff;}
.step-arrow{color:var(--border2);margin-right:16px;font-size:.9rem;}

/* SCREENS */
.screen{display:none;flex:1;flex-direction:column;overflow:hidden;animation:fadeIn .22s ease;}
.screen.active{display:flex;}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

/* ‚îÄ‚îÄ SCREEN 1 ‚îÄ‚îÄ */
.s1-layout{display:grid;grid-template-columns:360px 1fr;flex:1;overflow:hidden;}
.s1-left{background:var(--white);border-right:1px solid var(--border);padding:24px 20px;display:flex;flex-direction:column;gap:20px;overflow-y:auto;box-shadow:2px 0 8px rgba(30,34,53,.04);}
.s1-right{padding:24px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;}
.section-label{font-size:.68rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}

/* Drop zone */
.drop-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:32px 16px;text-align:center;cursor:pointer;transition:border-color .2s,background .2s,box-shadow .2s;position:relative;background:var(--surface);}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:var(--accent-light);box-shadow:0 0 0 4px rgba(37,99,235,.08);}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dz-icon{font-size:2rem;margin-bottom:8px;display:block;}
.dz-text{font-size:.8rem;color:var(--text2);line-height:1.5;}
.dz-text strong{color:var(--accent);}
.dz-sub{font-size:.68rem;color:var(--muted);margin-top:4px;}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;letter-spacing:.01em;}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 1px 3px rgba(37,99,235,.3);}
.btn-primary:hover{background:var(--accent-hover);box-shadow:0 2px 8px rgba(37,99,235,.4);transform:translateY(-1px);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;box-shadow:none;transform:none;}
.btn-secondary{background:var(--white);color:var(--text2);border:1px solid var(--border2);}
.btn-secondary:hover{background:var(--surface2);border-color:var(--border2);}
.btn-success{background:var(--success);color:#fff;box-shadow:0 1px 3px rgba(21,128,61,.25);}
.btn-success:hover{background:#166534;transform:translateY(-1px);}
.btn-danger-outline{background:transparent;color:var(--danger);border:1px solid var(--danger-border);}
.btn-danger-outline:hover{background:var(--danger-bg);}
.btn-import{background:var(--surface2);color:var(--text2);border:1px solid var(--border2);font-size:.74rem;padding:5px 10px;}
.btn-import:hover{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}
.btn-full{width:100%;}
.btn-lg{padding:11px 22px;font-size:.9rem;}
.btn-sm{padding:4px 10px;font-size:.72rem;}

/* FILE TABLE */
.file-table-wrap{border-radius:var(--radius);overflow:hidden;border:1px solid var(--border);background:var(--white);box-shadow:var(--shadow);}
table{width:100%;border-collapse:collapse;}
thead th{background:var(--surface2);padding:9px 14px;text-align:left;font-size:.66rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
tbody td{padding:11px 14px;font-size:.8rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover{background:var(--surface);}
tbody tr{animation:rowSlide .2s ease forwards;opacity:0;}
@keyframes rowSlide{from{opacity:0;transform:translateX(-5px)}to{opacity:1;transform:translateX(0)}}
.sr-no{color:var(--muted);font-family:'IBM Plex Mono',monospace;font-size:.72rem;width:44px;}
.file-chip{display:inline-flex;align-items:center;gap:8px;}
.file-chip-icon{width:28px;height:28px;border-radius:5px;background:var(--accent-light);color:var(--accent);display:flex;align-items:center;justify-content:center;font-size:.66rem;font-weight:700;font-family:'IBM Plex Mono',monospace;flex-shrink:0;}
.file-chip-name{font-size:.8rem;color:var(--text);font-weight:500;}
.file-chip-size{font-size:.68rem;color:var(--muted);}
.empty-table{text-align:center;padding:44px 20px;color:var(--muted);}
.empty-table p{font-size:.8rem;margin-top:6px;line-height:1.5;}
.action-footer{display:flex;justify-content:flex-end;margin-top:14px;}

/* Info box */
.info-box{background:var(--accent-light);border:1px solid #bfdbfe;border-radius:var(--radius-sm);padding:10px 14px;font-size:.72rem;color:#1e40af;line-height:1.6;}

/* MRS upload strip */
.mrs-strip{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;display:flex;align-items:center;justify-content:space-between;gap:12px;box-shadow:var(--shadow);}
.mrs-strip-info{display:flex;flex-direction:column;gap:2px;}
.mrs-strip-title{font-size:.78rem;font-weight:600;color:var(--text);}
.mrs-strip-sub{font-size:.7rem;color:var(--muted);}
.mrs-file-name{font-size:.74rem;color:var(--success);font-weight:600;display:flex;align-items:center;gap:4px;}

/* ‚îÄ‚îÄ SCREEN 2 ‚îÄ‚îÄ */
.s2-layout{display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:22px;flex:1;align-content:start;overflow-y:auto;}
.s2-full{grid-column:1/-1;}
.panel{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);}
.panel-head{padding:12px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;background:var(--surface);}
.panel-head h3{font-size:.8rem;font-weight:600;color:var(--text);}
.panel-head .ph-sub{font-size:.7rem;color:var(--muted);}
.panel-body{padding:16px;display:flex;flex-direction:column;gap:10px;}

/* Tag inputs */
.tag-row{display:flex;align-items:center;gap:8px;}
.tag-input-wrap{display:flex;flex-wrap:wrap;gap:5px;min-height:38px;padding:5px 8px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--white);cursor:text;align-items:center;flex:1;}
.tag-input-wrap:focus-within{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
.tag{display:inline-flex;align-items:center;gap:4px;background:var(--accent-light);color:var(--accent);padding:2px 7px;border-radius:4px;font-size:.72rem;font-weight:500;border:1px solid #bfdbfe;}
.tag-x{cursor:pointer;opacity:.6;font-size:.82rem;line-height:1;transition:opacity .1s;}
.tag-x:hover{opacity:1;}
.tag-input-real{border:none;outline:none;font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;color:var(--text);background:transparent;min-width:70px;flex:1;}

/* Find replace */
.find-replace-row{display:grid;grid-template-columns:1fr auto 1fr;gap:7px;align-items:center;}
.find-replace-row span{color:var(--muted);font-size:.78rem;text-align:center;}
.field-input{width:100%;padding:7px 10px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;color:var(--text);outline:none;transition:border-color .2s;background:var(--white);}
.field-input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.1);}

/* Toggles */
.toggle-grid{display:grid;grid-template-columns:1fr 1fr;gap:7px;}
.toggle-item{display:flex;align-items:center;justify-content:space-between;padding:9px 12px;border:1px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);}
.toggle-item label{font-size:.78rem;font-weight:500;color:var(--text2);cursor:pointer;}
.toggle{position:relative;width:34px;height:19px;flex-shrink:0;}
.toggle input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border2);border-radius:100px;transition:.2s;cursor:pointer;}
.toggle-slider:before{content:'';position:absolute;width:13px;height:13px;left:3px;bottom:3px;background:#fff;border-radius:50%;transition:.2s;box-shadow:0 1px 2px rgba(0,0,0,.15);}
.toggle input:checked+.toggle-slider{background:var(--accent);}
.toggle input:checked+.toggle-slider:before{transform:translateX(15px);}

/* Col map */
.col-map-table{width:100%;border-collapse:collapse;}
.col-map-table th{background:var(--surface2);padding:8px 12px;text-align:left;font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--muted);border-bottom:1px solid var(--border);}
.col-map-table td{padding:8px 12px;border-bottom:1px solid var(--border);font-size:.78rem;vertical-align:middle;}
.col-map-table tr:last-child td{border-bottom:none;}
.col-input{width:55px;padding:4px 7px;border:1px solid var(--border);border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:.78rem;text-align:center;outline:none;background:var(--white);}
.col-input:focus{border-color:var(--accent);}
.field-badge{display:inline-flex;align-items:center;gap:4px;font-size:.74rem;font-weight:600;color:var(--text2);}
.req-dot{width:5px;height:5px;border-radius:50%;background:var(--accent);display:inline-block;}
.s2-footer{padding:0 22px 22px;display:flex;justify-content:space-between;align-items:center;flex-shrink:0;background:var(--bg);}
.s2-footer-info{font-size:.76rem;color:var(--muted);}

/* ‚îÄ‚îÄ SCREEN 3 ‚îÄ‚îÄ */
.s3-layout{display:flex;flex-direction:column;flex:1;padding:22px;gap:16px;overflow-y:auto;}

/* Filter buttons (replaced stat cards) */
.filter-bar{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.filter-btn{display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:var(--radius);border:2px solid var(--border);background:var(--white);cursor:pointer;transition:all .18s;box-shadow:var(--shadow);font-family:'IBM Plex Sans',sans-serif;}
.filter-btn:hover{border-color:var(--border2);background:var(--surface);transform:translateY(-1px);box-shadow:var(--shadow-md);}
.filter-btn.active{border-color:var(--accent);background:var(--accent-light);box-shadow:0 0 0 3px rgba(37,99,235,.1);}
.filter-btn-icon{font-size:.88rem;}
.filter-btn-label{font-size:.76rem;font-weight:600;color:var(--text2);}
.filter-btn.active .filter-btn-label{color:var(--accent);}
.filter-btn-count{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;color:var(--text);min-width:28px;text-align:right;}
.filter-btn.active .filter-btn-count{color:var(--accent);}
.filter-btn.filter-all .filter-btn-count{color:var(--accent);}
.filter-btn.filter-new.active{border-color:var(--success);background:var(--success-bg);}
.filter-btn.filter-new.active .filter-btn-label,.filter-btn.filter-new.active .filter-btn-count{color:var(--success);}
.filter-btn.filter-updated.active{border-color:var(--updated);background:var(--updated-bg);}
.filter-btn.filter-updated.active .filter-btn-label,.filter-btn.filter-updated.active .filter-btn-count{color:var(--updated);}
.filter-btn.filter-mismatch.active{border-color:var(--danger);background:var(--danger-bg);}
.filter-btn.filter-mismatch.active .filter-btn-label,.filter-btn.filter-mismatch.active .filter-btn-count{color:var(--danger);}
.filter-btn.filter-skipped.active{border-color:var(--warning);background:var(--warning-bg);}
.filter-btn.filter-skipped.active .filter-btn-label,.filter-btn.filter-skipped.active .filter-btn-count{color:var(--warning);}

.preview-table-wrap{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:auto;flex:1;}
.status-pill{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:.68rem;font-weight:600;}
.pill-new{background:var(--success-bg);color:var(--success);border:1px solid var(--success-border);}
.pill-updated{background:var(--updated-bg);color:var(--updated);border:1px solid var(--updated-border);}
.pill-mismatch{background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger-border);}
.pill-skipped{background:var(--warning-bg);color:var(--warning);border:1px solid var(--warning-border);}
.row-mismatch td{background:#fff5f5;}

.warn-panel{background:var(--warning-bg);border:1px solid var(--warning-border);border-radius:var(--radius);padding:12px 16px;}
.warn-panel h4{font-size:.76rem;font-weight:600;color:var(--warning);margin-bottom:6px;}
.warn-list{list-style:none;display:flex;flex-direction:column;gap:4px;}
.warn-list li{font-size:.75rem;color:var(--warning);}

/* ‚îÄ‚îÄ SCREEN 4 ‚îÄ‚îÄ */
.s4-layout{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:32px;gap:20px;overflow-y:auto;}
.s4-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow-md);padding:28px;width:100%;max-width:580px;}
.s4-card h3{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin-bottom:5px;color:var(--text);}
.s4-card p{font-size:.8rem;color:var(--text2);margin-bottom:16px;line-height:1.6;}
.export-preview{background:var(--surface2);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:16px;font-family:'IBM Plex Mono',monospace;font-size:.7rem;color:var(--text2);line-height:2;border:1px solid var(--border);}
.export-filename{color:var(--accent);font-weight:600;}

::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}

/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
body.dark {
  --bg:#13151f;
  --white:#1e2235;
  --surface:#252840;
  --surface2:#2d3148;
  --border:#363b58;
  --border2:#444968;
  --accent:#4f8eff;
  --accent-light:#1e2d4a;
  --accent-hover:#6aa3ff;
  --text:#e8eaf2;
  --text2:#9ba3c0;
  --muted:#6b7494;
  --success:#22c55e;
  --success-bg:#0f2d1a;
  --success-border:#166534;
  --warning:#fbbf24;
  --warning-bg:#2d2008;
  --warning-border:#854d0e;
  --danger:#f87171;
  --danger-bg:#2d0f0f;
  --danger-border:#991b1b;
  --updated:#a78bfa;
  --updated-bg:#1e1535;
  --updated-border:#5b21b6;
  --shadow:0 1px 3px rgba(0,0,0,.3),0 1px 2px rgba(0,0,0,.2);
  --shadow-md:0 4px 16px rgba(0,0,0,.4),0 2px 4px rgba(0,0,0,.3);
}
body.dark header{background:#1a1d2e;border-color:#2a2e45;}
body.dark .stepper{background:#1a1d2e;border-color:#2a2e45;}
body.dark .s1-left{background:#1a1d2e;border-color:#2a2e45;}
body.dark .panel-head{background:#252840;}
body.dark .info-box{background:#1e2d4a;border-color:#1e3a6e;color:#93c5fd;}
body.dark .mrs-strip{background:#1e2235;}
body.dark .drop-zone{background:#252840;border-color:#444968;}
body.dark .drop-zone:hover,.drop-zone.dragover{background:#1e2d4a;}
body.dark .s2-footer{background:#13151f;}
body.dark tbody tr:hover{background:#252840;}
body.dark .toggle-item{background:#252840;}
body.dark .tag{background:#1e2d4a;border-color:#1e3a6e;color:#93c5fd;}
body.dark .field-input{background:#252840;color:var(--text);}
body.dark .col-input{background:#252840;color:var(--text);}
body.dark .export-preview{background:#252840;border-color:#363b58;}
body.dark .filter-btn{background:#1e2235;border-color:#363b58;}
body.dark .filter-btn:hover{background:#252840;}
body.dark .preview-table-wrap{background:#1e2235;}
body.dark thead th{background:#252840;}
body.dark .row-mismatch td{background:#2d1515;}
body.dark .s4-card{background:#1e2235;}

/* Dark mode toggle button */
.dark-toggle{
  display:flex;align-items:center;gap:8px;
  background:var(--surface2);border:1px solid var(--border);
  border-radius:100px;padding:5px 12px;cursor:pointer;
  font-size:.75rem;font-weight:600;color:var(--text2);
  transition:all .2s;font-family:'IBM Plex Sans',sans-serif;
}
.dark-toggle:hover{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}
.dark-toggle-icon{font-size:.9rem;transition:transform .3s;}
body.dark .dark-toggle-icon{transform:rotate(180deg);}

</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <!-- Logo mark -->
    <div class="logo-mark">
      <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="8" fill="#2563eb"/>
        <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="16" cy="13" r="1.5" fill="white"/>
      </svg>
    </div>
    <div>
      <div class="logo">Work<span>ezz</span></div>
      <div class="logo-sub">by Krish Makwane</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:12px;">
    <button class="dark-toggle" onclick="toggleDark()" id="darkToggle">
      <span class="dark-toggle-icon" id="darkIcon">üåô</span>
      <span id="darkLabel">Dark Mode</span>
    </button>
    <span class="version-badge">MVP v2.0</span>
  </div>
</header>

<div class="stepper">
  <div class="step active" id="step1"><div class="step-num">1</div> Upload Center</div>
  <span class="step-arrow">‚Ä∫</span>
  <div class="step" id="step2"><div class="step-num">2</div> Operations</div>
  <span class="step-arrow">‚Ä∫</span>
  <div class="step" id="step3"><div class="step-num">3</div> Live Preview</div>
  <span class="step-arrow">‚Ä∫</span>
  <div class="step" id="step4"><div class="step-num">4</div> Export</div>
</div>

<!-- ‚ïê‚ïê SCREEN 1 ‚ïê‚ïê -->
<div class="screen active" id="screen1">
  <div class="s1-layout">
    <div class="s1-left">
      <div>
        <div class="section-label">Upload Panel Files</div>
        <div class="drop-zone" id="dropZone">
          <input type="file" id="fileInput" multiple accept=".xls,.xlsx">
          <span class="dz-icon">üìÇ</span>
          <div class="dz-text"><strong>Click to browse</strong> or drag & drop</div>
          <div class="dz-sub">Supports .xls and .xlsx (WPS / Excel)</div>
        </div>
      </div>
      <button class="btn btn-primary btn-full" onclick="addFiles()">Ôºã Add Files to List</button>

      <!-- MRS Upload -->
      <div>
        <div class="section-label">MRS File (Optional)</div>
        <div class="mrs-strip">
          <div class="mrs-strip-info">
            <div class="mrs-strip-title">Upload MRS Quantity Sheet</div>
            <div id="mrsFileName" class="mrs-strip-sub">No file selected ‚Äî MRS columns will be hidden</div>
          </div>
          <div style="display:flex;gap:8px;align-items:center;position:relative;">
            <input type="file" id="mrsInput" accept=".xls,.xlsx" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;">
            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('mrsInput').click()">üìã Browse</button>
            <button class="btn btn-danger-outline btn-sm" id="mrsClearBtn" onclick="clearMRS()" style="display:none;">‚úï</button>
          </div>
        </div>
      </div>

      <div class="info-box">
        ‚ÑπÔ∏è Data is read from <strong>Row 9 onwards</strong> by default. Adjustable in Operations.
      </div>
    </div>

    <div class="s1-right">
      <div style="display:flex;align-items:center;justify-content:space-between;">
        <div class="section-label" style="margin-bottom:0;">Uploaded Panel Files</div>
        <span id="s1FileCount" style="font-size:.72rem;color:var(--muted);background:var(--surface2);padding:2px 10px;border-radius:100px;border:1px solid var(--border);">0 files</span>
      </div>
      <div class="file-table-wrap">
        <table>
          <thead><tr><th style="width:44px">#</th><th>File Name</th><th>Size</th><th style="text-align:right">Action</th></tr></thead>
          <tbody id="fileTable">
            <tr id="emptyRow1"><td colspan="4"><div class="empty-table">üìã<p>No files added yet.<br>Upload .xls or .xlsx panel sheets above.</p></div></td></tr>
          </tbody>
        </table>
      </div>
      <div class="action-footer">
        <button class="btn btn-primary btn-lg" id="nextBtn1" onclick="goTo(2)" disabled>Next: Operations &nbsp;‚Ä∫</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SCREEN 2 ‚ïê‚ïê -->
<div class="screen" id="screen2">
  <div class="s2-layout">

    <!-- Prefixes -->
    <div class="panel">
      <div class="panel-head">
        <h3>Remove Prefixes</h3>
        <span class="ph-sub">Part Number only</span>
      </div>
      <div class="panel-body">
        <p style="font-size:.74rem;color:var(--muted);">Type then press <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:.68rem;">Enter</kbd> to add</p>
        <div class="tag-row">
          <div class="tag-input-wrap" id="prefixWrap" onclick="this.querySelector('input').focus()">
            <input class="tag-input-real" id="prefixInput" placeholder="e.g. PXC." onkeydown="addTag('prefix',event)">
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:8px;padding-top:2px;">
          <div style="position:relative;flex:1;">
            <input type="file" id="psPrefixInput" accept=".xls,.xlsx" style="position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;" onchange="importPrefixSuffix(this)">
            <button class="btn btn-import btn-full">üì• Import from Excel (Col A = Prefix, Col C = Suffix)</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Suffixes -->
    <div class="panel">
      <div class="panel-head">
        <h3>Remove Suffixes</h3>
        <span class="ph-sub">Part Number only</span>
      </div>
      <div class="panel-body">
        <p style="font-size:.74rem;color:var(--muted);">Type then press <kbd style="background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:1px 5px;font-size:.68rem;">Enter</kbd> to add</p>
        <div class="tag-row">
          <div class="tag-input-wrap" id="suffixWrap" onclick="this.querySelector('input').focus()">
            <input class="tag-input-real" id="suffixInput" placeholder="e.g. -OLD" onkeydown="addTag('suffix',event)">
          </div>
        </div>
        <p style="font-size:.7rem;color:var(--muted);padding-top:2px;">‚¨Ü Use the Import button in Prefixes panel to load both at once</p>
      </div>
    </div>

    <!-- Find & Replace -->
    <div class="panel">
      <div class="panel-head"><h3>Find & Replace</h3><span class="ph-sub">In Part Number</span></div>
      <div class="panel-body">
        <div id="frRows"></div>
        <button class="btn btn-secondary btn-sm" style="margin-top:2px;" onclick="addFRRow()">Ôºã Add Rule</button>
      </div>
    </div>

    <!-- Toggles -->
    <div class="panel">
      <div class="panel-head"><h3>Additional Cleaning</h3><span class="ph-sub">Part Number only</span></div>
      <div class="panel-body">
        <div class="toggle-grid">
          <div class="toggle-item"><label for="togTrim">Trim Spaces</label><label class="toggle"><input type="checkbox" id="togTrim" checked><span class="toggle-slider"></span></label></div>
          <div class="toggle-item"><label for="togProper">Proper Case</label><label class="toggle"><input type="checkbox" id="togProper"><span class="toggle-slider"></span></label></div>
          <div class="toggle-item"><label for="togSpecial">Remove Special Chars</label><label class="toggle"><input type="checkbox" id="togSpecial"><span class="toggle-slider"></span></label></div>
          <div class="toggle-item"><label for="togUpper">UPPERCASE</label><label class="toggle"><input type="checkbox" id="togUpper"><span class="toggle-slider"></span></label></div>
        </div>
        <p style="font-size:.7rem;color:var(--muted);padding-top:4px;">‚ö†Ô∏è Numbers are never stripped ‚Äî Part Numbers are alphanumeric.</p>
      </div>
    </div>

    <!-- Column Mapping -->
    <div class="panel s2-full">
      <div class="panel-head"><h3>Column Mapping</h3><span class="ph-sub">Auto-detected defaults ‚Äî editable</span></div>
      <div class="panel-body" style="padding:0;">
        <table class="col-map-table">
          <thead><tr><th>Field</th><th>Column</th><th>Notes</th></tr></thead>
          <tbody>
            <tr><td><span class="field-badge">üìç Data Start Row</span></td><td><input class="col-input" id="startRow" value="9"></td><td style="font-size:.74rem;color:var(--muted);">Rows before this are skipped (headers)</td></tr>
            <tr><td><span class="field-badge"><span class="req-dot"></span> Make / Brand</span></td><td><input class="col-input" id="colMake" value="A"></td><td style="font-size:.74rem;color:var(--muted);">Manufacturer / brand column</td></tr>
            <tr><td><span class="field-badge"><span class="req-dot"></span> Part Number</span></td><td><input class="col-input" id="colPart" value="B"></td><td style="font-size:.74rem;color:var(--muted);">Alphanumeric ‚Äî unique merge key</td></tr>
            <tr><td><span class="field-badge"><span class="req-dot"></span> Part Description</span></td><td><input class="col-input" id="colName" value="C"></td><td style="font-size:.74rem;color:var(--muted);">Most frequent name wins on conflict</td></tr>
            <tr><td><span class="field-badge"><span class="req-dot"></span> Quantity</span></td><td><input class="col-input" id="colQty" value="O"></td><td style="font-size:.74rem;color:var(--muted);">Must be numeric and >= 0</td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </div>
  <div class="s2-footer">
    <button class="btn btn-secondary" onclick="goTo(1)">‚Äπ Back</button>
    <div style="display:flex;gap:10px;align-items:center;">
      <span class="s2-footer-info" id="s2Info"></span>
      <button class="btn btn-primary btn-lg" onclick="runMerge()">‚ö° Merge & Preview</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SCREEN 3 ‚ïê‚ïê -->
<div class="screen" id="screen3">
  <div class="s3-layout">

    <!-- Filter buttons -->
    <div class="filter-bar">
      <button class="filter-btn filter-all active" onclick="setFilter('all')">
        <span class="filter-btn-icon">üìã</span>
        <span class="filter-btn-label">All Rows</span>
        <span class="filter-btn-count" id="countAll">0</span>
      </button>
      <button class="filter-btn filter-new" onclick="setFilter('new')">
        <span class="filter-btn-icon">üü¢</span>
        <span class="filter-btn-label">New</span>
        <span class="filter-btn-count" id="countNew">0</span>
      </button>
      <button class="filter-btn filter-updated" onclick="setFilter('updated')">
        <span class="filter-btn-icon">üü°</span>
        <span class="filter-btn-label">Qty Updated</span>
        <span class="filter-btn-count" id="countUpdated">0</span>
      </button>
      <button class="filter-btn filter-mismatch" onclick="setFilter('mismatch')">
        <span class="filter-btn-icon">üî¥</span>
        <span class="filter-btn-label">Name Mismatch</span>
        <span class="filter-btn-count" id="countMismatch">0</span>
      </button>
      <button class="filter-btn filter-skipped" onclick="setFilter('skipped')">
        <span class="filter-btn-icon">‚ö†Ô∏è</span>
        <span class="filter-btn-label">Skipped</span>
        <span class="filter-btn-count" id="countSkipped">0</span>
      </button>
    </div>

    <div id="warnPanel" class="warn-panel" style="display:none;">
      <h4>‚ö†Ô∏è Warnings</h4>
      <ul class="warn-list" id="warnList"></ul>
    </div>

    <div class="preview-table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:44px">#</th>
            <th>Make</th>
            <th>Part Number</th>
            <th>Part Description</th>
            <th>Total Qty</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="previewTable"></tbody>
      </table>
    </div>

    <div style="display:flex;justify-content:space-between;">
      <button class="btn btn-secondary" onclick="goTo(2)">‚Äπ Back</button>
      <button class="btn btn-primary btn-lg" onclick="goTo(4)">Export &nbsp;‚Ä∫</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SCREEN 4 ‚ïê‚ïê -->
<div class="screen" id="screen4">
  <div class="s4-layout">
    <div class="s4-card">
      <h3>‚úÖ Export Master Sheet</h3>
      <p>Downloads the fully merged master sheet with per-file quantity breakdown, and MRS columns if MRS file was uploaded.</p>
      <div class="export-preview">
        üìÑ <span class="export-filename" id="exportFileName">Workezz_Merged_YYYY-MM-DD.xlsx</span><br>
        SR ¬∑ Make ¬∑ Part Number ¬∑ Part Description ¬∑ [File Columns] ¬∑ Total Qty<span id="exportMrsCols"></span>
      </div>
      <button class="btn btn-success btn-full btn-lg" onclick="exportMerged()">‚¨á Download Master Sheet</button>
    </div>
    <div class="s4-card">
      <h3>‚ö†Ô∏è Download Error Report</h3>
      <p>All skipped rows with error reasons ‚Äî for auditing and data correction.</p>
      <div class="export-preview">
        üìÑ <span class="export-filename" id="errorFileName">Workezz_Error_Report_YYYY-MM-DD.xlsx</span><br>
        File ¬∑ Row ¬∑ Make ¬∑ Part No ¬∑ Part Description ¬∑ Qty ¬∑ Reason
      </div>
      <button class="btn btn-danger-outline btn-full btn-lg" onclick="exportErrors()" id="errorBtn">‚¨á Download Error Report</button>
    </div>
    <div style="display:flex;gap:10px;">
      <button class="btn btn-secondary" onclick="goTo(3)">‚Äπ Back to Preview</button>
      <button class="btn btn-secondary" onclick="resetApp()">‚Ü∫ Start Over</button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
const state = {
  files: [],
  prefixes: [], suffixes: [], findReplace: [],
  merged: [], errors: [], warnings: [],
  mrsFile: null, mrsData: null,   // MRS
  currentFilter: 'all'
};

// ‚ïê‚ïê NAVIGATION ‚ïê‚ïê
function goTo(n) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.step').forEach((s, i) => {
    s.classList.remove('active', 'done');
    if (i + 1 < n) s.classList.add('done');
    if (i + 1 === n) s.classList.add('active');
  });
  document.getElementById('screen' + n).classList.add('active');
  if (n === 4) setExportNames();
}

// ‚ïê‚ïê DRAG & DROP ‚ïê‚ïê
const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  document.getElementById('fileInput').files = e.dataTransfer.files;
  addFiles();
});

// ‚ïê‚ïê ADD PANEL FILES ‚ïê‚ïê
function addFiles() {
  const input = document.getElementById('fileInput');
  if (!input.files.length) { alert('Please select files first.'); return; }
  for (const file of input.files) {
    if (state.files.find(f => f.name === file.name)) continue;
    state.files.push({ file, name: file.name, size: file.size });
  }
  input.value = '';
  renderFileTable();
}

function removeFile(name) {
  state.files = state.files.filter(f => f.name !== name);
  renderFileTable();
}

function renderFileTable() {
  const tbody = document.getElementById('fileTable');
  const count = state.files.length;
  document.getElementById('s1FileCount').textContent = count + ' file' + (count !== 1 ? 's' : '');
  document.getElementById('nextBtn1').disabled = count === 0;
  if (!count) {
    tbody.innerHTML = `<tr id="emptyRow1"><td colspan="4"><div class="empty-table">üìã<p>No files added yet.<br>Upload .xls or .xlsx panel sheets above.</p></div></td></tr>`;
    return;
  }
  tbody.innerHTML = state.files.map((f, i) => {
    const ext = f.name.split('.').pop().toUpperCase();
    return `<tr>
      <td class="sr-no">${String(i + 1).padStart(2, '0')}</td>
      <td><div class="file-chip">
        <div class="file-chip-icon">${ext}</div>
        <div><div class="file-chip-name">${f.name}</div><div class="file-chip-size">${formatSize(f.size)}</div></div>
      </div></td>
      <td style="font-size:.76rem;color:var(--muted);">${formatSize(f.size)}</td>
      <td style="text-align:right;"><button class="btn btn-danger-outline btn-sm" onclick="removeFile('${f.name}')">‚úï Remove</button></td>
    </tr>`;
  }).join('');
}

function formatSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

// ‚ïê‚ïê MRS FILE ‚ïê‚ïê
document.getElementById('mrsInput').addEventListener('change', function() {
  if (!this.files.length) return;
  const file = this.files[0];
  state.mrsFile = file;
  parseMRS(file);
  document.getElementById('mrsFileName').innerHTML = `<span class="mrs-file-name">‚úì ${file.name}</span>`;
  document.getElementById('mrsClearBtn').style.display = '';
  this.value = '';
});

function clearMRS() {
  state.mrsFile = null;
  state.mrsData = null;
  document.getElementById('mrsFileName').textContent = 'No file selected ‚Äî MRS columns will be hidden';
  document.getElementById('mrsClearBtn').style.display = 'none';
}

async function parseMRS(file) {
  const data = await readExcelFile(file, 8);
  // MRS: data from row 8 (index 7)
  // Col B (idx 1) = Make, Col C (idx 2) = Part Number, Col O (idx 14) = Qty
  const mrsMap = new Map();
  for (let i = 7; i < data.length; i++) {
    const row = data[i];
    const make = String(row[1] ?? '').trim();
    const rawPart = String(row[2] ?? '').trim();
    const rawQty = row[15]; // Column P = index 15
    if (!rawPart) continue;
    // Strip prefixes from MRS part number so it matches cleaned panel part numbers
    let part = rawPart;
    for (const p of state.prefixes) {
      const pt = p.trim();
      if (pt && part.startsWith(pt)) { part = part.slice(pt.length).trim(); break; }
    }
    let qty = typeof rawQty === 'number' ? rawQty : parseFloat(String(rawQty ?? '').replace(/,/g, ''));
    if (isNaN(qty)) qty = 0;
    const key = part.toLowerCase();
    mrsMap.set(key, (mrsMap.get(key) || 0) + qty);
  }
  state.mrsData = mrsMap;
}

// ‚ïê‚ïê PREFIX/SUFFIX IMPORT ‚ïê‚ïê
function importPrefixSuffix(input) {
  if (!input.files.length) return;
  const file = input.files[0];
  const reader = new FileReader();
  reader.onload = e => {
    try {
      const wb = XLSX.read(e.target.result, { type: 'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: true });
      let addedP = 0, addedS = 0;
      // Row 1 = headers, data from row 2 (index 1)
      for (let i = 1; i < data.length; i++) {
        const row = data[i];
        const prefix = String(row[0] ?? '').trim();   // Col A
        const suffix = String(row[2] ?? '').trim();   // Col C
        if (prefix && !state.prefixes.includes(prefix)) { state.prefixes.push(prefix); addedP++; }
        if (suffix && !state.suffixes.includes(suffix)) { state.suffixes.push(suffix); addedS++; }
      }
      renderTags();
      alert(`‚úÖ Imported ${addedP} prefix(es) and ${addedS} suffix(es) successfully!`);
    } catch (err) {
      alert('Error reading file: ' + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
  input.value = '';
}

// ‚ïê‚ïê TAGS ‚ïê‚ïê
function addTag(type, e) {
  if (e.key !== 'Enter') return;
  const input = document.getElementById(type + 'Input');
  const val = input.value.trim().replace(/[\u200B-\u200D\uFEFF]/g, ''); // strip zero-width chars
  if (!val) return;
  if (type === 'prefix') { if (!state.prefixes.includes(val)) state.prefixes.push(val); }
  else { if (!state.suffixes.includes(val)) state.suffixes.push(val); }
  input.value = '';
  renderTags();
}

function removeTag(type, val) {
  if (type === 'prefix') state.prefixes = state.prefixes.filter(v => v !== val);
  else state.suffixes = state.suffixes.filter(v => v !== val);
  renderTags();
}

function renderTags() {
  ['prefix', 'suffix'].forEach(type => {
    const wrap = document.getElementById(type + 'Wrap');
    const input = wrap.querySelector('input');
    const arr = type === 'prefix' ? state.prefixes : state.suffixes;
    wrap.querySelectorAll('.tag').forEach(t => t.remove());
    arr.forEach(v => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.innerHTML = `${v} <span class="tag-x" onclick="removeTag('${type}','${v}')">√ó</span>`;
      wrap.insertBefore(tag, input);
    });
  });
}

function addFRRow() {
  const id = Date.now();
  state.findReplace.push({ id, find: '', replace: '' });
  renderFRRows();
}

function renderFRRows() {
  const c = document.getElementById('frRows');
  c.innerHTML = state.findReplace.map(fr => `
    <div class="find-replace-row" style="margin-bottom:7px;">
      <input class="field-input" placeholder="Find‚Ä¶" value="${fr.find}" oninput="updateFR(${fr.id},'find',this.value)">
      <span>‚Üí</span>
      <div style="display:flex;gap:5px;">
        <input class="field-input" placeholder="Replace with‚Ä¶" value="${fr.replace}" oninput="updateFR(${fr.id},'replace',this.value)" style="flex:1;">
        <button class="btn btn-sm" style="background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger-border);" onclick="removeFR(${fr.id})">‚úï</button>
      </div>
    </div>`).join('');
}

function updateFR(id, key, val) { const fr = state.findReplace.find(f => f.id === id); if (fr) fr[key] = val; }
function removeFR(id) { state.findReplace = state.findReplace.filter(f => f.id !== id); renderFRRows(); }

// ‚ïê‚ïê CORE FILE READER ‚ïê‚ïê
function readExcelFile(file, startRowHint) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        // Try all sheets, pick the one with most data rows from startRow onwards
        const sr = (startRowHint || 9) - 1;
        let bestData = [];
        let bestCount = 0;
        for (const name of wb.SheetNames) {
          const ws = wb.Sheets[name];
          const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: true });
          // Count rows from startRow that have content in cols B,C,D (idx 1,2,3)
          let count = 0;
          for (let i = sr; i < data.length; i++) {
            const row = data[i];
            if (row[1] || row[2] || row[3]) count++;
          }
          if (count > bestCount) { bestCount = count; bestData = data; }
        }
        resolve(bestData);
      } catch (err) { console.error(err); resolve([]); }
    };
    reader.readAsArrayBuffer(file);
  });
}

// ‚ïê‚ïê CLEAN PART NUMBER ‚ïê‚ïê
function colLetter(l) { return l.toUpperCase().charCodeAt(0) - 65; }

function cleanPartNumber(val) {
  let s = String(val ?? '').trim();
  // Remove matching prefix ‚Äî trim each stored prefix to remove invisible chars
  for (const p of state.prefixes) {
    const pt = p.trim();
    if (pt && s.startsWith(pt)) { s = s.slice(pt.length).trim(); break; }
  }
  // Remove matching suffix
  for (const sf of state.suffixes) {
    const st = sf.trim();
    if (st && s.endsWith(st)) { s = s.slice(0, s.length - st.length).trim(); break; }
  }
  for (const fr of state.findReplace) if (fr.find) s = s.split(fr.find).join(fr.replace);
  if (document.getElementById('togTrim').checked) s = s.trim();
  if (document.getElementById('togSpecial').checked) s = s.replace(/[^a-zA-Z0-9\s\-\.]/g, '');
  if (document.getElementById('togUpper').checked) s = s.toUpperCase();
  else if (document.getElementById('togProper').checked) s = s.replace(/\w\S*/g, t => t.charAt(0).toUpperCase() + t.slice(1).toLowerCase());
  return s.trim();
}

// ‚ïê‚ïê MERGE ENGINE ‚ïê‚ïê
async function runMerge() {
  document.getElementById('s2Info').textContent = 'Processing‚Ä¶';

  const colMake  = colLetter(document.getElementById('colMake').value  || 'B');
  const colPart  = colLetter(document.getElementById('colPart').value  || 'C');
  const colName  = colLetter(document.getElementById('colName').value  || 'D');
  const colQty   = colLetter(document.getElementById('colQty').value   || 'P');
  const startRow = Math.max(1, parseInt(document.getElementById('startRow').value) || 9);

  state.merged = []; state.errors = []; state.warnings = [];
  // mergeMap: key -> { make, partNum, names, totalQty, fileQtys:{filename:qty}, status, mismatch }
  const mergeMap = new Map();

  for (const fileObj of state.files) {
    const rows = await readExcelFile(fileObj.file, startRow);
    const cleanFileName = fileObj.name.replace(/\.[^/.]+$/, ''); // strip extension

    for (let i = startRow - 1; i < rows.length; i++) {
      const row = rows[i];
      const rawPart  = String(row[colPart]  ?? '').trim();
      const make     = String(row[colMake]  ?? '').trim();
      const partName = String(row[colName]  ?? '').trim();
      const rawQty   = row[colQty];

      // Only skip if Part Number is truly blank
      if (!rawPart) {
        if (make || partName || (rawQty !== '' && rawQty !== null && rawQty !== undefined))
          state.errors.push({ file: fileObj.name, rowNum: i + 1, make, partNum: '', partName, qty: rawQty, reason: 'Blank Part Number' });
        continue;
      }

      // Parse qty ‚Äî never skip for non-numeric
      let qty = 0;
      if (typeof rawQty === 'number') {
        qty = rawQty;
      } else if (rawQty !== '' && rawQty !== null && rawQty !== undefined) {
        const parsed = parseFloat(String(rawQty).replace(/,/g, ''));
        qty = isNaN(parsed) ? 0 : parsed;
      }
      if (qty < 0) {
        state.warnings.push(`Row ${i + 1} in ${fileObj.name}: negative qty (${qty}) for part ${rawPart} ‚Äî included as 0`);
        qty = 0;
      }

      const cleaned = cleanPartNumber(rawPart);
      const key = (make + '||' + cleaned).toLowerCase();

      if (mergeMap.has(key)) {
        const ex = mergeMap.get(key);
        ex.totalQty += qty;
        ex.fileQtys[cleanFileName] = (ex.fileQtys[cleanFileName] || 0) + qty;
        ex.names[partName] = (ex.names[partName] || 0) + 1;
        ex.status = 'updated';
      } else {
        const names = {}; names[partName] = 1;
        const fileQtys = {}; fileQtys[cleanFileName] = qty;
        mergeMap.set(key, { make, partNum: cleaned, names, totalQty: qty, fileQtys, status: 'new', mismatch: false });
      }
    }
  }

  // Resolve names + mismatch
  for (const [, entry] of mergeMap) {
    const ne = Object.entries(entry.names);
    ne.sort((a, b) => b[1] - a[1]);
    entry.resolvedName = ne[0][0];
    if (ne.length > 1) { entry.mismatch = true; entry.status = 'mismatch'; }
    state.merged.push(entry);
  }

  // Warnings
  const bc = state.errors.filter(e => e.reason === 'Blank Part Number').length;
  if (bc) state.warnings.push(`${bc} row(s) skipped ‚Äî blank Part Number`);

  document.getElementById('s2Info').textContent = '';
  state.currentFilter = 'all';
  renderPreview();
  goTo(3);
}

// ‚ïê‚ïê FILTER & PREVIEW ‚ïê‚ïê
function setFilter(filter) {
  state.currentFilter = filter;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelector(`.filter-btn.filter-${filter}`).classList.add('active');
  renderPreviewTable();
}

function renderPreview() {
  const counts = { new: 0, updated: 0, mismatch: 0 };
  state.merged.forEach(r => {
    if (r.status === 'new') counts.new++;
    else if (r.status === 'updated') counts.updated++;
    else if (r.status === 'mismatch') counts.mismatch++;
  });

  document.getElementById('countAll').textContent     = state.merged.length;
  document.getElementById('countNew').textContent     = counts.new;
  document.getElementById('countUpdated').textContent = counts.updated;
  document.getElementById('countMismatch').textContent= counts.mismatch;
  document.getElementById('countSkipped').textContent = state.errors.length;

  const wp = document.getElementById('warnPanel');
  if (state.warnings.length) {
    wp.style.display = '';
    document.getElementById('warnList').innerHTML = state.warnings.map(w => `<li>‚ö† ${w}</li>`).join('');
  } else wp.style.display = 'none';

  renderPreviewTable();
}

function renderPreviewTable() {
  const tbody = document.getElementById('previewTable');
  const filter = state.currentFilter;

  let rows;
  if (filter === 'skipped') {
    // Show skipped/error rows
    if (!state.errors.length) {
      tbody.innerHTML = `<tr><td colspan="6"><div class="empty-table">No skipped rows.</div></td></tr>`;
      return;
    }
    tbody.innerHTML = state.errors.map((r, i) => `
      <tr>
        <td class="sr-no">${String(i + 1).padStart(2, '0')}</td>
        <td style="font-size:.78rem;">${r.make}</td>
        <td style="font-family:'IBM Plex Mono',monospace;font-size:.75rem;">${r.partNum || '<span style="color:var(--muted)">‚Äî</span>'}</td>
        <td style="font-size:.78rem;">${r.partName}</td>
        <td style="font-size:.78rem;">${r.qty}</td>
        <td><span class="status-pill pill-skipped">‚ö†Ô∏è ${r.reason}</span></td>
      </tr>`).join('');
    return;
  }

  rows = filter === 'all' ? state.merged : state.merged.filter(r => r.status === filter);

  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="6"><div class="empty-table">No rows for this filter.</div></td></tr>`;
    return;
  }

  const pills = {
    new:      `<span class="status-pill pill-new">üü¢ New</span>`,
    updated:  `<span class="status-pill pill-updated">üü° Updated</span>`,
    mismatch: `<span class="status-pill pill-mismatch">üî¥ Mismatch</span>`
  };

  tbody.innerHTML = rows.map((r, i) => `
    <tr class="${r.mismatch ? 'row-mismatch' : ''}">
      <td class="sr-no">${String(i + 1).padStart(2, '0')}</td>
      <td style="font-size:.78rem;">${r.make}</td>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:.75rem;">${r.partNum}</td>
      <td style="font-size:.78rem;">${r.resolvedName}</td>
      <td style="font-family:'IBM Plex Mono',monospace;font-size:.78rem;font-weight:600;">${r.totalQty}</td>
      <td>${pills[r.status] || ''}</td>
    </tr>`).join('');
}

// ‚ïê‚ïê EXPORT ‚ïê‚ïê
function todayStr() { return new Date().toISOString().slice(0, 10); }

function setExportNames() {
  const d = todayStr();
  document.getElementById('exportFileName').textContent = `Workezz_Merged_${d}.xlsx`;
  document.getElementById('errorFileName').textContent  = `Workezz_Error_Report_${d}.xlsx`;
  document.getElementById('errorBtn').disabled = state.errors.length === 0;
  // Show MRS cols info
  const mrsEl = document.getElementById('exportMrsCols');
  if (state.mrsData) mrsEl.textContent = ' ¬∑ MRS Qty ¬∑ Qty to Order';
  else mrsEl.textContent = '';
}

function exportMerged() {
  const fileNames = state.files.map(f => f.name.replace(/\.[^/.]+$/, '')); // strip extensions

  // Build header
  const header = ['SR', 'Make', 'Part Number', 'Part Description', ...fileNames, 'Total Qty'];
  if (state.mrsData) { header.push('MRS Qty'); header.push('Qty to Order'); }

  const data = [header];

  state.merged.forEach((r, i) => {
    const row = [i + 1, r.make, r.partNum, r.resolvedName];

    // Per-file qtys
    fileNames.forEach(fn => row.push(r.fileQtys[fn] || 0));

    // Total
    row.push(r.totalQty);

    // MRS
    if (state.mrsData) {
      // Try cleaned part number first, then also try with each prefix prepended
      // because MRS stores raw part numbers (no prefix stripped)
      let mrsQty = state.mrsData.get(r.partNum.toLowerCase()) || 0;
      if (!mrsQty) {
        // Try matching MRS raw part (with prefix) against cleaned panel part
        for (const [mrsKey, mrsVal] of state.mrsData) {
          const mrsRaw = mrsKey; // already lowercased
          // strip any known prefix from mrsRaw and compare
          let stripped = mrsRaw;
          for (const p of state.prefixes) {
            const pt = p.trim().toLowerCase();
            if (pt && stripped.startsWith(pt)) { stripped = stripped.slice(pt.length).trim(); break; }
          }
          if (stripped === r.partNum.toLowerCase()) { mrsQty = mrsVal; break; }
        }
      }
      const toOrder = r.totalQty - mrsQty;
      row.push(mrsQty);
      row.push(toOrder);
    }

    data.push(row);
  });

  const ws = XLSX.utils.aoa_to_sheet(data);

  // Column widths
  const cols = [
    { wch: 5 }, { wch: 20 }, { wch: 28 }, { wch: 42 },
    ...fileNames.map(() => ({ wch: 14 })),
    { wch: 12 }
  ];
  if (state.mrsData) { cols.push({ wch: 12 }); cols.push({ wch: 14 }); }
  ws['!cols'] = cols;

  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Master Sheet');
  XLSX.writeFile(wb, `Workezz_Merged_${todayStr()}.xlsx`);
}

function exportErrors() {
  const data = [['File Name', 'Row Number', 'Make', 'Part Number', 'Part Description', 'Quantity', 'Error Reason']];
  state.errors.forEach(e => data.push([e.file, e.rowNum, e.make, e.partNum, e.partName, e.qty, e.reason]));
  const ws = XLSX.utils.aoa_to_sheet(data);
  ws['!cols'] = [{ wch: 25 }, { wch: 12 }, { wch: 20 }, { wch: 25 }, { wch: 40 }, { wch: 10 }, { wch: 30 }];
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, 'Error Report');
  XLSX.writeFile(wb, `Workezz_Error_Report_${todayStr()}.xlsx`);
}

function resetApp() {
  state.files = []; state.prefixes = []; state.suffixes = [];
  state.findReplace = []; state.merged = []; state.errors = []; state.warnings = [];
  state.mrsFile = null; state.mrsData = null; state.currentFilter = 'all';
  renderFileTable(); renderTags(); renderFRRows();
  clearMRS();
  goTo(1);
}

// ‚îÄ‚îÄ DARK MODE TOGGLE ‚îÄ‚îÄ
function toggleDark() {
  const isDark = document.body.classList.toggle('dark');
  document.getElementById('darkIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  localStorage.setItem('wz-dark', isDark ? '1' : '0');
}
// Restore preference
(function(){
  try { if(localStorage.getItem('wz-dark')==='1'){document.body.classList.add('dark');document.getElementById('darkIcon').textContent='‚òÄÔ∏è';document.getElementById('darkLabel').textContent='Light Mode';} } catch(e){}
})();

// Init
renderFRRows();
</script>
  <!-- Footer -->
  <footer style="background:var(--white);border-top:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 -1px 4px rgba(30,34,53,.05);">
    <div style="display:flex;align-items:center;gap:8px;">
      <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="8" fill="#2563eb"/>
        <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="16" cy="13" r="1.5" fill="white"/>
      </svg>
      <span style="font-size:.72rem;font-weight:700;font-family:'Syne',sans-serif;color:var(--text);">Workezz</span>
      <span style="font-size:.68rem;color:var(--muted);">‚Äî Sheet Merger & Cleaner</span>
    </div>
    <div style="font-size:.68rem;color:var(--muted);">
      Designed & built by <strong style="color:var(--text2);">Krish Makwane</strong> &nbsp;¬∑&nbsp; MVP v2.0
    </div>
  </footer>
</body>
</html>
