<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workezz ‚Äî MRS Merger</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#eef0f5;--white:#fff;--surface:#f7f8fb;--surface2:#eceef4;
  --border:#dde0ea;--border2:#c8ccda;
  --accent:#2563eb;--accent-light:#dbeafe;--accent-hover:#1d4ed8;
  --text:#1e2235;--text2:#4a5072;--muted:#8890aa;
  --success:#15803d;--success-bg:#dcfce7;--success-border:#86efac;
  --danger:#b91c1c;--danger-bg:#fee2e2;--danger-border:#fca5a5;
  --warning:#92400e;--warning-bg:#fef3c7;--warning-border:#fcd34d;
  --green:#10b981;--green-light:#d1fae5;--green-border:#6ee7b7;
  --shadow:0 1px 3px rgba(30,34,53,.07),0 1px 2px rgba(30,34,53,.05);
  --shadow-md:0 4px 16px rgba(30,34,53,.09);
  --radius:10px;--radius-sm:6px;
}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-md);flex-shrink:0;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;letter-spacing:-.02em;color:var(--text);}
.logo span{color:var(--accent);}
.logo-sub{font-size:.62rem;color:var(--muted);font-weight:500;letter-spacing:.04em;margin-top:-2px;}
.version-badge{font-size:.65rem;background:var(--green-light);color:var(--green);padding:3px 10px;border-radius:100px;font-weight:600;border:1px solid var(--green-border);}
.home-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--radius-sm);font-size:.78rem;font-weight:600;color:var(--text2);background:var(--surface2);border:1px solid var(--border2);cursor:pointer;text-decoration:none;transition:all .15s;}
.home-btn:hover{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}

/* ‚îÄ‚îÄ MAIN LAYOUT ‚îÄ‚îÄ */
.main{display:grid;grid-template-columns:340px 1fr;flex:1;overflow:hidden;}
.left{background:var(--white);border-right:1px solid var(--border);padding:24px 20px;display:flex;flex-direction:column;gap:22px;overflow-y:auto;}
.right{padding:24px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;}

/* ‚îÄ‚îÄ SECTION LABELS ‚îÄ‚îÄ */
.section-label{font-size:.68rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}

/* ‚îÄ‚îÄ DROP ZONE ‚îÄ‚îÄ */
.drop-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:28px 16px;text-align:center;cursor:pointer;transition:all .2s;position:relative;background:var(--surface);}
.drop-zone:hover,.drop-zone.dragover{border-color:var(--accent);background:var(--accent-light);}
.drop-zone input[type=file]{position:absolute;inset:0;opacity:0;cursor:pointer;width:100%;height:100%;}
.dz-icon{font-size:1.8rem;margin-bottom:6px;display:block;}
.dz-text{font-size:.78rem;color:var(--text2);line-height:1.5;}
.dz-text strong{color:var(--accent);}
.dz-sub{font-size:.67rem;color:var(--muted);margin-top:3px;}

/* Master file display */
.master-file-display{background:var(--green-light);border:1px solid var(--green-border);border-radius:var(--radius-sm);padding:10px 14px;display:flex;align-items:center;justify-content:space-between;gap:10px;}
.master-file-name{font-size:.78rem;font-weight:600;color:var(--success);font-family:'IBM Plex Mono',monospace;}
.master-badge{font-size:.6rem;font-weight:700;background:var(--success);color:#fff;padding:2px 7px;border-radius:100px;letter-spacing:.04em;text-transform:uppercase;white-space:nowrap;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 1px 3px rgba(37,99,235,.3);}
.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;box-shadow:none;}
.btn-danger-outline{background:transparent;color:var(--danger);border:1px solid var(--danger-border);}
.btn-danger-outline:hover{background:var(--danger-bg);}
.btn-success{background:var(--success);color:#fff;}
.btn-success:hover{background:#166534;transform:translateY(-1px);}
.btn-success:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;}
.btn-secondary{background:var(--white);color:var(--text2);border:1px solid var(--border2);}
.btn-secondary:hover{background:var(--surface2);}
.btn-full{width:100%;}
.btn-lg{padding:11px 22px;font-size:.9rem;}
.btn-sm{padding:4px 10px;font-size:.72rem;}

/* ‚îÄ‚îÄ FILE TABLE ‚îÄ‚îÄ */
.file-table-wrap{border-radius:var(--radius);border:1px solid var(--border);background:var(--white);box-shadow:var(--shadow);overflow:hidden;}
table{width:100%;border-collapse:collapse;}
thead th{background:var(--surface2);padding:9px 14px;text-align:left;font-size:.66rem;font-weight:700;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);}
tbody td{padding:11px 14px;font-size:.8rem;border-bottom:1px solid var(--border);vertical-align:middle;}
tbody tr:last-child td{border-bottom:none;}
tbody tr:hover{background:var(--surface);}
.sr-no{font-family:'IBM Plex Mono',monospace;font-size:.72rem;color:var(--muted);width:40px;}
.file-chip{display:flex;align-items:center;gap:10px;}
.file-chip-icon{background:var(--success-bg);color:var(--success);border:1px solid var(--success-border);border-radius:5px;font-size:.6rem;font-weight:700;padding:3px 6px;letter-spacing:.04em;flex-shrink:0;}
.file-chip-name{font-size:.8rem;font-weight:500;color:var(--text);}
.file-chip-size{font-size:.68rem;color:var(--muted);}
.empty-table{text-align:center;padding:40px 20px;color:var(--muted);font-size:.82rem;}

/* ‚îÄ‚îÄ INFO CARD ‚îÄ‚îÄ */
.info-card{background:var(--accent-light);border:1px solid #bfdbfe;border-radius:var(--radius-sm);padding:12px 16px;font-size:.76rem;color:#1e40af;line-height:1.6;}
.info-card strong{font-weight:600;}

/* ‚îÄ‚îÄ STATUS LOG ‚îÄ‚îÄ */
.status-log{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;font-size:.76rem;color:var(--text2);line-height:1.8;min-height:80px;box-shadow:var(--shadow);}
.status-log .log-item{display:flex;align-items:flex-start;gap:8px;}
.log-new{color:var(--success);}
.log-added{color:var(--accent);}
.log-inserted{color:#7c3aed;}
.log-muted{color:var(--muted);}

/* ‚îÄ‚îÄ FOOTER ‚îÄ‚îÄ */
footer{background:var(--white);border-top:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 -1px 4px rgba(30,34,53,.05);}

/* ‚îÄ‚îÄ RESULT CARD ‚îÄ‚îÄ */
.result-card{background:var(--white);border:1px solid var(--success-border);border-radius:var(--radius);padding:20px 24px;box-shadow:var(--shadow-md);display:flex;align-items:center;justify-content:space-between;gap:20px;}
.result-card h4{font-family:'Syne',sans-serif;font-size:.95rem;font-weight:700;color:var(--text);margin-bottom:4px;}
.result-card p{font-size:.76rem;color:var(--muted);}


/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
body.dark {
  --bg:#13151f;--white:#1e2235;--surface:#252840;--surface2:#2d3148;
  --border:#363b58;--border2:#444968;--accent:#4f8eff;--accent-light:#1e2d4a;
  --accent-hover:#6aa3ff;--text:#e8eaf2;--text2:#9ba3c0;--muted:#6b7494;
  --success:#22c55e;--success-bg:#0f2d1a;--success-border:#166334;
  --warning:#fbbf24;--warning-bg:#2d2008;--warning-border:#854d0e;
  --danger:#f87171;--danger-bg:#2d0f0f;--danger-border:#991b1b;
  --green:#22c55e;--green-light:#0f2d1a;--green-border:#166334;
  --shadow:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 16px rgba(0,0,0,.4);
}
body.dark header{background:#1a1d2e;border-color:#2a2e45;}
body.dark .left{background:#1a1d2e;border-color:#2a2e45;}
body.dark .drop-zone{background:var(--surface);border-color:var(--border2);}
body.dark tbody tr:hover{background:var(--surface);}
body.dark thead th{background:var(--surface2);}
.dark-toggle{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:5px 12px;cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text2);transition:all .2s;font-family:'IBM Plex Sans',sans-serif;}
.dark-toggle:hover{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}
.dark-toggle-icon{font-size:.9rem;transition:transform .3s;}
body.dark .dark-toggle-icon{transform:rotate(180deg);}

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <div>
      <div class="logo">Work<span>ezz</span></div>
      <div class="logo-sub">MRS Merger</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="dark-toggle" onclick="toggleDark()">
      <span class="dark-toggle-icon" id="darkIcon">üåô</span>
      <span id="darkLabel">Dark Mode</span>
    </button>
    <a class="home-btn" href="index.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
  </div>
</header>

<!-- MAIN -->
<div class="main">

  <!-- LEFT PANEL -->
  <div class="left">

    <!-- Single Uploader -->
    <div>
      <div class="section-label">Upload Files</div>
      <input type="file" id="fileInput" accept=".xls,.xlsx" multiple style="display:none;">
      <div id="dropZone" class="drop-zone" onclick="document.getElementById('fileInput').click()">
        <span class="dz-icon">üìÇ</span>
        <div class="dz-text"><strong>Click to browse</strong> or drag & drop</div>
        <div class="dz-sub">First file = Master ¬∑ Supports .xls and .xlsx</div>
      </div>
      <div style="margin-top:10px;">
        <button class="btn btn-primary btn-full" onclick="addStagedFiles()">Ôºã Add Files to List</button>
      </div>
    </div>

    <!-- Merge Button -->
    <div style="margin-top:auto;">
      <button class="btn btn-success btn-full btn-lg" id="mergeBtn" onclick="runMRSMerge()" disabled>
        üîÄ Merge & Download
      </button>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div class="right" style="display:flex;flex-direction:column;">

    <div class="info-card">
      <strong>How it works:</strong><br>
      The first file is your <strong>Master</strong>. For each subsequent file:<br>
      ‚Ä¢ Part not in Master ‚Üí <span style="color:var(--success);font-weight:600;">added to bottom</span><br>
      ‚Ä¢ Part exists + same Section ‚Üí <span style="color:var(--accent);font-weight:600;">quantity added</span><br>
      ‚Ä¢ Part exists + different Section ‚Üí <span style="color:#7c3aed;font-weight:600;">row inserted below match</span>
    </div>

    <!-- Files to merge table -->
    <div class="file-table-wrap" style="flex:1;min-height:0;display:flex;flex-direction:column;overflow:hidden;">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>File Name</th>
            <th>Size</th>
            <th style="text-align:right;">Action</th>
          </tr>
        </thead>
        </table>
        <div style="overflow-y:auto;flex:1;">
        <table style="width:100%">
        <tbody id="mergeFileTable">
          <tr><td colspan="4"><div class="empty-table">üìã No files added yet ‚Äî upload files to merge above.</div></td></tr>
        </tbody>
      </table>
      </div>
    </div>

    <!-- Status log -->
    <div id="statusLog" class="status-log">
      <span class="log-muted">Waiting for files‚Ä¶</span>
    </div>

  </div>
</div>

<!-- FOOTER -->
<footer>
  <div style="display:flex;align-items:center;gap:8px;">
    <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <span style="font-size:.72rem;font-weight:700;font-family:'Syne',sans-serif;">Workezz</span>
    <span style="font-size:.68rem;color:var(--muted);">‚Äî MRS Merger</span>
  </div>
  <div style="font-size:.68rem;color:var(--muted);">
    Designed & built by <strong style="color:var(--text2);">Krish Makwane</strong> &nbsp;¬∑&nbsp; MVP v2.0
  </div>
</footer>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let allFiles = [];    // confirmed list
let stagedFiles = []; // staging buffer (selected but not yet added)

function formatSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

function todayStr() { return new Date().toISOString().slice(0, 10); }

// ‚îÄ‚îÄ FILE INPUT HANDLER ‚Äî stages files, does NOT add to list yet ‚îÄ‚îÄ
document.getElementById('fileInput').addEventListener('change', function() {
  for (const file of this.files) {
    if (allFiles.find(f => f.name === file.name)) continue;
    if (stagedFiles.find(f => f.name === file.name)) continue;
    stagedFiles.push(file);
  }
  this.value = '';
  updateDropZone();
});

function updateDropZone() {
  const dz = document.getElementById('dropZone');
  if (stagedFiles.length) {
    dz.querySelector('.dz-text').innerHTML = `<strong>${stagedFiles.length} file(s) selected</strong> ‚Äî click "Add Files to List"`;
    dz.querySelector('.dz-sub').textContent = 'Click Add Files to List to confirm';
  } else {
    dz.querySelector('.dz-text').innerHTML = '<strong>Click to browse</strong> or drag & drop';
    dz.querySelector('.dz-sub').textContent = 'First file = Master ¬∑ Supports .xls and .xlsx';
  }
}

// ‚îÄ‚îÄ ADD STAGED FILES TO LIST ‚îÄ‚îÄ
function addStagedFiles() {
  if (!stagedFiles.length) { alert('Please select files first.'); return; }
  for (const file of stagedFiles) {
    if (!allFiles.find(f => f.name === file.name)) allFiles.push(file);
  }
  stagedFiles = [];
  updateDropZone();
  renderMergeTable();
  checkReady();
}

// Drag & drop ‚Äî also stages
const dz = document.getElementById('dropZone');
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragover'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragover'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('dragover');
  for (const file of e.dataTransfer.files) {
    if (allFiles.find(f => f.name === file.name)) continue;
    if (stagedFiles.find(f => f.name === file.name)) continue;
    stagedFiles.push(file);
  }
  updateDropZone();
});

function removeFile(name) {
  allFiles = allFiles.filter(f => f.name !== name);
  renderMergeTable();
  checkReady();
}

function renderMergeTable() {
  const tbody = document.getElementById('mergeFileTable');
  if (!allFiles.length) {
    tbody.innerHTML = `<tr><td colspan="4"><div class="empty-table">üìã No files added yet ‚Äî first file will be treated as Master.</div></td></tr>`;
    return;
  }
  tbody.innerHTML = allFiles.map((f, i) => {
    const ext = f.name.split('.').pop().toUpperCase();
    const badge = i === 0 ? `<span style="font-size:.6rem;font-weight:700;background:var(--success-bg);color:var(--success);border:1px solid var(--success-border);padding:2px 7px;border-radius:100px;margin-left:6px;">MASTER</span>` : '';
    return `<tr>
      <td class="sr-no">${String(i + 1).padStart(2, '0')}</td>
      <td><div class="file-chip">
        <div class="file-chip-icon">${ext}</div>
        <div><div class="file-chip-name">${f.name}${badge}</div><div class="file-chip-size">${formatSize(f.size)}</div></div>
      </div></td>
      <td style="font-size:.76rem;color:var(--muted);">${formatSize(f.size)}</td>
      <td style="text-align:right;"><button class="btn btn-danger-outline btn-sm" onclick="removeFile('${f.name}')">‚úï Remove</button></td>
    </tr>`;
  }).join('');
}

function checkReady() {
  document.getElementById('mergeBtn').disabled = allFiles.length < 2;
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
function log(msg, type = '') {
  const el = document.getElementById('statusLog');
  const color = type === 'new' ? 'log-new' : type === 'added' ? 'log-added' : type === 'inserted' ? 'log-inserted' : 'log-muted';
  el.innerHTML += `<div class="log-item"><span class="${color}">‚ñ∏ ${msg}</span></div>`;
  el.scrollTop = el.scrollHeight;
}

function clearLog() {
  document.getElementById('statusLog').innerHTML = '';
}

// ‚îÄ‚îÄ READ EXCEL FILE ‚îÄ‚îÄ
function readExcelFile(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: true });
        resolve(data);
      } catch (err) { console.error(err); resolve([]); }
    };
    reader.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ MAIN MERGE LOGIC ‚îÄ‚îÄ
async function runMRSMerge() {
  clearLog();
  log('Starting merge‚Ä¶');
  document.getElementById('mergeBtn').disabled = true;

  // Read master (first file)
  const masterFile = allFiles[0];
  const mergeFiles = allFiles.slice(1);
  const masterData = await readExcelFile(masterFile);
  log(`Master loaded: <strong>${masterFile.name}</strong> ‚Äî ${masterData.length} rows`);

  // Col indices (0-based): C=2 (Part No), G=6 (Section), P=15 (Qty)
  const COL_PART = 2;
  const COL_SECT = 6;
  const COL_QTY  = 15;

  // Build working array (deep copy of master rows)
  // Each element: array of cell values
  let result = masterData.map(row => [...row]);

  // Build index: partNumber.toLowerCase() ‚Üí array of row indices in result
  function buildIndex(rows) {
    const idx = new Map();
    rows.forEach((row, i) => {
      const part = String(row[COL_PART] ?? '').trim().toLowerCase();
      if (part) {
        if (!idx.has(part)) idx.set(part, []);
        idx.get(part).push(i);
      }
    });
    return idx;
  }

  let stats = { added: 0, qtyAdded: 0, inserted: 0 };

  // Process each merge file
  for (const file of mergeFiles) {
    const fileData = await readExcelFile(file);

    for (let ri = 0; ri < fileData.length; ri++) {
      const row = fileData[ri];
      const partNum = String(row[COL_PART] ?? '').trim();
      if (!partNum) continue;

      const partKey = partNum.toLowerCase();
      const section = String(row[COL_SECT] ?? '').trim();
      const qty = typeof row[COL_QTY] === 'number' ? row[COL_QTY] : parseFloat(String(row[COL_QTY] ?? '').replace(/,/g, '')) || 0;

      // Rebuild index fresh each time (result array changes)
      const idx = buildIndex(result);

      if (!idx.has(partKey)) {
        // ‚îÄ‚îÄ NEW PART ‚Äî add to bottom ‚îÄ‚îÄ
        result.push([...row]);
        stats.added++;
      } else {
        const matchIndices = idx.get(partKey);
        let sectionMatch = -1;
        for (const mi of matchIndices) {
          const existingSect = String(result[mi][COL_SECT] ?? '').trim();
          if (existingSect.toLowerCase() === section.toLowerCase()) {
            sectionMatch = mi;
            break;
          }
        }

        if (sectionMatch >= 0) {
          // ‚îÄ‚îÄ SAME SECTION ‚Äî add qty ‚îÄ‚îÄ
          const existingQty = typeof result[sectionMatch][COL_QTY] === 'number'
            ? result[sectionMatch][COL_QTY]
            : parseFloat(String(result[sectionMatch][COL_QTY] ?? '').replace(/,/g, '')) || 0;
          result[sectionMatch][COL_QTY] = existingQty + qty;
          stats.qtyAdded++;
        } else {
          // ‚îÄ‚îÄ DIFFERENT SECTION ‚Äî insert below last match ‚îÄ‚îÄ
          const lastMatchIdx = matchIndices[matchIndices.length - 1];
          result.splice(lastMatchIdx + 1, 0, [...row]);
          stats.inserted++;
        }
      }
    }

  }

  log(`<strong>Merge complete!</strong> ‚Äî ${stats.added} new, ${stats.qtyAdded} qty updated, ${stats.inserted} inserted`);

  // ‚îÄ‚îÄ EXPORT with ExcelJS ‚îÄ‚îÄ
  await exportResult(result, masterFile);
  document.getElementById('mergeBtn').disabled = false;
}

async function exportResult(result, masterFile) {
  if (!result.length) return;
  log('Building output from Master file‚Ä¶');

  // Read master as ArrayBuffer to load into ExcelJS (preserves all formatting/colors)
  const masterBuffer = await masterFile.arrayBuffer();
  const wb = new ExcelJS.Workbook();
  await wb.xlsx.load(masterBuffer);
  const ws = wb.getWorksheet(1);

  // We have the modified result array ‚Äî apply changes to the workbook
  // Strategy: clear existing data rows, re-write from result array
  // But to preserve formatting, we copy styles from existing rows

  // Build a style template from first data row (row 8 = index 7 in result, row 8 in excel)
  const DATA_START_ROW = 8; // Excel 1-based
  const COL_QTY = 16; // P = col 16 (1-based in ExcelJS)
  const COL_PART = 3; // C = col 3
  const COL_SECT = 7; // G = col 7

  // Get current last row in worksheet
  const currentRowCount = ws.rowCount;

  // Build map of current excel rows: partNum+section -> excelRowNumber (1-based)
  const excelRowMap = new Map();
  for (let r = DATA_START_ROW; r <= currentRowCount; r++) {
    const row = ws.getRow(r);
    const part = String(row.getCell(COL_PART).value ?? '').trim().toLowerCase();
    const sect = String(row.getCell(COL_SECT).value ?? '').trim().toLowerCase();
    if (part) excelRowMap.set(part + '||' + sect, r);
  }

  // Apply qty updates for same-section matches (already computed in result)
  // For same-section rows, just update qty in existing excel row
  // For new/inserted rows, we need to add them

  // Rebuild from result array:
  // 1. Update qty for rows that exist in master
  // 2. Collect new/inserted rows to append

  const masterData = await (async () => {
    return new Promise(resolve => {
      const reader = new FileReader();
      reader.onload = e => {
        const wb2 = XLSX.read(e.target.result, { type: 'array' });
        const ws2 = wb2.Sheets[wb2.SheetNames[0]];
        resolve(XLSX.utils.sheet_to_json(ws2, { header: 1, defval: '', raw: true }));
      };
      reader.readAsArrayBuffer(masterFile);
    });
  })();

  const masterRowCount = masterData.length;

  // Find rows in result that are beyond master ‚Äî these are new/inserted rows
  // result has masterData rows (possibly qty-modified) + new rows appended + inserted rows
  // The simplest approach: update qty in excel for rows <= masterRowCount
  // Then append extra rows with copied style from nearest master row

  // Update existing rows qty
  for (let i = DATA_START_ROW - 1; i < masterRowCount && i < result.length; i++) {
    const resultRow = result[i];
    const excelRow = ws.getRow(i + 1);
    // Only update qty cell (col P = 16)
    const newQty = resultRow[15]; // index 15 = col P
    if (typeof newQty === 'number') {
      excelRow.getCell(COL_QTY).value = newQty;
      excelRow.commit();
    }
  }

  // Append new/inserted rows beyond master length
  if (result.length > masterRowCount) {
    // Get a template row style from last data row in master
    const templateRowNum = currentRowCount;
    const templateRow = ws.getRow(templateRowNum);

    for (let i = masterRowCount; i < result.length; i++) {
      const newRow = ws.addRow(result[i]);
      // Copy basic style from template row
      newRow.height = templateRow.height || 18;
      newRow.eachCell({ includeEmpty: true }, (cell, colNum) => {
        try {
          const tmplCell = templateRow.getCell(colNum);
          if (tmplCell.style) cell.style = JSON.parse(JSON.stringify(tmplCell.style));
        } catch(e) {}
      });
      newRow.commit();
    }
  }

  // Download
  const buffer = await wb.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  saveAs(blob, `MRS_Merged_${todayStr()}.xlsx`);
  log(`‚úÖ Downloaded: MRS_Merged_${todayStr()}.xlsx`);
}

// ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ
function toggleDark() {
  const isDark = document.body.classList.toggle('dark');
  document.getElementById('darkIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  localStorage.setItem('wz-dark', isDark ? '1' : '0');
}
(function(){
  try { if(localStorage.getItem('wz-dark')==='1'){ document.body.classList.add('dark'); document.getElementById('darkIcon').textContent='‚òÄÔ∏è'; document.getElementById('darkLabel').textContent='Light Mode'; } } catch(e){}
})();
</script>

</body>
</html>
