<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/mrs_style.css">
<title>Workezz ‚Äî MRS Merger</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <div>
      <div class="logo">Work<span>ezz</span></div>
      <div class="logo-sub">MRS Merger</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="dark-toggle" onclick="toggleDark()">
      <span class="dark-toggle-icon" id="darkIcon">üåô</span>
      <span id="darkLabel">Dark Mode</span>
    </button>
    <a class="home-btn" href="index.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
  </div>
</header>

<div class="main">

  <!-- LEFT PANEL -->
  <div class="left">

    <!-- ‚ë† MASTER SHEET -->
    <div>
      <div class="section-label">‚ë† Master Sheet</div>
      <input type="file" id="masterInput" accept=".xls,.xlsx" style="display:none;" onchange="handleMasterFile(this)">
      <div id="masterEmptyZone" class="master-upload-zone" onclick="document.getElementById('masterInput').click()">
        <span class="muz-icon">üóÇÔ∏è</span>
        <div class="muz-text"><strong>Click to upload Master Sheet</strong></div>
        <div class="muz-sub">Blank template with formatting ‚Äî .xls or .xlsx</div>
      </div>
      <div id="masterFileChip" class="master-chip" style="display:none;">
        <div class="master-chip-icon" id="masterChipExt">XLS</div>
        <div class="master-chip-info">
          <div class="master-chip-name" id="masterChipName">‚Äî</div>
          <div class="master-chip-sub" id="masterChipSize">‚Äî</div>
        </div>
        <span class="master-badge">Master</span>
        <button class="btn btn-danger-outline btn-sm" onclick="clearMaster()">‚úï</button>
      </div>
    </div>

    <div class="divider"></div>

    <!-- ‚ë° FILES TO MERGE -->
    <div>
      <div class="section-label">‚ë° Files to Merge</div>
      <input type="file" id="mergeInput" accept=".xls,.xlsx" multiple style="display:none;">
      <div id="mergeDropZone" class="drop-zone" onclick="document.getElementById('mergeInput').click()">
        <span class="dz-icon">üìÇ</span>
        <div class="dz-text" id="mergeDzText"><strong>Click to browse</strong> or drag & drop</div>
        <div class="dz-sub" id="mergeDzSub">Select files to merge into master ‚Äî .xls or .xlsx</div>
      </div>
      <div style="margin-top:10px;">
        <button class="btn btn-primary btn-full" onclick="addStagedFiles()">Ôºã Add Files to List</button>
      </div>
    </div>

    <!-- MERGE BUTTON -->
    <div style="margin-top:auto;padding-top:8px;">
      <div style="margin-bottom:10px;">
        <label style="font-size:.68rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:6px;">Export File Name</label>
        <div style="display:flex;align-items:center;gap:0;border:1px solid var(--border2);border-radius:var(--radius-sm);overflow:hidden;background:var(--white);">
          <input 
            id="exportFileName" 
            type="text" 
            placeholder="MRS_Merged" 
            value="MRS_Merged"
            style="flex:1;border:none;outline:none;padding:8px 12px;font-family:'IBM Plex Sans',sans-serif;font-size:.82rem;color:var(--text);background:transparent;"
          >
          <span style="padding:8px 12px;font-size:.75rem;font-weight:600;color:var(--muted);background:var(--surface2);border-left:1px solid var(--border);white-space:nowrap;">.xlsx</span>
        </div>
      </div>
      <button class="btn btn-success btn-full btn-lg" id="mergeBtn" onclick="runMRSMerge()" disabled>
        üîÄ Merge & Download
      </button>
      <p style="font-size:.68rem;color:var(--muted);text-align:center;margin-top:8px;line-height:1.5;" id="mergeHint">Upload master + at least 1 file to merge</p>
    </div>

  </div>

  <!-- RIGHT PANEL -->
  <div class="right">

    <div class="info-card">
      <strong>How it works:</strong><br>
      For each merge file ‚Äî <strong>Sheet 1</strong> is pasted first, then <strong>Sheet 2</strong> is pasted right after.<br>
      Each file's data starts from where the previous file's data ended. Master formatting is preserved.
    </div>

    <div style="display:flex;align-items:center;justify-content:space-between;flex-shrink:0;">
      <div class="section-label" style="margin-bottom:0;">Files to Merge</div>
      <span id="mergeFileCount" style="font-size:.72rem;color:var(--muted);background:var(--surface2);padding:2px 10px;border-radius:100px;border:1px solid var(--border);">0 files</span>
    </div>

    <div class="file-table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th>File Name</th>
            <th>Size</th>
            <th style="text-align:right;">Action</th>
          </tr>
        </thead>
      </table>
      <div class="table-scroll">
        <table style="width:100%">
          <tbody id="mergeFileTable">
            <tr><td colspan="4"><div class="empty-table">üìã No files added yet.<br>Upload merge files above and click Add Files to List.</div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div id="statusLog" class="status-log">
      <span class="log-muted">Waiting to start‚Ä¶</span>
    </div>

  </div>
</div>

<footer>
  <div style="display:flex;align-items:center;gap:8px;">
    <svg width="16" height="16" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <span style="font-size:.72rem;font-weight:700;font-family:'Syne',sans-serif;">Workezz</span>
    <span style="font-size:.68rem;color:var(--muted);">‚Äî MRS Merger</span>
  </div>
  <div style="font-size:.68rem;color:var(--muted);">
    Designed & built by <strong style="color:var(--text2);">Krish Makwane</strong> &nbsp;¬∑&nbsp; MVP v2.0
  </div>
</footer>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let masterFile = null;
let mergeFiles = [];
let stagedFiles = [];

function formatSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}
function todayStr() { return new Date().toISOString().slice(0, 10); }

// ‚îÄ‚îÄ MASTER FILE ‚îÄ‚îÄ
function handleMasterFile(input) {
  if (!input.files.length) return;
  masterFile = input.files[0];
  input.value = '';
  const ext = masterFile.name.split('.').pop().toUpperCase();
  document.getElementById('masterEmptyZone').style.display = 'none';
  document.getElementById('masterFileChip').style.display = 'flex';
  document.getElementById('masterChipExt').textContent = ext;
  document.getElementById('masterChipName').textContent = masterFile.name;
  document.getElementById('masterChipSize').textContent = formatSize(masterFile.size);
  checkReady();
}

function clearMaster() {
  masterFile = null;
  document.getElementById('masterEmptyZone').style.display = '';
  document.getElementById('masterFileChip').style.display = 'none';
  document.getElementById('masterInput').value = '';
  checkReady();
}

// ‚îÄ‚îÄ MERGE FILES ‚îÄ‚îÄ
document.getElementById('mergeInput').addEventListener('change', function() {
  for (const file of this.files) {
    if (mergeFiles.find(f => f.name === file.name)) continue;
    if (stagedFiles.find(f => f.name === file.name)) continue;
    stagedFiles.push(file);
  }
  this.value = '';
  updateMergeDz();
});

const mdz = document.getElementById('mergeDropZone');
mdz.addEventListener('dragover', e => { e.preventDefault(); mdz.classList.add('dragover'); });
mdz.addEventListener('dragleave', () => mdz.classList.remove('dragover'));
mdz.addEventListener('drop', e => {
  e.preventDefault(); mdz.classList.remove('dragover');
  for (const file of e.dataTransfer.files) {
    if (!file.name.match(/\.(xls|xlsx)$/i)) continue;
    if (mergeFiles.find(f => f.name === file.name)) continue;
    if (stagedFiles.find(f => f.name === file.name)) continue;
    stagedFiles.push(file);
  }
  updateMergeDz();
});

function updateMergeDz() {
  const txt = document.getElementById('mergeDzText');
  const sub = document.getElementById('mergeDzSub');
  if (stagedFiles.length) {
    txt.innerHTML = `<strong>${stagedFiles.length} file(s) selected</strong>`;
    sub.textContent = 'Click "Add Files to List" to confirm';
  } else {
    txt.innerHTML = '<strong>Click to browse</strong> or drag & drop';
    sub.textContent = 'Select files to merge into master ‚Äî .xls or .xlsx';
  }
}

function addStagedFiles() {
  if (!stagedFiles.length) { alert('Please select files first.'); return; }
  for (const file of stagedFiles) {
    if (!mergeFiles.find(f => f.name === file.name)) mergeFiles.push(file);
  }
  stagedFiles = [];
  updateMergeDz();
  renderMergeTable();
  checkReady();
}

function removeFile(name) {
  mergeFiles = mergeFiles.filter(f => f.name !== name);
  renderMergeTable();
  checkReady();
}

// ‚îÄ‚îÄ DRAG AND DROP REORDER ‚îÄ‚îÄ
let mrsDragSrc = null;

function renderMergeTable() {
  const tbody = document.getElementById('mergeFileTable');
  const count = mergeFiles.length;
  document.getElementById('mergeFileCount').textContent = count + ' file' + (count !== 1 ? 's' : '');
  if (!count) {
    tbody.innerHTML = `<tr><td colspan="4"><div class="empty-table">üìã No files added yet.<br>Upload merge files above and click Add Files to List.</div></td></tr>`;
    return;
  }
  tbody.innerHTML = mergeFiles.map((f, i) => {
    const ext = f.name.split('.').pop().toUpperCase();
    return `<tr draggable="true" data-index="${i}"
        ondragstart="mrsDragStart(event,${i})"
        ondragover="mrsDragOver(event)"
        ondragenter="mrsDragEnter(event)"
        ondragleave="mrsDragLeave(event)"
        ondrop="mrsDrop(event,${i})"
        ondragend="mrsDragEnd(event)"
        style="cursor:grab;">
      <td class="sr-no" style="cursor:grab;">
        <span style="display:inline-flex;flex-direction:column;gap:1px;opacity:0.4;pointer-events:none;user-select:none;">
          <span style="display:block;width:14px;height:2px;background:currentColor;border-radius:1px;"></span>
          <span style="display:block;width:14px;height:2px;background:currentColor;border-radius:1px;"></span>
          <span style="display:block;width:14px;height:2px;background:currentColor;border-radius:1px;"></span>
        </span>
      </td>
      <td><div class="file-chip">
        <div class="file-chip-icon">${ext}</div>
        <div><div class="file-chip-name">${f.name}</div><div class="file-chip-size">${String(i + 1).padStart(2, '0')} ¬∑ ${formatSize(f.size)}</div></div>
      </div></td>
      <td style="font-size:.76rem;color:var(--muted);">${formatSize(f.size)}</td>
      <td style="text-align:right;"><button class="btn btn-danger-outline btn-sm" onclick="removeFile('${f.name}')">‚úï Remove</button></td>
    </tr>`;
  }).join('');
}

function mrsDragStart(e, i) {
  mrsDragSrc = i;
  e.dataTransfer.effectAllowed = 'move';
  e.currentTarget.style.opacity = '0.45';
}
function mrsDragOver(e) {
  e.preventDefault();
  e.dataTransfer.dropEffect = 'move';
}
function mrsDragEnter(e) {
  e.currentTarget.classList.add('drag-over');
}
function mrsDragLeave(e) {
  e.currentTarget.classList.remove('drag-over');
}
function mrsDrop(e, toIndex) {
  e.preventDefault();
  e.currentTarget.classList.remove('drag-over');
  if (mrsDragSrc === null || mrsDragSrc === toIndex) return;
  const moved = mergeFiles.splice(mrsDragSrc, 1)[0];
  mergeFiles.splice(toIndex, 0, moved);
  mrsDragSrc = null;
  renderMergeTable();
}
function mrsDragEnd(e) {
  e.currentTarget.style.opacity = '';
  document.querySelectorAll('#mergeFileTable tr').forEach(r => r.classList.remove('drag-over'));
}

function checkReady() {
  const ready = masterFile !== null && mergeFiles.length >= 1;
  document.getElementById('mergeBtn').disabled = !ready;
  const hint = document.getElementById('mergeHint');
  if (!masterFile) hint.textContent = 'Upload master sheet to continue';
  else if (!mergeFiles.length) hint.textContent = 'Add at least 1 file to merge';
  else hint.textContent = `Ready ‚Äî master + ${mergeFiles.length} file(s) queued`;
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
function log(msg, type = '') {
  const el = document.getElementById('statusLog');
  if (el.innerHTML.includes('Waiting')) el.innerHTML = '';
  const cls = {new:'log-new', inserted:'log-inserted', error:'log-error'}[type] || 'log-muted';
  el.innerHTML += `<div class="log-item"><span class="${cls}">‚ñ∏ ${msg}</span></div>`;
  el.scrollTop = el.scrollHeight;
}
function clearLog() { document.getElementById('statusLog').innerHTML = ''; }

// ‚îÄ‚îÄ READ BOTH SHEETS FROM A FILE AS RAW ARRAYS ‚îÄ‚îÄ
function readBothSheets(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        const sheet1 = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: '', raw: true });
        const sheet2 = wb.SheetNames.length >= 2
          ? XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[1]], { header: 1, defval: '', raw: true })
          : [];
        resolve({ sheet1, sheet2, names: wb.SheetNames });
      } catch(err) { console.error(err); resolve({ sheet1: [], sheet2: [], names: [] }); }
    };
    reader.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ FIND LAST NON-EMPTY ROW INDEX (0-based) ‚îÄ‚îÄ
function lastDataRow(rows) {
  for (let i = rows.length - 1; i >= 0; i--) {
    if (rows[i].some(v => v !== '' && v !== null && v !== undefined)) return i;
  }
  return -1;
}

// ‚îÄ‚îÄ MAIN MERGE ‚îÄ‚îÄ
async function runMRSMerge() {
  clearLog();
  document.getElementById('mergeBtn').disabled = true;

  log('Loading master file‚Ä¶');
  const masterSheets = await readBothSheets(masterFile);
  // Master result starts as Sheet 1 of master
  let result = masterSheets.sheet1.map(row => [...row]);
  log(`Master loaded ‚Äî ${result.length} rows in Sheet 1`, 'new');

  for (const file of mergeFiles) {
    log(`Processing: <strong>${file.name}</strong>`);
    const { sheet1, sheet2, names } = await readBothSheets(file);

    // Use Sheet 2 if it exists, otherwise Sheet 1
    const sourceSheet = sheet2.length ? sheet2 : sheet1;
    const sheetName = sheet2.length ? (names[1] || 'Sheet2') : (names[0] || 'Sheet1');

    // Skip first 8 rows (rows 1-8 are headers/info), data starts from row 9 (index 8)
    const dataRows = sourceSheet.slice(8).filter(row => row.some(v => v !== '' && v !== null && v !== undefined));

    // Find where current result ends and paste after
    const lastRow = lastDataRow(result);
    const insertFrom = lastRow + 1;

    for (let i = 0; i < dataRows.length; i++) {
      result[insertFrom + i] = [...dataRows[i]];
    }

    log(`‚úì ${file.name} ‚Äî ${sheetName}, ${dataRows.length} rows merged`, 'new');
  }

  log(`<strong>All files merged!</strong> Total rows: ${result.length}`, 'new');
  await exportResult(result);
  document.getElementById('mergeBtn').disabled = false;
}

// ‚îÄ‚îÄ EXPORT ‚Äî write into master ExcelJS workbook from row 8, NO style copying ‚îÄ‚îÄ
async function exportResult(result) {
  log('Writing output file‚Ä¶');
  try {
    const masterBuffer = await masterFile.arrayBuffer();
    const wb = new ExcelJS.Workbook();
    await wb.xlsx.load(masterBuffer);
    const ws = wb.getWorksheet(1);

    // Data rows start at index 7 (row 8 in Excel)
    // Write each result row into the worksheet directly ‚Äî values only, no style override
    const dataRows = result.slice(7); // skip first 7 rows (master header rows 1-7)

    for (let i = 0; i < dataRows.length; i++) {
      const excelRowNum = 8 + i; // row 8, 9, 10...
      const rowData = dataRows[i];
      const exRow = ws.getRow(excelRowNum);
      rowData.forEach((val, ci) => {
        exRow.getCell(ci + 1).value = (val === '' || val === null || val === undefined) ? null : val;
      });
      exRow.commit();
    }

    const buffer = await wb.xlsx.writeBuffer();
    const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
    const exportName = (document.getElementById('exportFileName').value.trim() || 'MRS_Merged').replace(/[^a-zA-Z0-9_\-. ]/g, '_');
    const finalName = `${exportName}_${todayStr()}.xlsx`;
    saveAs(blob, finalName);
    log(`‚úÖ Downloaded: ${finalName}`, 'new');
  } catch(err) {
    log('Export error: ' + err.message, 'error');
    console.error(err);
  }
}

// ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ
function toggleDark() {
  const isDark = document.body.classList.toggle('dark');
  document.getElementById('darkIcon').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  localStorage.setItem('wz-dark', isDark ? '1' : '0');
}
(function(){
  try {
    if (localStorage.getItem('wz-dark') === '1') {
      document.body.classList.add('dark');
      document.getElementById('darkIcon').textContent = '‚òÄÔ∏è';
      document.getElementById('darkLabel').textContent = 'Light Mode';
    }
  } catch(e) {}
})();
</script>