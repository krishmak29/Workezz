<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workezz ‚Äî MRS Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#f0f2f7;--white:#fff;--surface:#f7f8fb;--surface2:#eceef4;
  --border:#dde0ea;--border2:#c8ccda;
  --accent:#0f766e;--accent-l:#ccfbf1;--accent-h:#0d6760;
  --text:#1e2235;--text2:#4a5072;--muted:#8890aa;
  --orange:#ea580c;--orange-l:#fff7ed;--orange-b:#fed7aa;
  --teal:#14b8a6;--teal-l:#ccfbf1;--teal-b:#5eead4;
  --purple:#7c3aed;--purple-l:#f5f3ff;--purple-b:#c4b5fd;
  --success:#15803d;--danger:#b91c1c;--danger-bg:#fee2e2;--danger-b:#fca5a5;
  --sh:0 1px 3px rgba(30,34,53,.07);--sh-md:0 4px 16px rgba(30,34,53,.09);
  --r:10px;--rs:6px;
}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

header{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--sh-md);flex-shrink:0;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.25rem;letter-spacing:-.02em;}
.logo span{color:#2563eb;}
.logo-sub{font-size:.6rem;color:var(--muted);font-weight:500;letter-spacing:.06em;text-transform:uppercase;}
.home-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:var(--rs);font-size:.76rem;font-weight:600;color:var(--text2);background:var(--surface2);border:1px solid var(--border2);cursor:pointer;text-decoration:none;transition:all .15s;}
.home-btn:hover{background:var(--accent-l);color:var(--accent);border-color:var(--accent);}
.dtgl{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:4px 11px;cursor:pointer;font-size:.72rem;font-weight:600;color:var(--text2);transition:all .2s;font-family:'IBM Plex Sans',sans-serif;}
.dtgl:hover{background:var(--accent-l);color:var(--accent);border-color:var(--accent);}

.stepper{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;height:44px;display:flex;align-items:center;gap:6px;flex-shrink:0;}
.step{display:flex;align-items:center;gap:7px;padding:4px 12px;border-radius:100px;font-size:.72rem;font-weight:600;color:var(--muted);transition:all .2s;white-space:nowrap;}
.step.active{background:var(--accent-l);color:var(--accent);}
.step.done{color:var(--success);}
.step-num{width:18px;height:18px;border-radius:50%;background:var(--border2);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;}
.step.active .step-num{background:var(--accent);}
.step.done .step-num{background:var(--success);}
.sarr{color:var(--border2);}

.screen{display:none;flex:1;overflow:hidden;}
.screen.active{display:flex;flex-direction:column;}

.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:7px 14px;border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:var(--accent-h);transform:translateY(-1px);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;}
.btn-success{background:var(--success);color:#fff;}
.btn-success:hover{background:#166534;transform:translateY(-1px);}
.btn-success:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;}
.btn-secondary{background:var(--white);color:var(--text2);border:1px solid var(--border2);}
.btn-secondary:hover{background:var(--surface2);}
.btn-do{background:transparent;color:var(--danger);border:1px solid var(--danger-b);}
.btn-do:hover{background:var(--danger-bg);}
.btn-full{width:100%;}.btn-lg{padding:10px 20px;font-size:.88rem;}.btn-sm{padding:3px 9px;font-size:.7rem;}

/* SCREEN 1 */
.s1-body{display:grid;grid-template-columns:1fr 1fr;flex:1;overflow:hidden;}
.s1-left{display:flex;flex-direction:column;border-right:1px solid var(--border);overflow:hidden;}
.s1-right{display:flex;flex-direction:column;overflow:hidden;}
.s1-upload-panel{padding:14px 18px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:10px;background:var(--surface);flex-shrink:0;}
.s1-stock-strip{padding:9px 18px;border-bottom:1px solid var(--border);background:var(--purple-l);display:flex;flex-direction:column;gap:7px;flex-shrink:0;}
.s1-map-panel{padding:14px 18px;display:flex;flex-direction:column;gap:10px;overflow-y:auto;flex:1;}
.sec-title{font-family:'Syne',sans-serif;font-size:.86rem;font-weight:700;display:flex;align-items:center;gap:7px;}
.sec-sub{font-size:.69rem;color:var(--muted);line-height:1.5;margin-top:2px;}
.upzone{border:2px dashed var(--border2);border-radius:var(--r);padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s;background:var(--white);}
.upzone:hover,.upzone.drag{border-color:var(--accent);background:var(--accent-l);}
.upzone.ep{border-color:rgba(234,88,12,.35);background:var(--orange-l);}
.upzone.ep:hover{border-color:var(--orange);}
.upzone.ms{border-color:rgba(20,184,166,.35);background:var(--teal-l);}
.upzone.ms:hover{border-color:var(--teal);}
.uz-ico{font-size:1.4rem;display:block;margin-bottom:3px;}
.uz-txt{font-size:.74rem;color:var(--text2);}
.uz-txt strong{color:var(--orange);}
.ms .uz-txt strong{color:var(--teal);}
.uz-sub{font-size:.62rem;color:var(--muted);margin-top:2px;}
.mchip{display:flex;align-items:center;gap:9px;border-radius:var(--rs);padding:8px 11px;background:var(--teal-l);border:1px solid var(--teal-b);}
.mchip-ico{width:28px;height:28px;border-radius:4px;background:var(--teal);color:#fff;font-size:.58rem;font-weight:700;font-family:'IBM Plex Mono',monospace;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.mchip-name{font-size:.74rem;font-weight:600;color:var(--teal);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;}
.mchip-size{font-size:.62rem;color:var(--muted);}
.schip{display:flex;align-items:center;gap:9px;border-radius:var(--rs);padding:7px 10px;background:var(--white);border:1px solid var(--purple-b);}
.schip-name{font-size:.72rem;font-weight:600;color:var(--purple);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;}
.eplan-count{font-size:.67rem;font-weight:600;color:var(--muted);padding:2px 9px;border-radius:100px;background:var(--surface2);border:1px solid var(--border);}
.mcard{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
.mcard-h{padding:9px 13px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.mcard-h h4{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;}
.mcard-b{padding:10px 13px;overflow-y:auto;}
.cmt{width:100%;border-collapse:collapse;}
.cmt td{padding:4px 6px;font-size:.72rem;vertical-align:middle;border-bottom:1px solid var(--border);}
.cmt tr:last-child td{border-bottom:none;}
.cmt td:first-child{color:var(--text2);font-weight:500;white-space:nowrap;}
.ci{width:44px;padding:3px 7px;border:1px solid var(--border2);border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:.74rem;text-align:center;outline:none;background:var(--white);color:var(--text);}
.ci:focus{border-color:var(--accent);}
.ci-num{width:54px;}
.s1-footer{padding:11px 20px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-shrink:0;}

/* SCREEN 2 */
.s2-body{flex:1;overflow-y:auto;padding:20px 24px;}
.s2-inner{max-width:860px;margin:0 auto;display:flex;flex-direction:column;gap:16px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.fitem{display:flex;flex-direction:column;gap:4px;}
.flabel{font-size:.68rem;font-weight:600;color:var(--text2);letter-spacing:.03em;display:flex;align-items:center;gap:4px;}
.fcell{font-size:.6rem;font-weight:400;color:var(--muted);font-family:'IBM Plex Mono',monospace;background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:0px 4px;}
.finput{padding:7px 11px;border:1px solid var(--border2);border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;color:var(--text);background:var(--white);outline:none;transition:border-color .15s;}
.finput:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(15,118,110,.1);}
.finput::placeholder{color:var(--muted);}
select.finput{cursor:pointer;}
.row-badge{display:inline-flex;align-items:center;font-size:.6rem;font-weight:700;color:var(--muted);background:var(--surface2);border:1px solid var(--border);border-radius:3px;padding:1px 6px;font-family:'IBM Plex Mono',monospace;margin-bottom:6px;}
.s2-footer{padding:11px 20px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}

/* SCREEN 3 */
.s3-bar{padding:9px 18px;background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;flex-wrap:wrap;}
.s3-bar h3{font-family:'Syne',sans-serif;font-size:.86rem;font-weight:700;}
.s3-hint{font-size:.7rem;color:var(--muted);}
.s3-scroll{flex:1;overflow:auto;padding:14px 18px;}
.s3-footer{padding:11px 20px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}

/* Excel preview */
.xl-wrap{display:flex;justify-content:center;min-width:100%;}
.xl{border-collapse:collapse;font-size:.82rem;font-family:'IBM Plex Sans',sans-serif;table-layout:fixed;}
.xl td,.xl th{border:1px solid #d4dae8;padding:5px 9px;vertical-align:middle;overflow:hidden;}
.r-teal td{background:linear-gradient(135deg,#e8f8f5 0%,#d1f2eb 100%);color:#1a6355;}
.r-hdr td{background:linear-gradient(135deg,#2c3e7a 0%,#1a2d6b 100%);color:#e8eeff;font-weight:700;text-align:center;font-size:.78rem;border-color:#1a2450;}
.r-sub td{background:linear-gradient(135deg,#3d5a9a 0%,#2d4a8a 100%);color:#c8d8ff;font-weight:600;text-align:center;font-size:.76rem;border-color:#2a4080;}
.r-fl td{background:#f1f3fa;color:#8090b8;font-weight:600;text-align:center;font-size:.74rem;letter-spacing:.03em;font-family:'IBM Plex Mono',monospace;}
.r-inp td{background:linear-gradient(135deg,#fef9ec 0%,#fef3d0 100%);}
.r-sample td{background:#f8f9fc;color:#b8c0d8;font-size:.73rem;text-align:center;}
.sp{width:7px!important;min-width:7px!important;max-width:7px!important;background:#e4e8f2!important;padding:0!important;}
.r-teal .sp{background:#b8e8df!important;}
.rn{width:26px;min-width:26px;background:#1e2d5a;color:#7b8fc0;font-size:.63rem;text-align:center;font-weight:600;font-family:'IBM Plex Mono',monospace;border-color:#1a2450;}
.xauto{color:#0f6b5e;font-size:.72rem;font-style:italic;text-align:center;display:block;font-weight:600;}
.xempty{color:#bcc5d8;font-size:.67rem;font-style:italic;text-align:center;display:block;}
.xfrom{color:#6b44a8;font-size:.7rem;font-style:italic;text-align:center;display:block;}
.r-colhdr th{background:linear-gradient(135deg,#111827 0%,#1f2d4a 100%);color:#94a3c8;font-size:.66rem;font-weight:700;text-align:center;padding:5px 4px;border-color:#1a2040;white-space:nowrap;letter-spacing:.04em;}
.r-colhdr .rn{background:#0c1220;color:#3d5080;}

/* SCREEN 4 */
.s4-body{flex:1;display:flex;align-items:center;justify-content:center;padding:28px;}
.gcard{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:30px 34px;width:100%;max-width:480px;box-shadow:var(--sh-md);text-align:center;}
.gcard h2{font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:800;margin-bottom:5px;}
.gcard p{font-size:.74rem;color:var(--muted);line-height:1.65;margin-bottom:18px;}
.fn-label{font-size:.66rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:5px;text-align:left;}
.fn-wrap{display:flex;align-items:center;border:1px solid var(--border2);border-radius:var(--rs);overflow:hidden;margin-bottom:14px;}
.fn-input{flex:1;border:none;outline:none;padding:8px 11px;font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;color:var(--text);}
.fn-ext{padding:8px 11px;font-size:.72rem;font-weight:600;color:var(--muted);background:var(--surface2);border-left:1px solid var(--border);}
.slog{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:10px 12px;max-height:160px;overflow-y:auto;text-align:left;margin-bottom:14px;}
.ll{font-size:.7rem;font-family:'IBM Plex Mono',monospace;color:var(--text2);padding:1px 0;line-height:1.5;}
.ll.ok{color:var(--success);}.ll.err{color:var(--danger);}.ll.info{color:var(--accent);}

/* DARK */
body.dark{--bg:#13151f;--white:#1e2235;--surface:#252840;--surface2:#2d3148;--border:#363b58;--border2:#444968;--accent:#14b8a6;--accent-l:#0f2a28;--accent-h:#0d9488;--text:#e8eaf2;--text2:#9ba3c0;--muted:#6b7494;--orange-l:#251810;--teal-l:#0e2420;--teal-b:#1a5c52;--purple-l:#1e1530;--purple-b:#5b3fa0;}
body.dark .ci,body.dark .fn-input,body.dark .finput{background:var(--surface2);color:var(--text);}
body.dark .xl td,body.dark .xl th{border-color:#2d3a55;}
body.dark .r-teal td{background:#1a3d38;}
body.dark .r-hdr td{background:#0d1a3a;}
body.dark .r-sub td{background:#131f40;}
body.dark .r-fl td{background:#1e2235;color:#444968;}
body.dark .r-inp td{background:#201e08;}
body.dark .r-sample td{background:#161824;}
body.dark .rn{background:#1a1e2e;color:#444968;border-color:#2d3a55;}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none"><rect width="32" height="32" rx="8" fill="#2563eb"/><path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="16" cy="13" r="1.5" fill="white"/></svg>
    <div><div class="logo">Work<span>ezz</span></div><div class="logo-sub">MRS Generator</div></div>
  </div>
  <div style="display:flex;align-items:center;gap:9px;">
    <button class="dtgl" onclick="toggleDark()"><span id="dico">üåô</span><span id="dlbl">Dark</span></button>
    <a class="home-btn" href="index.html">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Home
    </a>
  </div>
</header>

<div class="stepper">
  <div class="step active" id="step1"><div class="step-num">1</div>Import &amp; Mapping</div>
  <span class="sarr">‚Ä∫</span>
  <div class="step" id="step2"><div class="step-num">2</div>MRS Fields</div>
  <span class="sarr">‚Ä∫</span>
  <div class="step" id="step3"><div class="step-num">3</div>Preview</div>
  <span class="sarr">‚Ä∫</span>
  <div class="step" id="step4"><div class="step-num">4</div>Generate</div>
</div>

<!-- ‚ïê‚ïê SCREEN 1 ‚ïê‚ïê -->
<div class="screen active" id="screen1">
  <div class="s1-body">

    <!-- LEFT: BOM source + stock + column mapping -->
    <div class="s1-left">

      <div class="s1-upload-panel">
        <div>
          <div class="sec-title">
            <span style="width:24px;height:24px;background:var(--orange-l);border:1px solid var(--orange-b);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.8rem;">üìÇ</span>
            BOM / EPLAN Source File(s)
          </div>
          <div class="sec-sub">Your BOM output or EPLAN export ‚Äî Make, Part No, Description, qty columns per panel.</div>
        </div>
        <input type="file" id="eplanInput" accept=".xls,.xlsx" multiple style="display:none" onchange="handleEplan(this)">
        <!-- Clickable drop zone ‚Äî acts as browse button itself -->
        <div class="upzone ep upzone-btn" onclick="document.getElementById('eplanInput').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="dropEplan(event);this.classList.remove('drag')" style="padding:14px 16px;display:flex;align-items:center;gap:14px;text-align:left;cursor:pointer;">
          <div style="width:40px;height:40px;border-radius:8px;background:rgba(234,88,12,.12);border:1.5px dashed rgba(234,88,12,.5);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">üìÇ</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:.78rem;font-weight:600;color:var(--orange);">Click to browse files</div>
            <div style="font-size:.67rem;color:var(--text2);margin-top:2px;">or drag &amp; drop ¬∑ Multiple <code style="font-size:.64rem;background:var(--surface2);padding:1px 4px;border-radius:3px;">.xls / .xlsx</code></div>
          </div>
          <div style="flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:3px;">
            <span class="eplan-count" id="eplanCount">0 files</span>
          </div>
        </div>
        <div id="eplanFileList" style="display:flex;flex-direction:column;gap:5px;"></div>
        <div id="eplanRemoveAllRow" style="display:none;">
          <button class="btn btn-do btn-sm" onclick="clearAllEplan()">‚úï Remove All Files</button>
        </div>
      </div>

      <!-- Available Stock strip -->
      <div class="s1-stock-strip">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
          <div>
            <div style="font-size:.74rem;font-weight:600;color:var(--purple);display:flex;align-items:center;gap:5px;">
              üì¶ Available Stock Sheet <span style="font-size:.62rem;font-weight:400;color:var(--muted);">(Optional)</span>
            </div>
            <div style="font-size:.65rem;color:var(--muted);margin-top:1px;" id="stockSubText">Parts already in hand ‚Äî net qty = Required ‚àí Stock. Leave blank to skip.</div>
          </div>
          <div style="display:flex;gap:6px;align-items:center;flex-shrink:0;">
            <input type="file" id="stockInput" accept=".xls,.xlsx" style="display:none" onchange="handleStock(this)">
            <button class="btn btn-sm" style="background:var(--purple);color:#fff;" onclick="document.getElementById('stockInput').click()">üìÇ Browse</button>
            <button class="btn btn-do btn-sm" id="stockClearBtn" style="display:none;" onclick="clearStock()">‚úï</button>
          </div>
        </div>
        <div id="stockMapRow" style="display:none;padding-top:6px;border-top:1px solid var(--purple-b);display:none;flex-wrap:wrap;gap:10px;align-items:center;">
          <span style="font-size:.66rem;font-weight:600;color:var(--purple);">Column mapping:</span>
          <label style="font-size:.68rem;color:var(--text2);display:flex;align-items:center;gap:4px;">Part No col <input class="ci" id="sCP" value="A" maxlength="2" style="width:36px;" oninput="this.value=this.value.toUpperCase()"></label>
          <label style="font-size:.68rem;color:var(--text2);display:flex;align-items:center;gap:4px;">Avail Qty col <input class="ci" id="sCQ" value="B" maxlength="2" style="width:36px;" oninput="this.value=this.value.toUpperCase()"></label>
          <label style="font-size:.68rem;color:var(--text2);display:flex;align-items:center;gap:4px;">Data start row <input class="ci ci-num" id="sSR" value="2" type="number" min="1" style="width:44px;"></label>
        </div>
      </div>

      <!-- BOM/EPLAN column mapping -->
      <div class="s1-map-panel">
        <div>
          <div class="sec-title" style="font-size:.78rem;">‚öôÔ∏è Source File Column Mapping</div>
          <div class="sec-sub">Which columns in your BOM/EPLAN file hold each field.</div>
        </div>
        <div class="mcard">
          <div class="mcard-h"><span>üìÇ</span><h4>BOM / EPLAN ‚Äî Source Columns</h4></div>
          <div class="mcard-b" style="max-height:none;">
            <table class="cmt">
              <tr><td>Make / Brand</td><td><input class="ci" id="eCM" value="B" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Part Number</td><td><input class="ci" id="eCP" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Description</td><td><input class="ci" id="eCD" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Qty col <span style="font-size:.62rem;color:var(--muted);">(fallback if no panel cols)</span></td><td><input class="ci" id="eCQ" value="G" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Data Start Row</td><td><input class="ci ci-num" id="eSR" value="2" type="number" min="1"></td></tr>
            </table>
            <div style="margin-top:8px;font-size:.65rem;color:var(--muted);background:var(--surface2);border-radius:4px;padding:5px 7px;">
              üí° If your BOM has panel columns (DMD, NMD‚Ä¶) as headers from col E onwards, they are auto-detected ‚Äî one MRS row per panel per part.
            </div>
          </div>
        </div>
      </div>

    </div><!-- /s1-left -->

    <!-- RIGHT: Blank MRS Master + MRS column mapping -->
    <div class="s1-right">

      <div class="s1-upload-panel">
        <div>
          <div class="sec-title">
            <span style="width:24px;height:24px;background:var(--teal-l);border:1px solid var(--teal-b);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.8rem;">üìã</span>
            Blank MRS Master
          </div>
          <div class="sec-sub">Your blank MRS template ‚Äî formatting, merges and headers will be preserved.</div>
        </div>
        <input type="file" id="masterInput" accept=".xls,.xlsx" style="display:none" onchange="handleMaster(this)">
        <!-- Clickable drop zone ‚Äî acts as browse button itself -->
        <div id="mEmptyZone" class="upzone ms upzone-btn" onclick="document.getElementById('masterInput').click()" ondragover="event.preventDefault();this.classList.add('drag')" ondragleave="this.classList.remove('drag')" ondrop="dropMaster(event);this.classList.remove('drag')" style="padding:14px 16px;display:flex;align-items:center;gap:14px;text-align:left;cursor:pointer;">
          <div style="width:40px;height:40px;border-radius:8px;background:rgba(20,184,166,.12);border:1.5px dashed rgba(20,184,166,.5);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0;">üìã</div>
          <div style="flex:1;min-width:0;">
            <div style="font-size:.78rem;font-weight:600;color:var(--teal);">Click to browse file</div>
            <div style="font-size:.67rem;color:var(--text2);margin-top:2px;">or drag &amp; drop ¬∑ Single <code style="font-size:.64rem;background:var(--surface2);padding:1px 4px;border-radius:3px;">.xls / .xlsx</code></div>
          </div>
        </div>
        <div id="mChip" class="mchip" style="display:none;">
          <div class="mchip-ico" id="mExt">XLS</div>
          <div style="flex:1;min-width:0;"><div class="mchip-name" id="mName">‚Äî</div><div class="mchip-size" id="mSize">‚Äî</div></div>
          <button class="btn btn-do btn-sm" onclick="clearMaster()">‚úï Remove</button>
        </div>
      </div>

      <div class="s1-map-panel">
        <div>
          <div class="sec-title" style="font-size:.78rem;">‚öôÔ∏è MRS Target Column Mapping</div>
          <div class="sec-sub">Which columns in your MRS template hold each field. Defaults match standard MRS template.</div>
        </div>
        <div class="mcard">
          <div class="mcard-h"><span>üìã</span><h4>MRS Master ‚Äî Target Columns</h4><span style="font-size:.63rem;color:var(--muted);margin-left:auto;">standard MRS defaults</span></div>
          <div class="mcard-b" style="max-height:340px;">
            <table class="cmt">
              <tr><td>ITEM Req ID (SR) ‚Üí A</td><td><input class="ci" id="mCA" value="A" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Make ‚Üí B</td><td><input class="ci" id="mCB" value="B" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Type/Order No ‚Üí C</td><td><input class="ci" id="mCC" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Description ‚Üí D</td><td><input class="ci" id="mCD" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Request Date ‚Üí E</td><td><input class="ci" id="mCE" value="E" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Scope ‚Üí F</td><td><input class="ci" id="mCF" value="F" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Section/Panel ‚Üí G</td><td><input class="ci" id="mCG" value="G" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Lead Time (wks) ‚Üí H</td><td><input class="ci" id="mCH" value="H" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Required Date ‚Üí I</td><td><input class="ci" id="mCI" value="I" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Exe. Loc. ‚Üí L</td><td><input class="ci" id="mCL" value="L" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Customer ‚Üí M</td><td><input class="ci" id="mCM" value="M" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>OR No. ‚Üí N</td><td><input class="ci" id="mCN" value="N" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Qty ‚Üí P</td><td><input class="ci" id="mCP" value="P" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Data Start Row</td><td><input class="ci ci-num" id="mSR" value="9" type="number" min="1"></td></tr>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /s1-right -->

  </div>
  <div class="s1-footer">
    <span id="s1hint" style="font-size:.71rem;color:var(--muted);">Upload BOM/EPLAN + Blank MRS Master to continue</span>
    <button class="btn btn-primary btn-lg" id="nextBtn1" onclick="goTo(2)" disabled>Next: MRS Fields ‚Üí</button>
  </div>
</div>


<!-- ‚ïê‚ïê SCREEN 2 ‚Äî MRS FIELDS ‚ïê‚ïê -->
<div class="screen" id="screen2">
  <div class="s2-body">
    <div class="s2-inner" style="max-width:1160px;">

      <!-- Side-by-side card layout ‚Äî full height, visually rich -->
      <div style="display:grid;grid-template-columns:1.1fr 0.9fr;gap:20px;align-items:start;">

      <!-- LEFT: MRS Header Info -->
      <div class="mcard" style="border-top:3px solid #2563eb;box-shadow:0 4px 20px rgba(37,99,235,.08);">
        <div class="mcard-h" style="background:linear-gradient(135deg,#eff6ff 0%,#e0eaff 100%);border-bottom:1px solid #c7d7f9;padding:13px 18px;">
          <div style="width:32px;height:32px;border-radius:8px;background:#2563eb;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;">üìÑ</div>
          <div style="margin-left:10px;">
            <h4 style="font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;color:#1e3a8a;">MRS Header Info</h4>
            <div style="font-size:.63rem;color:#6b7eb8;margin-top:1px;">Written into rows 1‚Äì4 of your MRS template</div>
          </div>
        </div>
        <div class="mcard-b" style="max-height:none;padding:20px 20px 16px;">

          <!-- Row badge + fields -->
          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div style="background:#2563eb;color:#fff;font-size:.6rem;font-weight:800;font-family:'IBM Plex Mono',monospace;padding:2px 9px;border-radius:100px;letter-spacing:.05em;">ROW 1</div>
            <div style="flex:1;height:1px;background:linear-gradient(90deg,#c7d7f9,transparent);"></div>
          </div>
          <div class="fgrid" style="margin-bottom:18px;">
            <div class="fitem">
              <label class="flabel" style="color:#1e40af;">Customer <span class="fcell" style="background:#dbeafe;border-color:#bfdbfe;color:#1d4ed8;">D1</span></label>
              <input class="finput" id="f_customer" placeholder="e.g. KPCL" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel" style="color:#1e40af;">Prepare By <span class="fcell" style="background:#dbeafe;border-color:#bfdbfe;color:#1d4ed8;">I1</span></label>
              <input class="finput" id="f_prepby" placeholder="e.g. MAS" oninput="syncPreview()">
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div style="background:#0891b2;color:#fff;font-size:.6rem;font-weight:800;font-family:'IBM Plex Mono',monospace;padding:2px 9px;border-radius:100px;letter-spacing:.05em;">ROW 2</div>
            <div style="flex:1;height:1px;background:linear-gradient(90deg,#a5f3fc,transparent);"></div>
          </div>
          <div class="fgrid" style="margin-bottom:18px;">
            <div class="fitem">
              <label class="flabel" style="color:#155e75;">OR No. <span class="fcell" style="background:#cffafe;border-color:#a5f3fc;color:#0e7490;">D2</span></label>
              <input class="finput" id="f_orno" placeholder="e.g. FSL/2425/PUN/OR115" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel" style="color:#155e75;">Approve By <span class="fcell" style="background:#cffafe;border-color:#a5f3fc;color:#0e7490;">I2</span></label>
              <input class="finput" id="f_appby" placeholder="e.g. TBP" oninput="syncPreview()">
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div style="background:#7c3aed;color:#fff;font-size:.6rem;font-weight:800;font-family:'IBM Plex Mono',monospace;padding:2px 9px;border-radius:100px;letter-spacing:.05em;">ROW 3</div>
            <div style="flex:1;height:1px;background:linear-gradient(90deg,#ddd6fe,transparent);"></div>
          </div>
          <div class="fgrid" style="margin-bottom:18px;">
            <div class="fitem">
              <label class="flabel" style="color:#5b21b6;">Execution Location <span class="fcell" style="background:#ede9fe;border-color:#ddd6fe;color:#7c3aed;">D3</span></label>
              <input class="finput" id="f_exeloc" placeholder="e.g. GON" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel" style="color:#5b21b6;">MRS No. <span class="fcell" style="background:#ede9fe;border-color:#ddd6fe;color:#7c3aed;">I3</span></label>
              <input class="finput" id="f_mrsno" placeholder="e.g. 15" oninput="syncPreview()">
            </div>
          </div>

          <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
            <div style="background:#0f766e;color:#fff;font-size:.6rem;font-weight:800;font-family:'IBM Plex Mono',monospace;padding:2px 9px;border-radius:100px;letter-spacing:.05em;">ROW 4</div>
            <div style="flex:1;height:1px;background:linear-gradient(90deg,#99f6e4,transparent);"></div>
          </div>
          <div class="fgrid">
            <div class="fitem">
              <label class="flabel" style="color:#134e4a;">Request Date <span class="fcell" style="background:#ccfbf1;border-color:#99f6e4;color:#0f766e;">D4</span> <span style="font-size:.59rem;color:var(--muted);font-weight:400;">+ col E every row</span></label>
              <input class="finput" id="f_reqdate" type="date" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel" style="color:#134e4a;">MRS Version <span class="fcell" style="background:#ccfbf1;border-color:#99f6e4;color:#0f766e;">I4</span></label>
              <input class="finput" id="f_mrsver" placeholder="e.g. A" oninput="syncPreview()">
            </div>
          </div>

        </div>
      </div>

      <!-- RIGHT: Per-Row Values -->
      <div class="mcard" style="border-top:3px solid #ea580c;box-shadow:0 4px 20px rgba(234,88,12,.08);">
        <div class="mcard-h" style="background:linear-gradient(135deg,#fff7ed 0%,#ffedd5 100%);border-bottom:1px solid #fed7aa;padding:13px 18px;">
          <div style="width:32px;height:32px;border-radius:8px;background:#ea580c;display:flex;align-items:center;justify-content:center;font-size:.9rem;flex-shrink:0;">üîÅ</div>
          <div style="margin-left:10px;">
            <h4 style="font-family:'Syne',sans-serif;font-size:.9rem;font-weight:800;color:#7c2d12;">Per-Row Values</h4>
            <div style="font-size:.63rem;color:#c2410c;margin-top:1px;">Applied to every data row in the output</div>
          </div>
        </div>
        <div class="mcard-b" style="max-height:none;padding:20px 20px 16px;">

          <div style="display:flex;flex-direction:column;gap:14px;">
            <div class="fitem">
              <label class="flabel">Scope <span class="fcell" style="background:#fff7ed;border-color:#fed7aa;color:#ea580c;">col F</span></label>
              <input class="finput" id="f_scope" placeholder="e.g. PUR" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Lead Time <span class="fcell" style="background:#fff7ed;border-color:#fed7aa;color:#ea580c;">col H</span></label>
              <select class="finput" id="f_leadtime" onchange="syncPreview()">
                <option value="">‚Äî select weeks ‚Äî</option>
                <option value="1">1 Week</option><option value="2">2 Weeks</option>
                <option value="3">3 Weeks</option><option value="4">4 Weeks</option>
                <option value="5">5 Weeks</option><option value="6">6 Weeks</option>
                <option value="7">7 Weeks</option><option value="8">8 Weeks</option>
                <option value="9">9 Weeks</option><option value="10">10 Weeks</option>
              </select>
            </div>
            <div class="fitem">
              <label class="flabel">Unit for Qty <span class="fcell" style="background:#fff7ed;border-color:#fed7aa;color:#ea580c;">col Q</span></label>
              <input class="finput" id="f_unitqty" placeholder="e.g. Nos, Mtrs, Sets" oninput="syncPreview()">
            </div>
          </div>

          <div style="margin-top:18px;font-size:.67rem;color:var(--muted);background:var(--surface2);border-radius:var(--rs);padding:10px 12px;line-height:1.7;border-left:3px solid var(--border2);">
            <div style="margin-bottom:4px;"><span style="color:var(--text2);font-weight:600;">‚ÑπÔ∏è Auto-calculations</span></div>
            <b>Required Date (col I)</b> = Request Date + Lead Time weeks<br>
            <b>Customer (col M) ¬∑ OR No. (col N) ¬∑ Exe. Loc. (col L)</b> repeat on every row<br>
            <b>Section (col G)</b> = panel name from BOM (NMD PANEL, DMD PANEL‚Ä¶)<br>
            <b>Unit for Qty (col Q)</b> = unit of measurement on every data row
          </div>
        </div>
      </div>

      </div><!-- /side-by-side grid -->

    </div>
  </div>
  <div class="s2-footer">
    <button class="btn btn-secondary" onclick="goTo(1)">‚Äπ Back</button>
    <button class="btn btn-primary btn-lg" onclick="goToPreview()">Next: Preview ‚Üí</button>
  </div>
</div>


<!-- ‚ïê‚ïê SCREEN 3 ‚Äî PREVIEW ‚ïê‚ïê -->
<div class="screen" id="screen3">
  <div class="s3-bar">
    <h3>üìã MRS Preview</h3>
    <span class="s3-hint">Rows 1‚Äì4 = header ¬∑ Rows 5‚Äì8 = MRS column headers / FL ¬∑ Row 9+ = data rows ¬∑ <span style="color:#0f6b5e;font-weight:600;">‚óè Teal = your input values</span> ¬∑ <span style="color:#6b44a8;font-weight:600;">‚óè Purple = auto-filled from BOM</span></span>
  </div>
  <div class="s3-scroll" style="display:flex;justify-content:center;">
    <div style="width:100%;overflow-x:auto;">
      <table class="xl" id="xlTable" style="margin:0 auto;"></table>
    </div>
  </div>
  <div class="s3-footer">
    <button class="btn btn-secondary" onclick="goTo(2)">‚Äπ Back</button>
    <button class="btn btn-primary btn-lg" onclick="goTo(4)">Next: Generate ‚Üí</button>
  </div>
</div>


<!-- ‚ïê‚ïê SCREEN 4 ‚Äî GENERATE ‚ïê‚ïê -->
<div class="screen" id="screen4">
  <div class="s4-body">
    <div class="gcard">
      <div style="font-size:2rem;margin-bottom:9px;">‚ö°</div>
      <h2>Generate MRS</h2>
      <p>BOM parts will be written into your blank MRS template ‚Äî header info filled, per-row values applied, quantities net of available stock.</p>
      <div>
        <div class="fn-label" style="display:flex;align-items:center;justify-content:space-between;">
          Output File Name
          <span id="autoNameBadge" style="font-size:.62rem;font-weight:600;color:var(--accent);background:var(--accent-l);border:1px solid var(--teal-b);border-radius:100px;padding:1px 8px;display:none;">‚ú¶ auto-suggested</span>
        </div>
        <div class="fn-wrap"><input class="fn-input" id="exportName" value="MRS_Generated" placeholder="MRS_Generated"><span class="fn-ext">.xlsx</span></div>
        <div style="font-size:.63rem;color:var(--muted);margin-top:4px;">üìù Auto-filled from OR No ¬∑ MRS No ¬∑ Version ‚Äî edit freely</div>
      </div>
      <div class="slog" id="slog"><div class="ll info">‚ñ∏ Ready ‚Äî click below to generate</div></div>
      <button class="btn btn-success btn-full btn-lg" id="genBtn" onclick="generate()">‚ö° Generate MRS</button>
      <div style="margin-top:9px;"><button class="btn btn-secondary btn-full" onclick="goTo(3)">‚Äπ Back to Preview</button></div>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê
let eplanFiles=[], masterFile=null, stockFile=null;

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
function ci(l){return l.toUpperCase().charCodeAt(0)-65;}
function fmtSz(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function today(){return new Date().toISOString().slice(0,10);}
function addWeeks(ds,wks){
  if(!ds||!wks)return'';
  const d=new Date(ds);d.setDate(d.getDate()+parseInt(wks)*7);
  return d.toISOString().slice(0,10);
}
function fmtDateDisp(ds){
  if(!ds)return'';
  const d=new Date(ds);
  return d.toLocaleDateString('en-GB',{day:'2-digit',month:'short',year:'2-digit'});
}
function g(id){return document.getElementById(id);}
function gv(id){return g(id)?.value||'';}

// ‚îÄ‚îÄ BOM/EPLAN Files ‚îÄ‚îÄ
function handleEplan(inp){
  Array.from(inp.files).forEach(f=>{if(!eplanFiles.find(e=>e.name===f.name))eplanFiles.push(f);});
  inp.value='';renderEplan();chk();
}
function dropEplan(e){
  e.preventDefault();
  Array.from(e.dataTransfer.files).filter(f=>f.name.match(/\.xlsx?$/i))
    .forEach(f=>{if(!eplanFiles.find(x=>x.name===f.name))eplanFiles.push(f);});
  renderEplan();chk();
}
function clearAllEplan(){
  eplanFiles=[];
  renderEplan();chk();
}
function removeEplanFile(name){
  eplanFiles=eplanFiles.filter(f=>f.name!==name);
  renderEplan();chk();
}
function renderEplan(){
  const n=eplanFiles.length;
  g('eplanCount').textContent=n+' file'+(n!==1?'s':'');
  const list=g('eplanFileList');
  const rar=g('eplanRemoveAllRow');
  if(!list)return;
  list.innerHTML=eplanFiles.map(f=>`
    <div style="display:flex;align-items:center;gap:8px;background:var(--orange-l);border:1px solid var(--orange-b);border-radius:var(--rs);padding:6px 10px;">
      <span style="width:22px;height:22px;border-radius:4px;background:rgba(234,88,12,.15);display:flex;align-items:center;justify-content:center;font-size:.75rem;flex-shrink:0;">üìÑ</span>
      <span style="font-size:.73rem;font-weight:600;color:#9a3412;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name}</span>
      <span style="font-size:.63rem;color:var(--muted);flex-shrink:0;">${fmtSz(f.size)}</span>
      <button class="btn btn-do btn-sm" onclick="removeEplanFile('${f.name.replace(/'/g,"\\'")}')">‚úï</button>
    </div>
  `).join('');
  if(rar) rar.style.display=n>1?'':'none';
}

// ‚îÄ‚îÄ MRS Master ‚îÄ‚îÄ
function handleMaster(inp){
  if(!inp.files.length)return;
  masterFile=inp.files[0];inp.value='';
  const ext=masterFile.name.split('.').pop().toUpperCase();
  g('mEmptyZone').style.display='none';
  g('mChip').style.display='flex';
  g('mExt').textContent=ext;
  g('mName').textContent=masterFile.name;
  g('mSize').textContent=fmtSz(masterFile.size);
  chk();
}
function dropMaster(e){
  e.preventDefault();
  const files=Array.from(e.dataTransfer.files).filter(f=>f.name.match(/\.xlsx?$/i));
  if(files.length){
    const inp=g('masterInput');
    // Create a DataTransfer to simulate file selection
    masterFile=files[0];
    const ext=masterFile.name.split('.').pop().toUpperCase();
    g('mEmptyZone').style.display='none';
    g('mChip').style.display='flex';
    g('mExt').textContent=ext;
    g('mName').textContent=masterFile.name;
    g('mSize').textContent=fmtSz(masterFile.size);
    g('masterRemoveBtn').style.display='';
    chk();
  }
}
function clearMaster(){
  masterFile=null;
  g('mEmptyZone').style.display='';
  g('mChip').style.display='none';
  g('masterInput').value='';
  chk();
}

// ‚îÄ‚îÄ Stock File ‚îÄ‚îÄ
function handleStock(inp){
  if(!inp.files.length)return;
  stockFile=inp.files[0];inp.value='';
  g('stockSubText').textContent='‚úì '+stockFile.name+' loaded ‚Äî net qty will be calculated';
  g('stockClearBtn').style.display='';
  g('stockMapRow').style.display='flex';
}
function clearStock(){
  stockFile=null;
  g('stockSubText').textContent='Parts already in hand ‚Äî net qty = Required ‚àí Stock. Leave blank to skip.';
  g('stockClearBtn').style.display='none';
  g('stockMapRow').style.display='none';
  g('stockInput').value='';
}

// ‚îÄ‚îÄ Validation ‚îÄ‚îÄ
function chk(){
  const ok=eplanFiles.length>0&&masterFile!==null;
  g('nextBtn1').disabled=!ok;
  g('s1hint').textContent=
    (!eplanFiles.length&&!masterFile)?'Upload BOM/EPLAN + Blank MRS Master to continue':
    !eplanFiles.length?'Add at least 1 BOM/EPLAN file':
    !masterFile?'Upload blank MRS Master to continue':
    `‚úì ${eplanFiles.length} source file(s) + MRS Master ready${stockFile?' ¬∑ stock loaded':''}`;
}

// ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
function goTo(n){
  document.querySelectorAll('.screen').forEach((s,i)=>s.classList.toggle('active',i===n-1));
  document.querySelectorAll('.step').forEach((s,i)=>{
    s.classList.remove('active','done');
    if(i+1===n)s.classList.add('active');
    else if(i+1<n)s.classList.add('done');
  });
  if(n===4) autoSuggestName();
}
function goToPreview(){goTo(3);buildPreview();}

// ‚îÄ‚îÄ Auto-suggest export filename from OR No + MRS No + MRS Version ‚îÄ‚îÄ
function autoSuggestName(){
  const orno   = gv('f_orno');    // e.g. FSL/2425/PUN/OR115
  const mrsno  = gv('f_mrsno');   // e.g. 15
  const mrsver = gv('f_mrsver');  // e.g. A  or  V0A

  if(!orno && !mrsno && !mrsver) return;

  // OR No: FSL/2425/PUN/OR115 ‚Üí FSL_2425_PUN_OR115  (replace all non-alphanumeric with _)
  const orPart  = orno
    ? orno.replace(/[^a-zA-Z0-9]+/g,'_').replace(/^_+|_+$/g,'')
    : '';

  // MRS No: pad to 2 digits  e.g. 15 ‚Üí 15,  2 ‚Üí 02
  const mrsPart = mrsno
    ? String(parseInt(mrsno)||0).padStart(2,'0')
    : '';

  // Version: normalise ‚Üí V0A  (if user types just "A" ‚Üí V0A, "0A" ‚Üí V0A, "V0A" ‚Üí V0A)
  let verPart = '';
  if(mrsver){
    let v = mrsver.trim().toUpperCase();
    if(!v.startsWith('V')) v = 'V' + v;       // ensure leading V
    if(v.length === 2) v = v[0]+'0'+v[1];     // VA ‚Üí V0A
    verPart = v;
  }

  const parts = ['MRS', orPart, mrsPart, verPart].filter(Boolean);
  const suggested = parts.join('_');

  const inp   = g('exportName');
  const badge = g('autoNameBadge');
  if(inp)   inp.value = suggested;
  if(badge) badge.style.display = 'inline';
}

// ‚îÄ‚îÄ Sync preview live while on Screen 2 ‚îÄ‚îÄ
function syncPreview(){
  if(!g('xlTable').innerHTML)return; // not built yet, will build fresh on navigate
  calcLive();
  autoSuggestName();
}

// ‚îÄ‚îÄ BUILD PREVIEW TABLE ‚îÄ‚îÄ
// Columns shown: A B C D E F G H I J  L M N  P Q
//                SR Mk PN Desc ReqDt Scope Sec LdTm ReqDt2 Avail ExeLoc Cust ORNo Qty Unit
const PCOLS=['A','B','C','D','E','F','G','H','I','J','L','M','N','P','Q'];
const PCW  ={A:70,B:90,C:150,D:260,E:80,F:68,G:100,H:72,I:80,J:80,L:60,M:140,N:100,P:54,Q:70};

function buildPreview(){
  const tbl=g('xlTable');
  let h='<colgroup><col style="width:22px">';
  PCOLS.forEach(c=>{h+=`<col style="width:${PCW[c]}px">`;});
  h+='</colgroup>';

  // Column letter header
  h+='<tr class="r-colhdr"><th class="rn">Row</th>';
  PCOLS.forEach(c=>{h+=`<th>${c}</th>`;});
  h+='</tr>';

  // ‚îÄ‚îÄ ROWS 1-4: MRS header ‚îÄ‚îÄ
  // Actual MRS: label spans A:C (merged), value in D; label in H, value in I
  // We show: col A = label, col D = value, col H = label, col I = value
  const hdrDefs=[
    {rn:1,lA:'Customer',     idD:'f_customer',lH:'Prepare By', idI:'f_prepby'},
    {rn:2,lA:'OR No',        idD:'f_orno',    lH:'Approve By', idI:'f_appby' },
    {rn:3,lA:'Execution Loc',idD:'f_exeloc',  lH:'MRS NO',     idI:'f_mrsno' },
    {rn:4,lA:'Request Date', idD:'f_reqdate', lH:'MRS Ver',    idI:'f_mrsver'},
  ];
  hdrDefs.forEach(r=>{
    const vD=gv(r.idD);
    const vI=gv(r.idI);
    // Display date nicely for row 4
    const dispD=(r.rn===4&&vD)?fmtDateDisp(vD):vD;
    h+=`<tr class="r-teal">`;
    h+=`<td class="rn">${r.rn}</td>`;
    h+=`<td style="font-size:.68rem;font-weight:700;color:#1a6355;">${r.lA}</td>`;
    h+=`<td></td><td></td>`;// B C spacers (simulating merge)
    h+=`<td><span class="xauto" id="pv_${r.idD}">${dispD||'‚Äî'}</span></td>`;// D = value
    h+=`<td></td><td></td><td></td>`;// E F G spacers
    h+=`<td style="font-size:.68rem;font-weight:700;color:#1a6355;">${r.lH}</td>`;// H = label
    h+=`<td><span class="xauto" id="pv_${r.idI}">${vI||'‚Äî'}</span></td>`;// I = value
    h+=`<td></td>`;// J
    h+=`<td></td><td></td><td></td>`;// L M N
    h+=`<td></td><td></td>`;// P Q
    h+=`</tr>`;
  });

  // ‚îÄ‚îÄ ROW 5: MRS section spans ‚îÄ‚îÄ
  h+=`<tr class="r-hdr"><td class="rn">5</td>
    <td colspan="4" style="background:#c5dff0;text-align:center;font-size:.68rem;">MRS</td>
    <td></td><td></td><td></td><td></td><td></td>
    <td colspan="3" style="background:#c5dff0;text-align:center;font-size:.68rem;">Execution Details</td>
    <td colspan="2" style="background:#c5dff0;text-align:center;font-size:.68rem;">Project Qty</td>
  </tr>`;

  // ‚îÄ‚îÄ ROW 6: Column headers ‚îÄ‚îÄ
  h+=`<tr class="r-hdr"><td class="rn">6</td>
    <td>ITEM Req ID</td><td>Make</td><td>Type/Order No</td><td>DESCRIPTION</td>
    <td>Request</td><td>Scope</td><td>Section</td><td>Standard</td>
    <td>Required</td><td>Available</td>
    <td>Exe. Loc.</td><td>Customer</td><td>OR No.</td>
    <td>Project</td><td>Unit For Qty</td>
  </tr>`;

  // ‚îÄ‚îÄ ROW 7: Sub-headers ‚îÄ‚îÄ
  h+=`<tr class="r-sub"><td class="rn">7</td>
    <td></td><td></td><td></td><td></td>
    <td>Date</td><td></td><td></td><td>Lead Time</td>
    <td>Date</td><td>Lead Time</td>
    <td></td><td></td><td></td>
    <td>Qty.</td><td></td>
  </tr>`;

  // ‚îÄ‚îÄ ROW 8: FL ‚îÄ‚îÄ
  h+=`<tr class="r-fl"><td class="rn">8</td>`;
  PCOLS.forEach(()=>{h+=`<td>FL</td>`;});
  h+=`</tr>`;

  // ‚îÄ‚îÄ ROW 9: Live first data row ‚îÄ‚îÄ
  const vReqDate=gv('f_reqdate');
  const vLead=gv('f_leadtime');
  const vReqDt2=addWeeks(vReqDate,vLead);
  const vScope=gv('f_scope');
  const vExeLoc=gv('f_exeloc');
  const vCust=gv('f_customer');
  const vOrNo=gv('f_orno');
  const vMrsNo=gv('f_mrsno');
  const vUnitQty=gv('f_unitqty');
  const srEx='001'+(vMrsNo?'_'+vMrsNo:'');

  h+=`<tr class="r-inp"><td class="rn" style="font-weight:700;color:var(--accent);">9</td>
    <td><span class="xfrom" id="v_sr">${srEx}</span></td>
    <td><span class="xfrom">from BOM</span></td>
    <td><span class="xfrom">from BOM</span></td>
    <td><span class="xfrom">from BOM</span></td>
    <td><span class="xauto" id="v_reqdate">${vReqDate?fmtDateDisp(vReqDate):'‚Äî'}</span></td>
    <td><span class="xauto" id="v_scope">${vScope||'‚Äî'}</span></td>
    <td><span class="xfrom">panel name</span></td>
    <td><span class="xauto" id="v_lead">${vLead?vLead+' wk':'‚Äî'}</span></td>
    <td><span class="xauto" id="v_reqdt2">${vReqDt2?fmtDateDisp(vReqDt2):'Req+Lead'}</span></td>
    <td><span class="xempty">‚Äî</span></td>
    <td><span class="xauto" id="v_exeloc">${vExeLoc||'‚Äî'}</span></td>
    <td><span class="xauto" id="v_cust">${vCust||'‚Äî'}</span></td>
    <td><span class="xauto" id="v_orno">${vOrNo||'‚Äî'}</span></td>
    <td><span class="xfrom">from BOM${stockFile?' ‚àístock':''}</span></td>
    <td><span class="xauto" id="v_unitqty">${vUnitQty||'‚Äî'}</span></td>
  </tr>`;

  // Sample dimmed rows
  for(let i=1;i<4;i++){
    h+=`<tr class="r-sample"><td class="rn" style="color:#ccc">${9+i}</td>
      <td>00${i+1}${vMrsNo?'_'+vMrsNo:''}</td>
      <td style="text-align:left">Make‚Ä¶</td>
      <td style="text-align:left;font-family:monospace">Part No‚Ä¶</td>
      <td style="text-align:left">Description‚Ä¶</td>
      <td>‚Üëdate</td><td>‚Üëscope</td><td>Panel</td><td>‚Üëlead</td>
      <td>‚Üëauto</td><td></td>
      <td>‚Üëloc</td><td>‚Üëcust</td><td>‚Üëorno</td>
      <td>qty</td><td></td>
    </tr>`;
  }

  tbl.innerHTML=h;
}

// ‚îÄ‚îÄ Live update preview spans (no full rebuild) ‚îÄ‚îÄ
function calcLive(){
  const vReqDate=gv('f_reqdate');
  const vLead=gv('f_leadtime');
  const vReqDt2=addWeeks(vReqDate,vLead);
  const vMrsNo=gv('f_mrsno');
  const set=(id,val)=>{const el=g(id);if(el)el.textContent=val||'‚Äî';};

  // Header rows
  set('pv_f_customer',gv('f_customer'));
  set('pv_f_prepby',gv('f_prepby'));
  set('pv_f_orno',gv('f_orno'));
  set('pv_f_appby',gv('f_appby'));
  set('pv_f_exeloc',gv('f_exeloc'));
  set('pv_f_mrsno',gv('f_mrsno'));
  set('pv_f_reqdate',vReqDate?fmtDateDisp(vReqDate):'');
  set('pv_f_mrsver',gv('f_mrsver'));

  // Row 9 cells
  set('v_sr','001'+(vMrsNo?'_'+vMrsNo:''));
  set('v_reqdate',vReqDate?fmtDateDisp(vReqDate):'');
  set('v_scope',gv('f_scope'));
  set('v_lead',gv('f_leadtime')?(gv('f_leadtime')+' wk'):'');
  set('v_reqdt2',vReqDt2?fmtDateDisp(vReqDt2):'Req+Lead');
  set('v_exeloc',gv('f_exeloc'));
  set('v_cust',gv('f_customer'));
  set('v_orno',gv('f_orno'));
  set('v_unitqty',gv('f_unitqty'));
}

// ‚îÄ‚îÄ Read Excel ‚îÄ‚îÄ
function readXL(file,sheetIdx){
  sheetIdx=sheetIdx||0;
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>{
      try{
        const wb=XLSX.read(e.target.result,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[sheetIdx]];
        res(XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:true}));
      }catch(err){console.error(err);res([]);}
    };
    r.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ Log ‚îÄ‚îÄ
function lg(msg,type=''){
  const el=g('slog');
  const cls={ok:'ll ok',err:'ll err',info:'ll info'}[type]||'ll';
  el.innerHTML+=`<div class="${cls}">‚ñ∏ ${msg}</div>`;
  el.scrollTop=el.scrollHeight;
}

// ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ
async function generate(){
  const btn=g('genBtn');
  btn.disabled=true;btn.textContent='Generating‚Ä¶';
  g('slog').innerHTML='';
  await new Promise(r=>setTimeout(r,40));

  try{
    // Source column indices (0-based)
    const eCM=ci(gv('eCM')||'B'); // Make
    const eCP=ci(gv('eCP')||'C'); // Part Number
    const eCD=ci(gv('eCD')||'D'); // Description
    const eCQ=ci(gv('eCQ')||'G'); // Fallback qty
    const eSR=parseInt(gv('eSR'))||2;

    // MRS target columns (0-based, will use +1 for ExcelJS 1-based)
    const mCA =ci(gv('mCA')||'A');
    const mCB =ci(gv('mCB')||'B');
    const mCC =ci(gv('mCC')||'C');
    const mCD =ci(gv('mCD')||'D');
    const mCE =ci(gv('mCE')||'E');
    const mCF =ci(gv('mCF')||'F');
    const mCG =ci(gv('mCG')||'G');
    const mCH =ci(gv('mCH')||'H');
    const mCI =ci(gv('mCI')||'I');
    const mCL =ci(gv('mCL')||'L');
    const mCM2=ci(gv('mCM')||'M');
    const mCN =ci(gv('mCN')||'N');
    const mCP =ci(gv('mCP')||'P');
    const mSR =parseInt(gv('mSR'))||9;

    // Screen 2 values
    const vCustomer=gv('f_customer');
    const vPrepBy  =gv('f_prepby');
    const vOrNo    =gv('f_orno');
    const vAppBy   =gv('f_appby');
    const vExeLoc  =gv('f_exeloc');
    const vMrsNo   =gv('f_mrsno');
    const vReqDate =gv('f_reqdate');
    const vMrsVer  =gv('f_mrsver');
    const vScope   =gv('f_scope');
    const vLeadWks =gv('f_leadtime');
    const vReqDt2  =addWeeks(vReqDate,vLeadWks);
    const vUnitQty =gv('f_unitqty');

    // ‚îÄ‚îÄ STEP 1: Load available stock (optional) ‚îÄ‚îÄ
    const stockMap=new Map(); // partNo.lower ‚Üí availQty
    if(stockFile){
      lg('Reading available stock file‚Ä¶','info');
      const sCP=ci(gv('sCP')||'A');
      const sCQ=ci(gv('sCQ')||'B');
      const sSR=parseInt(gv('sSR'))||2;
      const sData=await readXL(stockFile);
      for(let i=sSR-1;i<sData.length;i++){
        const row=sData[i];
        const pn=String(row[sCP]||'').trim();
        if(!pn)continue;
        const qty=typeof row[sCQ]==='number'?row[sCQ]:(parseFloat(String(row[sCQ]).replace(/,/g,''))||0);
        stockMap.set(pn.toLowerCase(),(stockMap.get(pn.toLowerCase())||0)+qty);
      }
      lg(`‚úì Stock loaded: ${stockMap.size} unique parts`,'ok');
    }

    // ‚îÄ‚îÄ STEP 2: Read BOM/EPLAN source files ‚îÄ‚îÄ
    lg('Reading BOM/EPLAN source files‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));

    // Structure: Map of partNo.lower ‚Üí {partNum, make, desc, panels:[{panel,qty}]}
    const parts=new Map();
    let totalRows=0;

    // Column names to skip when detecting panel columns
    const skipNames=new Set(['sr','make','part number','part description','description','total qty','mrs qty','total','quantity','qty']);

    for(const file of eplanFiles){
      lg(`  Reading ${file.name}‚Ä¶`);
      const data=await readXL(file);
      if(!data.length)continue;

      const headerRow=data[0];

      // Detect panel columns: columns not in fixed set
      const fixedColIdxs=new Set([0,eCM,eCP,eCD,eCQ]); // SR at 0
      const panelCols=[];
      for(let c=0;c<headerRow.length;c++){
        const h=String(headerRow[c]||'').trim();
        if(!h)continue;
        if(fixedColIdxs.has(c))continue;
        if(skipNames.has(h.toLowerCase()))continue;
        panelCols.push({col:c,panel:h});
      }
      const usePanels=panelCols.length>0;
      if(usePanels) lg(`    Panels: ${panelCols.map(p=>p.panel).join(', ')}`);
      else lg(`    No panel columns ‚Äî using qty col ${gv('eCQ')||'G'}`);

      for(let i=eSR-1;i<data.length;i++){
        const row=data[i];
        const pn=String(row[eCP]||'').trim();
        if(!pn)continue;
        const make=String(row[eCM]||'').trim();
        const desc=String(row[eCD]||'').trim();
        const key=pn.toLowerCase();
        if(!parts.has(key))parts.set(key,{partNum:pn,make,desc,panels:[]});
        const entry=parts.get(key);
        if(!entry.make&&make)entry.make=make;
        if(!entry.desc&&desc)entry.desc=desc;

        if(usePanels){
          for(const {col,panel} of panelCols){
            const rawQ=row[col];
            const qty=typeof rawQ==='number'?rawQ:(parseFloat(String(rawQ).replace(/,/g,''))||0);
            if(qty>0){
              const ex=entry.panels.find(p=>p.panel===panel);
              if(ex)ex.qty+=qty;
              else entry.panels.push({panel,qty});
            }
          }
        } else {
          const rawQ=row[eCQ];
          const qty=typeof rawQ==='number'?rawQ:(parseFloat(String(rawQ).replace(/,/g,''))||0);
          if(qty>0){
            const ex=entry.panels.find(p=>p.panel==='Total');
            if(ex)ex.qty+=qty;
            else entry.panels.push({panel:'Total',qty});
          }
        }
        totalRows++;
      }
    }
    for(const [k,v] of parts){if(!v.panels.length)parts.delete(k);}
    lg(`‚úì ${parts.size} unique parts from ${totalRows} rows`,'ok');

    // ‚îÄ‚îÄ STEP 3: Apply stock deduction ‚îÄ‚îÄ
    let skipped=0;
    if(stockFile&&stockMap.size>0){
      lg('Applying stock deductions‚Ä¶','info');
      for(const [key,entry] of parts){
        let avail=stockMap.get(key)||0;
        if(avail<=0)continue;
        for(const p of entry.panels){
          const deduct=Math.min(p.qty,avail);
          p.qty-=deduct;
          avail-=deduct;
          if(avail<=0)break;
        }
        entry.panels=entry.panels.filter(p=>p.qty>0);
        if(!entry.panels.length){parts.delete(key);skipped++;}
      }
      lg(`‚úì ${skipped} parts fully covered by stock (excluded from MRS)`,'ok');
    }

    // ‚îÄ‚îÄ STEP 4: Load MRS Master template ‚îÄ‚îÄ
    lg('Loading MRS Master template‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));
    const buf=await masterFile.arrayBuffer();
    const wb2=new ExcelJS.Workbook();
    await wb2.xlsx.load(buf);
    // Use BOM sheet if exists, else first sheet
    const ws=wb2.worksheets.find(s=>s.name.toUpperCase()==='BOM')||wb2.worksheets[0];
    lg(`  Sheet: "${ws.name}"`);

    // ‚îÄ‚îÄ STEP 5: Write header rows 1-4 ‚îÄ‚îÄ
    // Row 1: D1=Customer, I1=Prepare By
    ws.getRow(1).getCell(4).value=vCustomer||'';
    ws.getRow(1).getCell(9).value=vPrepBy||'';
    // Row 2: D2=OR No, I2=Approve By
    ws.getRow(2).getCell(4).value=vOrNo||'';
    ws.getRow(2).getCell(9).value=vAppBy||'';
    // Row 3: D3=Execution Location, I3=MRS NO (numeric if possible)
    ws.getRow(3).getCell(4).value=vExeLoc||'';
    ws.getRow(3).getCell(9).value=vMrsNo?(isNaN(vMrsNo)?vMrsNo:parseInt(vMrsNo)):'';
    // Row 4: D4=Request Date, I4=MRS Ver
    if(vReqDate){
      ws.getRow(4).getCell(4).value=new Date(vReqDate);
      ws.getRow(4).getCell(4).numFmt='dd-mmm-yy';
    }
    ws.getRow(4).getCell(9).value=vMrsVer||'';
    lg('‚úì Header rows 1‚Äì4 written','ok');

    // ‚îÄ‚îÄ STEP 6: Write data rows ‚îÄ‚îÄ
    lg('Writing data rows‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));
    let rowNum=mSR,sr=1;

    for(const [,entry] of parts){
      for(const {panel,qty} of entry.panels){
        const row=ws.getRow(rowNum);

        // A: SR ‚Äî format "001_15"
        row.getCell(mCA+1).value=String(sr).padStart(3,'0')+(vMrsNo?'_'+vMrsNo:'');

        // B: Make
        row.getCell(mCB+1).value=entry.make||'';

        // C: Type/Order No = Part Number
        row.getCell(mCC+1).value=entry.partNum;

        // D: Description
        row.getCell(mCD+1).value=entry.desc||'';

        // E: Request Date
        if(vReqDate){
          row.getCell(mCE+1).value=new Date(vReqDate);
          row.getCell(mCE+1).numFmt='dd-mmm-yy';
        }

        // F: Scope (FIXED ‚Äî was writing to wrong col before)
        row.getCell(mCF+1).value=vScope||'';

        // G: Section = panel name from BOM
        row.getCell(mCG+1).value=panel;

        // H: Lead Time (numeric weeks)
        row.getCell(mCH+1).value=vLeadWks?parseInt(vLeadWks):'';

        // I: Required Date
        if(vReqDt2){
          row.getCell(mCI+1).value=new Date(vReqDt2);
          row.getCell(mCI+1).numFmt='dd-mmm-yy';
        }

        // L: Exe. Loc.
        row.getCell(mCL+1).value=vExeLoc||'';

        // M: Customer
        row.getCell(mCM2+1).value=vCustomer||'';

        // N: OR No.
        row.getCell(mCN+1).value=vOrNo||'';

        // P: Qty (net of stock)
        row.getCell(mCP+1).value=qty;

        // Q: Unit for Qty
        const mCQ=ci('Q');
        row.getCell(mCQ+1).value=vUnitQty||'';

        row.commit();
        rowNum++;sr++;
      }
    }
    lg(`‚úì ${sr-1} rows written starting from row ${mSR}`,'ok');

    // ‚îÄ‚îÄ STEP 7: Save ‚îÄ‚îÄ
    lg('Saving‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));
    const out=await wb2.xlsx.writeBuffer();
    const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const name=(gv('exportName')||'MRS_Generated').replace(/[^a-zA-Z0-9_\-. ]/g,'_')+'.xlsx';
    saveAs(blob,name);
    lg(`‚úÖ Downloaded: ${name}`,'ok');
    btn.textContent='‚ö° Generate MRS';btn.disabled=false;

  }catch(err){
    console.error(err);
    lg('Error: '+err.message,'err');
    g('genBtn').textContent='‚ö° Generate MRS';
    g('genBtn').disabled=false;
  }
}

// ‚îÄ‚îÄ Dark Mode ‚îÄ‚îÄ
function toggleDark(){
  const d=document.body.classList.toggle('dark');
  g('dico').textContent=d?'‚òÄÔ∏è':'üåô';
  g('dlbl').textContent=d?'Light':'Dark';
  try{localStorage.setItem('wz-theme',d?'dark':'light');}catch(e){}
}
(function(){
  try{
    if(localStorage.getItem('wz-theme')==='dark'){
      document.body.classList.add('dark');
      g('dico').textContent='‚òÄÔ∏è';
      g('dlbl').textContent='Light';
    }
  }catch(e){}
})();
</script>
  <!-- Footer -->
  <footer style="background:var(--white);border-top:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 -1px 4px rgba(30,34,53,.05);">
    <div style="display:flex;align-items:center;gap:8px;">
      <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="8" fill="#2563eb"/>
        <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="16" cy="13" r="1.5" fill="white"/>
      </svg>
      <span style="font-size:.72rem;font-weight:700;font-family:'Syne',sans-serif;color:var(--text);">Workezz</span>
      <span style="font-size:.68rem;color:var(--muted);">‚Äî MRS Generator</span>
    </div>
    <div style="font-size:.68rem;color:var(--muted);">
      Designed & built by <strong style="color:var(--text2);">Krish Makwane</strong> &nbsp;¬∑&nbsp; MVP v2.0
    </div>
  </footer>

</body>
</html>
