<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workezz ‚Äî MRS Generator</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#f0f2f7;--white:#fff;--surface:#f7f8fb;--surface2:#eceef4;
  --border:#dde0ea;--border2:#c8ccda;
  --accent:#0f766e;--accent-l:#ccfbf1;--accent-h:#0d6760;
  --text:#1e2235;--text2:#4a5072;--muted:#8890aa;
  --orange:#ea580c;--orange-l:#fff7ed;--orange-b:#fed7aa;
  --teal:#14b8a6;--teal-l:#ccfbf1;--teal-b:#5eead4;
  --success:#15803d;--danger:#b91c1c;--danger-bg:#fee2e2;--danger-b:#fca5a5;
  --sh:0 1px 3px rgba(30,34,53,.07);--sh-md:0 4px 16px rgba(30,34,53,.09);
  --r:10px;--rs:6px;
  --xlteal:#BAEFEA;--xlheader:#d0e8f4;--xlsub:#e4eef8;--xlfl:#f0f0f0;--xlinput:#fffef0;
}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;height:52px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--sh-md);flex-shrink:0;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.25rem;letter-spacing:-.02em;}
.logo span{color:#2563eb;}
.logo-sub{font-size:.6rem;color:var(--muted);font-weight:500;letter-spacing:.06em;text-transform:uppercase;}
.home-btn{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:var(--rs);font-size:.76rem;font-weight:600;color:var(--text2);background:var(--surface2);border:1px solid var(--border2);cursor:pointer;text-decoration:none;transition:all .15s;}
.home-btn:hover{background:var(--accent-l);color:var(--accent);border-color:var(--accent);}

/* ‚îÄ‚îÄ DARK TOGGLE ‚îÄ‚îÄ */
.dtgl{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:4px 11px;cursor:pointer;font-size:.72rem;font-weight:600;color:var(--text2);transition:all .2s;font-family:'IBM Plex Sans',sans-serif;}
.dtgl:hover{background:var(--accent-l);color:var(--accent);border-color:var(--accent);}

/* ‚îÄ‚îÄ STEPPER ‚îÄ‚îÄ */
.stepper{background:var(--white);border-bottom:1px solid var(--border);padding:0 20px;height:44px;display:flex;align-items:center;gap:6px;flex-shrink:0;}
.step{display:flex;align-items:center;gap:7px;padding:4px 12px;border-radius:100px;font-size:.72rem;font-weight:600;color:var(--muted);transition:all .2s;white-space:nowrap;}
.step.active{background:var(--accent-l);color:var(--accent);}
.step.done{color:var(--success);}
.step-num{width:18px;height:18px;border-radius:50%;background:var(--border2);color:#fff;display:flex;align-items:center;justify-content:center;font-size:.6rem;font-weight:700;}
.step.active .step-num{background:var(--accent);}
.step.done .step-num{background:var(--success);}
.sarr{color:var(--border2);}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;flex:1;overflow:hidden;}
.screen.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:5px;padding:7px 14px;border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:.78rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;}
.btn-primary{background:var(--accent);color:#fff;}
.btn-primary:hover{background:var(--accent-h);transform:translateY(-1px);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;}
.btn-success{background:var(--success);color:#fff;}
.btn-success:hover{background:#166534;transform:translateY(-1px);}
.btn-success:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;}
.btn-secondary{background:var(--white);color:var(--text2);border:1px solid var(--border2);}
.btn-secondary:hover{background:var(--surface2);}
.btn-do{background:transparent;color:var(--danger);border:1px solid var(--danger-b);}
.btn-do:hover{background:var(--danger-bg);}
.btn-full{width:100%;}
.btn-lg{padding:10px 20px;font-size:.88rem;}
.btn-sm{padding:3px 9px;font-size:.7rem;}

/* ‚ïê‚ïê‚ïê‚ïê SCREEN 1 ‚Äî 4-col grid ‚ïê‚ïê‚ïê‚ïê */
.s1-body{
  display:grid;
  grid-template-columns:1fr 1fr;
  flex:1;
  overflow:hidden;
}
/* Left column: EPLAN upload + EPLAN mapping */
.s1-left{
  display:grid;
  grid-template-rows:auto 1fr;
  border-right:1px solid var(--border);
  overflow:hidden;
}
/* Right column: MRS upload + MRS mapping */
.s1-right{
  display:grid;
  grid-template-rows:auto 1fr;
  overflow:hidden;
}

.s1-upload-panel{
  padding:14px 18px;
  border-bottom:1px solid var(--border);
  display:flex;
  flex-direction:column;
  gap:10px;
  background:var(--surface);
}
.s1-map-panel{
  padding:14px 18px;
  display:flex;
  flex-direction:column;
  gap:10px;
  overflow-y:auto;
}

.sec-title{font-family:'Syne',sans-serif;font-size:.86rem;font-weight:700;display:flex;align-items:center;gap:7px;}
.sec-sub{font-size:.69rem;color:var(--muted);line-height:1.5;margin-top:2px;}

.upzone{border:2px dashed var(--border2);border-radius:var(--r);padding:16px 12px;text-align:center;cursor:pointer;transition:all .2s;background:var(--white);}
.upzone:hover{border-color:var(--accent);background:var(--accent-l);}
.upzone.ep{border-color:rgba(234,88,12,.35);background:var(--orange-l);}
.upzone.ep:hover{border-color:var(--orange);}
.upzone.ms{border-color:rgba(20,184,166,.35);background:var(--teal-l);}
.upzone.ms:hover{border-color:var(--teal);}
.uz-ico{font-size:1.4rem;display:block;margin-bottom:3px;}
.uz-txt{font-size:.74rem;color:var(--text2);}
.uz-txt strong{color:var(--accent);}
.ep .uz-txt strong{color:var(--orange);}
.ms .uz-txt strong{color:var(--teal);}
.uz-sub{font-size:.62rem;color:var(--muted);margin-top:2px;}

.mchip{display:flex;align-items:center;gap:9px;border-radius:var(--rs);padding:8px 11px;background:var(--teal-l);border:1px solid var(--teal-b);}
.mchip-ico{width:28px;height:28px;border-radius:4px;background:var(--teal);color:#fff;font-size:.58rem;font-weight:700;font-family:'IBM Plex Mono',monospace;display:flex;align-items:center;justify-content:center;flex-shrink:0;}
.mchip-name{font-size:.74rem;font-weight:600;color:var(--teal);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;flex:1;min-width:0;}
.mchip-size{font-size:.62rem;color:var(--muted);}

.eplan-count{font-size:.67rem;font-weight:600;color:var(--muted);padding:2px 9px;border-radius:100px;background:var(--surface2);border:1px solid var(--border);}

/* mapping cards */
.mcard{background:var(--white);border:1px solid var(--border);border-radius:var(--r);overflow:hidden;box-shadow:var(--sh);}
.mcard-h{padding:9px 13px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;}
.mcard-h h4{font-family:'Syne',sans-serif;font-size:.8rem;font-weight:700;}
.mcard-b{padding:10px 13px;max-height:260px;overflow-y:auto;}
.cmt{width:100%;border-collapse:collapse;}
.cmt td{padding:4px 6px;font-size:.72rem;vertical-align:middle;border-bottom:1px solid var(--border);}
.cmt tr:last-child td{border-bottom:none;}
.cmt td:first-child{color:var(--text2);font-weight:500;white-space:nowrap;}
.ci{width:44px;padding:3px 7px;border:1px solid var(--border2);border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:.74rem;text-align:center;outline:none;background:var(--white);color:var(--text);}
.ci:focus{border-color:var(--accent);}
.ci-num{width:54px;}

.s1-footer{padding:11px 20px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;gap:10px;flex-shrink:0;}

/* ‚ïê‚ïê‚ïê‚ïê SCREEN 2 ‚Äî COMMON FIELDS ‚ïê‚ïê‚ïê‚ïê */
.s2-fields-body{flex:1;overflow-y:auto;padding:20px 24px;}
.s2-fields-inner{max-width:860px;margin:0 auto;display:flex;flex-direction:column;gap:16px;}
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.fitem{display:flex;flex-direction:column;gap:4px;}
.flabel{font-size:.68rem;font-weight:600;color:var(--text2);letter-spacing:.03em;}
.finput{padding:7px 11px;border:1px solid var(--border2);border-radius:var(--rs);font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;color:var(--text);background:var(--white);outline:none;transition:border-color .15s;}
.finput:focus{border-color:var(--accent);box-shadow:0 0 0 2px rgba(15,118,110,.1);}
.finput::placeholder{color:var(--muted);}
select.finput{cursor:pointer;}
.s2f-footer{padding:11px 20px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}
body.dark .finput{background:var(--surface2);color:var(--text);}

/* ‚ïê‚ïê‚ïê‚ïê SCREEN 3 ‚Äî PREVIEW ‚ïê‚ïê‚ïê‚ïê */
.s2-bar{padding:9px 18px;background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;flex-wrap:wrap;}
.s2-bar h3{font-family:'Syne',sans-serif;font-size:.86rem;font-weight:700;}
.s2-hint{font-size:.7rem;color:var(--muted);}
.s2-scroll{flex:1;overflow:auto;padding:14px 18px;}
.s2-footer{padding:11px 20px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center;flex-shrink:0;}

/* ‚îÄ‚îÄ EXCEL PREVIEW TABLE ‚îÄ‚îÄ */
.xl-wrap{display:inline-block;min-width:100%;}
.xl{border-collapse:collapse;font-size:.72rem;font-family:'IBM Plex Sans',sans-serif;table-layout:fixed;}
.xl td,.xl th{border:1px solid #b8c4d8;padding:2px 5px;vertical-align:middle;overflow:hidden;}
.r-teal td{background:#BAEFEA;}
.r-hdr td{background:#d0e8f4;font-weight:700;text-align:center;font-size:.7rem;}
.r-sub td{background:#e4eef8;font-weight:600;text-align:center;font-size:.69rem;}
.r-fl td{background:#f0f0f0;color:#999;font-weight:700;text-align:center;font-size:.68rem;}
.r-inp td{background:#fffef0;}
.r-sample td{background:#fafafa;color:#bbb;font-size:.66rem;text-align:center;}
.ck,.co,.cr{width:7px!important;min-width:7px!important;max-width:7px!important;background:#e0e4ec!important;padding:0!important;}
.r-teal .ck,.r-teal .co,.r-teal .cr{background:#9addd7!important;}
.rn{width:22px;min-width:22px;background:#e8ecf4;color:#8890aa;font-size:.62rem;text-align:center;font-weight:600;font-family:'IBM Plex Mono',monospace;border-color:#ccd1e0;}
.xi{width:100%;border:none;outline:none;background:transparent;font-family:'IBM Plex Sans',sans-serif;font-size:.71rem;color:var(--text);text-align:center;padding:0;min-width:0;}
.xi:focus{background:rgba(255,220,0,.25);border-radius:2px;}
.xi.xl{text-align:left;}
.xi[type=date]{font-size:.67rem;}
.xauto{color:#0f766e;font-size:.67rem;font-style:italic;text-align:center;display:block;}
.xempty{color:#ccc;font-size:.63rem;font-style:italic;text-align:center;display:block;}
.xfrom{color:#9a6bbd;font-size:.63rem;font-style:italic;text-align:center;display:block;}
.r-colhdr th{background:#1e3a5f;color:#fff;font-size:.64rem;font-weight:700;text-align:center;padding:4px 3px;border-color:#2d4f7a;white-space:nowrap;}
.r-colhdr .ck,.r-colhdr .co,.r-colhdr .cr{background:#152d4a!important;}
.r-colhdr .rn{background:#1a3358;color:#6b8ab0;}

/* ‚ïê‚ïê‚ïê‚ïê SCREEN 4 ‚Äî GENERATE ‚ïê‚ïê‚ïê‚ïê */
.s3-body{flex:1;display:flex;align-items:center;justify-content:center;padding:28px;}
.gcard{background:var(--white);border:1px solid var(--border);border-radius:var(--r);padding:30px 34px;width:100%;max-width:480px;box-shadow:var(--sh-md);text-align:center;}
.gcard h2{font-family:'Syne',sans-serif;font-size:1.15rem;font-weight:800;margin-bottom:5px;}
.gcard p{font-size:.74rem;color:var(--muted);line-height:1.65;margin-bottom:18px;}
.fn-label{font-size:.66rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);display:block;margin-bottom:5px;text-align:left;}
.fn-wrap{display:flex;align-items:center;border:1px solid var(--border2);border-radius:var(--rs);overflow:hidden;margin-bottom:14px;}
.fn-input{flex:1;border:none;outline:none;padding:8px 11px;font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;color:var(--text);}
.fn-ext{padding:8px 11px;font-size:.72rem;font-weight:600;color:var(--muted);background:var(--surface2);border-left:1px solid var(--border);}
.slog{background:var(--surface2);border:1px solid var(--border);border-radius:var(--rs);padding:10px 12px;max-height:130px;overflow-y:auto;text-align:left;margin-bottom:14px;}
.ll{font-size:.7rem;font-family:'IBM Plex Mono',monospace;color:var(--text2);padding:1px 0;line-height:1.5;}
.ll.ok{color:var(--success);}
.ll.err{color:var(--danger);}
.ll.info{color:var(--accent);}

/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
body.dark{--bg:#13151f;--white:#1e2235;--surface:#252840;--surface2:#2d3148;--border:#363b58;--border2:#444968;--accent:#14b8a6;--accent-l:#0f2a28;--accent-h:#0d9488;--text:#e8eaf2;--text2:#9ba3c0;--muted:#6b7494;--orange-l:#251810;--teal-l:#0e2420;--teal-b:#1a5c52;--xlteal:#1a4a45;--xlheader:#1a2d42;--xlsub:#1e2a40;--xlfl:#252840;--xlinput:#26240e;}
body.dark .ci,.dark .fn-input{background:var(--surface2);color:var(--text);}
body.dark .xl td,.dark .xl th{border-color:#2d3a55;}
body.dark .r-teal td{background:var(--xlteal);}
body.dark .r-hdr td{background:var(--xlheader);}
body.dark .r-sub td{background:var(--xlsub);}
body.dark .r-fl td{background:var(--xlfl);color:#555;}
body.dark .r-inp td{background:var(--xlinput);}
body.dark .r-sample td{background:#1e2030;}
body.dark .ck,.dark .co,.dark .cr{background:#1a1e2e!important;}
body.dark .r-teal .ck,.dark .r-teal .co,.dark .r-teal .cr{background:#0e2e2a!important;}
body.dark .rn{background:#1a1e2e;color:#444968;border-color:#2d3a55;}
body.dark .xi{color:var(--text);}
body.dark .xi:focus{background:rgba(255,200,0,.1);}
</style>
</head>
<body>

<!-- ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ -->
<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <div>
      <div class="logo">Work<span>ezz</span></div>
      <div class="logo-sub">MRS Generator</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:9px;">
    <button class="dtgl" onclick="toggleDark()"><span id="dico">üåô</span><span id="dlbl">Dark</span></button>
    <a class="home-btn" href="index.html">
      <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
  </div>
</header>

<!-- ‚îÄ‚îÄ STEPPER ‚îÄ‚îÄ -->
<div class="stepper">
  <div class="step active" id="step1"><div class="step-num">1</div>Import &amp; Mapping</div>
  <span class="sarr">‚Ä∫</span>
  <div class="step" id="step2"><div class="step-num">2</div>Common Fields</div>
  <span class="sarr">‚Ä∫</span>
  <div class="step" id="step3"><div class="step-num">3</div>Preview</div>
  <span class="sarr">‚Ä∫</span>
  <div class="step" id="step4"><div class="step-num">4</div>Generate</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 1 ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen active" id="screen1">
  <div class="s1-body">

    <!-- ‚îÄ‚îÄ LEFT: EPLAN Upload + EPLAN Column Mapping ‚îÄ‚îÄ -->
    <div class="s1-left">

      <!-- EPLAN Upload -->
      <div class="s1-upload-panel">
        <div>
          <div class="sec-title">
            <span style="width:24px;height:24px;background:var(--orange-l);border:1px solid var(--orange-b);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.8rem;">üìÇ</span>
            EPLAN Files
          </div>
          <div class="sec-sub">One or more EPLAN export files ‚Äî part numbers, makes, descriptions, quantities.</div>
        </div>
        <input type="file" id="eplanInput" accept=".xls,.xlsx" multiple style="display:none" onchange="handleEplan(this)">
        <div class="upzone ep" onclick="document.getElementById('eplanInput').click()" ondragover="event.preventDefault()" ondrop="dropEplan(event)">
          <span class="uz-ico">üìÇ</span>
          <div class="uz-txt"><strong>Click to browse</strong> or drag &amp; drop</div>
          <div class="uz-sub">Multiple .xls / .xlsx</div>
        </div>
        <div style="display:flex;gap:7px;align-items:center;">
          <button class="btn btn-primary btn-sm" onclick="document.getElementById('eplanInput').click()">Ôºã Add Files</button>
          <span class="eplan-count" id="eplanCount">0 files</span>
        </div>
      </div>

      <!-- EPLAN Column Mapping -->
      <div class="s1-map-panel">
        <div>
          <div class="sec-title" style="font-size:.78rem;">‚öôÔ∏è EPLAN Column Mapping</div>
          <div class="sec-sub">Which columns in the EPLAN file hold each field.</div>
        </div>
        <div class="mcard">
          <div class="mcard-h"><span>üìÇ</span><h4>EPLAN ‚Äî Source Columns</h4></div>
          <div class="mcard-b">
            <table class="cmt">
              <tr><td>Part Number</td><td><input class="ci" id="eCP" value="B" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Description</td><td><input class="ci" id="eCD" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Make / Brand</td><td><input class="ci" id="eCM" value="A" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Quantity</td><td><input class="ci" id="eCQ" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Data Start Row</td><td><input class="ci ci-num" id="eSR" value="2" type="number" min="1"></td></tr>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /s1-left -->

    <!-- ‚îÄ‚îÄ RIGHT: MRS Upload + MRS Column Mapping ‚îÄ‚îÄ -->
    <div class="s1-right">

      <!-- MRS Upload -->
      <div class="s1-upload-panel">
        <div>
          <div class="sec-title">
            <span style="width:24px;height:24px;background:var(--teal-l);border:1px solid var(--teal-b);border-radius:5px;display:flex;align-items:center;justify-content:center;font-size:.8rem;">üìã</span>
            Blank MRS Master
          </div>
          <div class="sec-sub">Your blank MRS template ‚Äî all formatting, merges and headers will be preserved.</div>
        </div>
        <input type="file" id="masterInput" accept=".xls,.xlsx" style="display:none" onchange="handleMaster(this)">
        <div id="mEmptyZone" class="upzone ms" onclick="document.getElementById('masterInput').click()">
          <span class="uz-ico">üìã</span>
          <div class="uz-txt"><strong>Click to upload</strong></div>
          <div class="uz-sub">Single .xls / .xlsx</div>
        </div>
        <div id="mChip" class="mchip" style="display:none;">
          <div class="mchip-ico" id="mExt">XLS</div>
          <div style="flex:1;min-width:0;"><div class="mchip-name" id="mName">‚Äî</div><div class="mchip-size" id="mSize">‚Äî</div></div>
          <button class="btn btn-do btn-sm" onclick="clearMaster()">‚úï</button>
        </div>
      </div>

      <!-- MRS Column Mapping -->
      <div class="s1-map-panel">
        <div>
          <div class="sec-title" style="font-size:.78rem;">‚öôÔ∏è MRS Column Mapping</div>
          <div class="sec-sub">Which columns in the MRS Master hold each field.</div>
        </div>
        <div class="mcard">
          <div class="mcard-h"><span>üìã</span><h4>MRS Master ‚Äî Target Columns</h4><span style="font-size:.63rem;color:var(--muted);margin-left:auto;">pre-filled from Master</span></div>
          <div class="mcard-b">
            <table class="cmt">
              <tr><td>ITEM Req ID (SR)</td><td><input class="ci" id="mCA" value="A" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Make</td><td><input class="ci" id="mCB" value="B" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Type/Order No</td><td><input class="ci" id="mCC" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Description</td><td><input class="ci" id="mCD" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Request Date (Col E)</td><td><input class="ci" id="mCE" value="E" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Section / Panel (Col G)</td><td><input class="ci" id="mCG" value="G" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Lead Time (Col H)</td><td><input class="ci" id="mCH" value="H" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Required Date (Col I)</td><td><input class="ci" id="mCI" value="I" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Exe. Loc. (Col L)</td><td><input class="ci" id="mCL" value="L" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Customer (Col M)</td><td><input class="ci" id="mCM" value="M" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>OR No. (Col N)</td><td><input class="ci" id="mCN" value="N" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Qty (Col P)</td><td><input class="ci" id="mCP" value="P" maxlength="2" oninput="this.value=this.value.toUpperCase()"></td></tr>
              <tr><td>Data Start Row</td><td><input class="ci ci-num" id="mSR" value="8" type="number" min="1"></td></tr>
            </table>
          </div>
        </div>
      </div>

    </div><!-- /s1-right -->

  </div><!-- /s1-body -->

  <div class="s1-footer">
    <span id="s1hint" style="font-size:.71rem;color:var(--muted);">Upload EPLAN + MRS Master to continue</span>
    <button class="btn btn-primary btn-lg" id="nextBtn1" onclick="goTo(2)" disabled>Next: Common Fields ‚Üí</button>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 2 ‚Äî COMMON FIELDS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen2">
  <div class="s2-fields-body">
    <div class="s2-fields-inner">

      <!-- MRS Document Info -->
      <div class="mcard">
        <div class="mcard-h"><span>üìÑ</span><h4>MRS Document Info</h4></div>
        <div class="mcard-b" style="max-height:none;overflow-y:visible;">
          <div class="fgrid">
            <div class="fitem">
              <label class="flabel">MRS Number</label>
              <input class="finput" id="f_mrsno" placeholder="e.g. MRS-2526-001">
            </div>
            <div class="fitem">
              <label class="flabel">MRS Version / Rev</label>
              <input class="finput" id="f_mrsver" placeholder="e.g. R0, R1, A">
            </div>
            <div class="fitem">
              <label class="flabel">Document / Drawing No</label>
              <input class="finput" id="f_docno" placeholder="e.g. FSL/2526/MUM/OR057" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Project / Job Title</label>
              <input class="finput" id="f_proj" placeholder="e.g. Welspun Tubular" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Client / Customer</label>
              <input class="finput" id="f_client" placeholder="Client name" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Site / Location</label>
              <input class="finput" id="f_site" placeholder="Site location" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Prepared By</label>
              <input class="finput" id="f_prep" placeholder="Your name" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Approved By</label>
              <input class="finput" id="f_appby" placeholder="Approver name" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Rev No.</label>
              <input class="finput" id="f_revno" placeholder="e.g. 01" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Date</label>
              <input class="finput" id="f_date" type="date" oninput="syncPreview()">
            </div>
          </div>
        </div>
      </div>

      <!-- Row-Level Common Values -->
      <div class="mcard">
        <div class="mcard-h"><span>üîÅ</span><h4>Row-Level Common Values</h4><span style="font-size:.63rem;color:var(--muted);margin-left:auto;">Applied to every data row in output</span></div>
        <div class="mcard-b" style="max-height:none;overflow-y:visible;">
          <div class="fgrid">
            <div class="fitem">
              <label class="flabel">Request Date</label>
              <input class="finput" id="f_reqdate" type="date" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Lead Time (weeks)</label>
              <select class="finput" id="f_leadtime" onchange="syncPreview()">
                <option value="">‚Äî select ‚Äî</option>
                <option value="1">1 Week</option>
                <option value="2">2 Weeks</option>
                <option value="3">3 Weeks</option>
                <option value="4">4 Weeks</option>
                <option value="5">5 Weeks</option>
                <option value="6">6 Weeks</option>
                <option value="7">7 Weeks</option>
                <option value="8">8 Weeks</option>
                <option value="9">9 Weeks</option>
                <option value="10">10 Weeks</option>
              </select>
            </div>
            <div class="fitem">
              <label class="flabel">OR No.</label>
              <input class="finput" id="f_orno" placeholder="e.g. OR-001" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Exe. Loc.</label>
              <input class="finput" id="f_exeloc" placeholder="e.g. GON" oninput="syncPreview()">
            </div>
            <div class="fitem">
              <label class="flabel">Scope</label>
              <input class="finput" id="f_scope" placeholder="e.g. SALES" oninput="syncPreview()">
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
  <div class="s2f-footer">
    <button class="btn btn-secondary" onclick="goTo(1)">‚Äπ Back</button>
    <button class="btn btn-primary btn-lg" onclick="goToPreview()">Next: Preview ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 3 ‚Äî PREVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen3">
  <div class="s2-bar">
    <h3>üìã MRS Preview ‚Äî Fill in Common Fields</h3>
    <span class="s2-hint">Rows 1‚Äì7 replicate your master's structure ¬∑ Row 8 = your common values applied to every exported row ¬∑ Grey = auto / from EPLAN</span>
  </div>

  <div class="s2-scroll">
    <div class="xl-wrap">
      <table class="xl" id="xlTable"><!-- built by JS --></table>
    </div>
  </div>

  <div class="s2-footer">
    <button class="btn btn-secondary" onclick="goTo(2)">‚Äπ Back</button>
    <button class="btn btn-primary btn-lg" onclick="goTo(4)">Next: Generate ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SCREEN 4 ‚Äî GENERATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="screen" id="screen4">
  <div class="s3-body">
    <div class="gcard">
      <div style="font-size:2rem;margin-bottom:9px;">‚ö°</div>
      <h2>Generate MRS</h2>
      <p>EPLAN parts will be extracted and written into your blank MRS Master from row 8 onwards ‚Äî with common fields applied to every row.</p>
      <div>
        <div class="fn-label">Output File Name</div>
        <div class="fn-wrap"><input class="fn-input" id="exportName" value="MRS_Generated" placeholder="MRS_Generated"><span class="fn-ext">.xlsx</span></div>
      </div>
      <div class="slog" id="slog"><div class="ll info">‚ñ∏ Ready ‚Äî click below to generate</div></div>
      <button class="btn btn-success btn-full btn-lg" id="genBtn" onclick="generate()">‚ö° Generate MRS</button>
      <div style="margin-top:9px;"><button class="btn btn-secondary btn-full" onclick="goTo(3)">‚Äπ Back to Preview</button></div>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let eplanFiles=[], masterFile=null, dragSrc=null;

function ci(l){return l.toUpperCase().charCodeAt(0)-65;}
function fmtSz(b){if(b<1024)return b+' B';if(b<1048576)return(b/1024).toFixed(1)+' KB';return(b/1048576).toFixed(1)+' MB';}
function today(){return new Date().toISOString().slice(0,10);}
function addDays(dateStr,days){if(!dateStr||!days)return'';const d=new Date(dateStr);d.setDate(d.getDate()+parseInt(days));return d.toISOString().slice(0,10);}

// ‚îÄ‚îÄ EPLAN ‚îÄ‚îÄ
function handleEplan(inp){Array.from(inp.files).forEach(f=>{if(!eplanFiles.find(e=>e.name===f.name))eplanFiles.push(f);});inp.value='';renderEplan();chk();}
function dropEplan(e){e.preventDefault();Array.from(e.dataTransfer.files).filter(f=>f.name.match(/\.xlsx?$/i)).forEach(f=>{if(!eplanFiles.find(x=>x.name===f.name))eplanFiles.push(f);});renderEplan();chk();}
function removeEplan(name){eplanFiles=eplanFiles.filter(f=>f.name!==name);renderEplan();chk();}
function renderEplan(){
  const n=eplanFiles.length;
  document.getElementById('eplanCount').textContent=n+' file'+(n!==1?'s':'');
}

// ‚îÄ‚îÄ MASTER ‚îÄ‚îÄ
function handleMaster(inp){
  if(!inp.files.length)return;masterFile=inp.files[0];inp.value='';
  const ext=masterFile.name.split('.').pop().toUpperCase();
  document.getElementById('mEmptyZone').style.display='none';
  document.getElementById('mChip').style.display='flex';
  document.getElementById('mExt').textContent=ext;
  document.getElementById('mName').textContent=masterFile.name;
  document.getElementById('mSize').textContent=fmtSz(masterFile.size);
  chk();
}
function clearMaster(){
  masterFile=null;
  document.getElementById('mEmptyZone').style.display='';
  document.getElementById('mChip').style.display='none';
  document.getElementById('masterInput').value='';
  chk();
}

function chk(){
  const ok=eplanFiles.length>0&&masterFile!==null;
  document.getElementById('nextBtn1').disabled=!ok;
  document.getElementById('s1hint').textContent=
    (!eplanFiles.length&&!masterFile)?'Upload EPLAN + MRS Master to continue':
    !eplanFiles.length?'Add at least 1 EPLAN file':
    !masterFile?'Upload blank MRS Master to continue':
    `‚úì ${eplanFiles.length} EPLAN file(s) + master ready`;
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function goTo(n){
  document.querySelectorAll('.screen').forEach((s,i)=>s.classList.toggle('active',i===n-1));
  document.querySelectorAll('.step').forEach((s,i)=>{
    s.classList.remove('active','done');
    if(i+1===n)s.classList.add('active');
    else if(i+1<n)s.classList.add('done');
  });
}
function goToPreview(){goTo(3);buildPreview();}

// ‚îÄ‚îÄ SYNC PREVIEW ‚Äî called on every Screen 2 input change ‚îÄ‚îÄ
function syncPreview(){
  // Only update if preview table already exists (screen 3 visited)
  if(!document.getElementById('xlTable').innerHTML) return;
  calcI();
}

// ‚îÄ‚îÄ BUILD PREVIEW ‚îÄ‚îÄ
const CW={A:64,B:83,C:145,D:250,E:72,F:72,G:80,H:80,I:80,J:80,K:7,L:60,M:145,N:80,O:7,P:51,Q:55,R:6};

function buildPreview(){
  const tbl=document.getElementById('xlTable');

  let h='<colgroup><col style="width:22px">';
  ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R'].forEach(c=>{
    h+=`<col style="width:${CW[c]}px">`;
  });
  h+='</colgroup>';

  h+='<tr class="r-colhdr"><th class="rn">Row</th>';
  ['A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R'].forEach((c)=>{
    const sp=(c==='K'||c==='O'||c==='R');
    h+=`<th class="${sp?'ck co cr':''}">${sp?'':c}</th>`;
  });
  h+='</tr>';

  const infoRows=[
    {lblD:'Project / Job Title',  idD:'f_proj',   idI:'f_docno',  lblI:'Document / Drawing No'},
    {lblD:'Client / Customer',    idD:'f_client', idI:'f_site',   lblI:'Site / Location'},
    {lblD:'Prepared By',          idD:'f_prep',   idI:'f_revno',  lblI:'Rev No.'},
    {lblD:'Date',                 idD:'f_date',   idI:'f_appby',  lblI:'Approved By', dateD:true},
  ];

  infoRows.forEach((row,ri)=>{
    const rn=ri+1;
    // Get live values from Screen 2
    const valD=document.getElementById(row.idD)?.value||'';
    const valI=document.getElementById(row.idI)?.value||'';
    h+=`<tr class="r-teal">`;
    h+=`<td class="rn">${rn}</td>`;
    h+=`<td colspan="3" style="font-weight:600;font-size:.68rem;color:#0f5c58;padding:2px 6px;">${row.lblD}</td>`;
    h+=`<td colspan="4"><span class="xauto" id="prev_${row.idD}">${valD||'‚Äî'}</span></td>`;
    h+=`<td></td>`;
    h+=`<td colspan="2"><span class="xauto" id="prev_${row.idI}">${valI||'‚Äî'}</span></td>`;
    h+=`<td class="ck"></td>`;
    h+=`<td></td><td></td><td></td>`;
    h+=`<td class="co"></td>`;
    h+=`<td colspan="2"></td>`;
    h+=`<td class="cr"></td>`;
    h+=`</tr>`;
  });

  h+=`<tr class="r-hdr"><td class="rn">5</td>
    <td>ITEM Req ID</td><td>Make</td><td>Type/Order No</td><td>DESCRIPTION</td>
    <td>Request</td><td>Scope</td><td>Section</td><td>Standard</td>
    <td>Required</td><td>Available</td>
    <td class="ck"></td>
    <td>Exe. Loc.</td><td>Customer</td><td>OR No.</td>
    <td class="co"></td>
    <td>Project</td><td>Unit For Qty</td>
    <td class="cr"></td>
  </tr>`;

  h+=`<tr class="r-sub"><td class="rn">6</td>
    <td></td><td></td><td></td><td></td>
    <td>Date</td><td>Lead Time</td>
    <td class="ck"></td>
    <td></td><td></td><td></td>
    <td class="co"></td>
    <td>Qty.</td><td></td>
    <td class="cr"></td>
  </tr>`;

  h+=`<tr class="r-fl"><td class="rn">7</td>
    <td>FL</td><td>FL</td><td>FL</td><td>FL</td>
    <td>FL</td><td>FL</td><td>FL</td><td>FL</td>
    <td>FL</td><td>FL</td>
    <td class="ck"></td>
    <td>FL</td><td>FL</td><td>FL</td>
    <td class="co"></td>
    <td>FL</td><td>FL</td>
    <td class="cr"></td>
  </tr>`;

  // Row 8 ‚Äî shows live values from Screen 2
  const vE=document.getElementById('f_reqdate')?.value||'';
  const vH=document.getElementById('f_leadtime')?.value||'';
  const vScope=document.getElementById('f_scope')?.value||'';
  const vL=document.getElementById('f_exeloc')?.value||'';
  const vM=document.getElementById('f_client')?.value||'';
  const vN=document.getElementById('f_orno')?.value||'';
  const vI=addDays(vE,vH?parseInt(vH)*7:0);

  h+=`<tr class="r-inp"><td class="rn" style="font-weight:700;color:var(--accent);">8</td>
    <td><span class="xfrom">SR# auto</span></td>
    <td><span class="xfrom">from EPLAN</span></td>
    <td><span class="xfrom">from EPLAN</span></td>
    <td><span class="xfrom">from EPLAN</span></td>
    <td><span class="xauto" id="v_E_show">${vE||'‚Äî'}</span></td>
    <td><span class="xauto" id="v_scope_show">${vScope||'‚Äî'}</span></td>
    <td><span class="xfrom">per panel</span></td>
    <td><span class="xauto" id="v_H_show">${vH?(vH+' wk'):'‚Äî'}</span></td>
    <td><span class="xauto" id="v_I_preview">${vI||'= Req Date + Lead Time'}</span></td>
    <td><span class="xempty">‚Äî fill after</span></td>
    <td class="ck"></td>
    <td><span class="xauto" id="v_L_show">${vL||'‚Äî'}</span></td>
    <td><span class="xauto" id="v_M_show">${vM||'‚Äî'}</span></td>
    <td><span class="xauto" id="v_N_show">${vN||'‚Äî'}</span></td>
    <td class="co"></td>
    <td><span class="xfrom">from EPLAN qty</span></td>
    <td><span class="xempty">‚Äî fill after</span></td>
    <td class="cr"></td>
  </tr>`;

  for(let i=0;i<3;i++){
    h+=`<tr class="r-sample"><td class="rn" style="color:#ccc">${9+i}</td>
      <td>${i+1}</td>
      <td style="text-align:left">‚Äî Make ‚Äî</td>
      <td style="text-align:left;font-family:monospace">‚Äî Part No ‚Äî</td>
      <td style="text-align:left">‚Äî Description from EPLAN ‚Äî</td>
      <td>‚Üë date</td><td></td><td>‚Üë section</td><td>‚Üë lead</td>
      <td>‚Üë auto</td><td></td>
      <td class="ck"></td>
      <td>‚Üë</td><td>‚Üë</td><td>‚Üë</td>
      <td class="co"></td>
      <td style="font-weight:600">qty</td><td></td>
      <td class="cr"></td>
    </tr>`;
  }

  tbl.innerHTML=h;
}

// calcI ‚Äî live-updates row 8 + info rows in preview when Screen 2 fields change
function calcI(){
  const e=document.getElementById('f_reqdate')?.value||'';
  const hv=document.getElementById('f_leadtime')?.value||'';
  const days=hv?parseInt(hv)*7:0;
  const result=addDays(e,days);
  const set=(id,val)=>{const el=document.getElementById(id);if(el)el.textContent=val||'‚Äî';};
  set('v_E_show',e);
  set('v_H_show',hv?(hv+' wk'):'');
  set('v_scope_show',document.getElementById('f_scope')?.value);
  set('v_L_show',document.getElementById('f_exeloc')?.value);
  set('v_M_show',document.getElementById('f_client')?.value);
  set('v_N_show',document.getElementById('f_orno')?.value);
  const iEl=document.getElementById('v_I_preview');
  if(iEl)iEl.textContent=result||'= Req Date + Lead Time';
  // Update info rows
  ['f_proj','f_docno','f_client','f_site','f_prep','f_revno','f_date','f_appby'].forEach(id=>{
    const el=document.getElementById('prev_'+id);
    if(el)el.textContent=document.getElementById(id)?.value||'‚Äî';
  });
}

// ‚îÄ‚îÄ READ EXCEL ‚îÄ‚îÄ
function readXL(file){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=e=>{
      try{
        const wb=XLSX.read(e.target.result,{type:'array'});
        const ws=wb.Sheets[wb.SheetNames[0]];
        res(XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:true}));
      }catch(err){console.error(err);res([]);}
    };
    r.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ LOG ‚îÄ‚îÄ
function lg(msg,type=''){
  const el=document.getElementById('slog');
  const cls={ok:'ll ok',err:'ll err',info:'ll info'}[type]||'ll';
  el.innerHTML+=`<div class="${cls}">‚ñ∏ ${msg}</div>`;
  el.scrollTop=el.scrollHeight;
}

// ‚îÄ‚îÄ GENERATE ‚îÄ‚îÄ
async function generate(){
  const btn=document.getElementById('genBtn');
  btn.disabled=true;btn.textContent='Generating‚Ä¶';
  document.getElementById('slog').innerHTML='';
  await new Promise(r=>setTimeout(r,40));

  try{
    const eCP=ci(document.getElementById('eCP').value||'B');
    const eCD=ci(document.getElementById('eCD').value||'C');
    const eCM=ci(document.getElementById('eCM').value||'A');
    const eCQ=ci(document.getElementById('eCQ').value||'D');
    const eSR=parseInt(document.getElementById('eSR').value)||2;
    const mCA=ci(document.getElementById('mCA').value||'A');
    const mCB=ci(document.getElementById('mCB').value||'B');
    const mCC=ci(document.getElementById('mCC').value||'C');
    const mCD=ci(document.getElementById('mCD').value||'D');
    const mCE=ci(document.getElementById('mCE').value||'E');
    const mCG=ci(document.getElementById('mCG').value||'G');
    const mCH=ci(document.getElementById('mCH').value||'H');
    const mCI=ci(document.getElementById('mCI').value||'I');
    const mCL=ci(document.getElementById('mCL').value||'L');
    const mCM2=ci(document.getElementById('mCM').value||'M');
    const mCN=ci(document.getElementById('mCN').value||'N');
    const mCP=ci(document.getElementById('mCP').value||'P');
    const mSR=parseInt(document.getElementById('mSR').value)||8;

    const vE=document.getElementById('f_reqdate')?.value||'';
    const vH=document.getElementById('f_leadtime')?.value||'';
    const vHdays=vH?String(parseInt(vH)*7):'';
    const vL=document.getElementById('f_exeloc')?.value||'';
    const vM=document.getElementById('f_client')?.value||'';
    const vN=document.getElementById('f_orno')?.value||'';
    const vScope=document.getElementById('f_scope')?.value||'';
    const vI=addDays(vE,vHdays);

    const iProj   = document.getElementById('f_proj')?.value||'';
    const iDocno  = document.getElementById('f_docno')?.value||'';
    const iClient = document.getElementById('f_client')?.value||'';
    const iSite   = document.getElementById('f_site')?.value||'';
    const iPrep   = document.getElementById('f_prep')?.value||'';
    const iRevno  = document.getElementById('f_revno')?.value||'';
    const iDate   = document.getElementById('f_date')?.value||'';
    const iAppby  = document.getElementById('f_appby')?.value||'';

    lg('Reading EPLAN files‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));

    const parts=new Map();
    let totalRows=0;
    for(const file of eplanFiles){
      lg(`  Reading ${file.name}‚Ä¶`);
      const data=await readXL(file);
      if(!data.length)continue;
      const headerRow=data[0];
      const panelCols=[];
      for(let c=0;c<headerRow.length;c++){
        const h=String(headerRow[c]||'').trim();
        if(h && c!==eCP && c!==eCM && c!==eCD && c!==eCQ) panelCols.push({col:c,panel:h});
      }
      const usePanels=panelCols.length>0;
      for(let i=eSR-1;i<data.length;i++){
        const row=data[i];
        const part=String(row[eCP]||'').trim();
        if(!part)continue;
        const make=String(row[eCM]||'').trim();
        const desc=String(row[eCD]||'').trim();
        const key=part.toLowerCase();
        if(!parts.has(key)) parts.set(key,{partNum:part,make,desc,panels:[]});
        const entry=parts.get(key);
        if(!entry.make&&make)entry.make=make;
        if(!entry.desc&&desc)entry.desc=desc;
        if(usePanels){
          for(const {col,panel} of panelCols){
            const rawQ=row[col];
            const qty=typeof rawQ==='number'?rawQ:(parseFloat(String(rawQ).replace(/,/g,''))||0);
            if(qty>0){
              const existing=entry.panels.find(p=>p.panel===panel);
              if(existing)existing.qty+=qty;
              else entry.panels.push({panel,qty});
            }
          }
        }else{
          const rawQ=row[eCQ];
          const qty=typeof rawQ==='number'?rawQ:(parseFloat(String(rawQ).replace(/,/g,''))||0);
          const existing=entry.panels.find(p=>p.panel==='Default');
          if(existing)existing.qty+=qty;
          else entry.panels.push({panel:'Default',qty});
        }
        totalRows++;
      }
    }
    for(const [k,v] of parts){ if(!v.panels.length) parts.delete(k); }
    lg(`‚úì ${parts.size} unique parts (${totalRows} rows read)`,'ok');

    lg('Loading MRS Master template‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));

    const buf=await masterFile.arrayBuffer();
    const wb=new ExcelJS.Workbook();
    await wb.xlsx.load(buf);
    const ws=wb.worksheets[0];

    lg('Writing header info‚Ä¶');
    const infoD=[iProj,iClient,iPrep,iDate];
    const infoI=[iDocno,iSite,iRevno,iAppby];
    for(let r=1;r<=4;r++){
      ws.getRow(r).getCell(4).value=infoD[r-1]||'';
      ws.getRow(r).getCell(9).value=infoI[r-1]||'';
    }

    lg('Writing EPLAN data rows‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));

    let rowNum=mSR, sr=1;
    for(const [,part] of parts){
      const row=ws.getRow(rowNum);
      row.getCell(mCA+1).value=sr;
      row.getCell(mCB+1).value=part.make||'';
      row.getCell(mCC+1).value=part.partNum;
      row.getCell(mCD+1).value=part.desc||'';
      if(vE){const d=new Date(vE);row.getCell(mCE+1).value=d;row.getCell(mCE+1).numFmt='dd-mmm-yy';}
      row.getCell(mCA+1+5).value=vScope||'';
      row.getCell(mCG+1).value=vScope||'';
      row.getCell(mCH+1).value=vH?parseInt(vH):'';
      if(vI){const d=new Date(vI);row.getCell(mCI+1).value=d;row.getCell(mCI+1).numFmt='dd-mmm-yy';}
      row.getCell(mCL+1).value=vL||'';
      row.getCell(mCM2+1).value=vM||'';
      row.getCell(mCN+1).value=vN||'';
      row.getCell(mCP+1).value=part.partNum;
      row.commit();
      rowNum++;sr++;
    }

    lg(`‚úì ${sr-1} rows written starting from row ${mSR}`,'ok');
    lg('Saving‚Ä¶','info');
    await new Promise(r=>setTimeout(r,30));

    const out=await wb.xlsx.writeBuffer();
    const blob=new Blob([out],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    const name=(document.getElementById('exportName').value.trim()||'MRS_Generated').replace(/[^a-zA-Z0-9_\-. ]/g,'_')+`_${today()}.xlsx`;
    saveAs(blob,name);

    lg(`‚úÖ Downloaded: ${name}`,'ok');
    btn.textContent='‚ö° Generate MRS';
    btn.disabled=false;

  }catch(err){
    console.error(err);
    lg('Error: '+err.message,'err');
    btn.textContent='‚ö° Generate MRS';
    btn.disabled=false;
  }
}

// ‚îÄ‚îÄ DARK MODE ‚Äî synced via wz-theme ‚îÄ‚îÄ
function toggleDark(){
  const d=document.body.classList.toggle('dark');
  document.getElementById('dico').textContent=d?'‚òÄÔ∏è':'üåô';
  document.getElementById('dlbl').textContent=d?'Light':'Dark';
  try{localStorage.setItem('wz-theme',d?'dark':'light');}catch(e){}
}
(function(){
  try{
    if(localStorage.getItem('wz-theme')==='dark'){
      document.body.classList.add('dark');
      document.getElementById('dico').textContent='‚òÄÔ∏è';
      document.getElementById('dlbl').textContent='Light';
    }
  }catch(e){}
})();
</script>
</body>
</html>
