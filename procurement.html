<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="css/procurement_style.css">
<title>Workezz â€” Procurement Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body>

<!-- HEADER -->
<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <div>
      <div class="logo">Work<span>ezz</span></div>
      <div class="logo-sub">Procurement Planner</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="dark-toggle" onclick="toggleDark()">
      <span class="dark-toggle-icon" id="darkIcon">&#127769;</span>
      <span id="darkLabel">Dark Mode</span>
    </button>
    <a class="home-btn" href="index.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
  </div>
</header>

<!-- STEPPER -->
<div class="stepper">
  <div class="step active" id="step1"><div class="step-num">1</div> Import &amp; Map</div>
  <span class="step-arrow">&#8250;</span>
  <div class="step" id="step2"><div class="step-num">2</div> Data Visualization</div>
  <span class="step-arrow">&#8250;</span>
  <div class="step" id="step3"><div class="step-num">3</div> Export</div>
</div>

<!-- SCREEN 1 -->
<div class="screen active" id="screen1">
  <div class="s1-layout">

    <div class="s1-panel">
      <div>
        <div class="panel-title">&#128202; BOM Sheet</div>
        <div class="panel-sub">Bill of Materials â€” panel quantities per part</div>
      </div>
      <input type="file" id="bomInput" accept=".xls,.xlsx" style="display:none;" onchange="handleBOM(this)">
      <div id="bomEmptyZone" class="upload-zone bom-zone" onclick="document.getElementById('bomInput').click()">
        <span class="uz-icon">&#128202;</span>
        <div class="uz-text"><strong>Click to upload BOM Sheet</strong></div>
        <div class="uz-sub">.xls or .xlsx</div>
      </div>
      <div id="bomChip" class="file-chip bom-chip" style="display:none;">
        <div class="fc-icon" id="bomExt">XLS</div>
        <div class="fc-info">
          <div class="fc-name" id="bomName">&#8212;</div>
          <div class="fc-sub" id="bomSize">&#8212;</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="clearBOM()">&#10005;</button>
      </div>
      <div class="col-map-card">
        <div class="section-label">BOM Column Mapping</div>
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">Configure columns and data start row</div>
        <div class="col-map-grid">
          <div class="col-map-item">
            <span class="col-map-label">Part Number Col</span>
            <input class="col-input" id="bomColPart" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Description Col</span>
            <input class="col-input" id="bomColDesc" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Make Col</span>
            <input class="col-input" id="bomColMake" value="B" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Data Start Row</span>
            <input class="col-input" id="bomStartRow" value="2" maxlength="4" type="number" min="1" oninput="saveSettings()">
          </div>
          <div class="col-map-item" style="grid-column:1/-1;">
            <span class="col-map-label">Panel columns start at</span>
            <input class="col-input" id="bomColPanelStart" value="E" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item" style="grid-column:1/-1;">
            <span class="col-map-label">Number of panels</span>
            <input class="col-input" id="bomPanelCount" value="" maxlength="3" type="number" min="1" placeholder="&#8212;" style="width:60px;" oninput="saveSettings()">
          </div>
        </div>
      </div>
    </div>

    <div class="s1-panel">
      <div>
        <div class="panel-title">&#128256; MRS Sheet</div>
        <div class="panel-sub">Material Requirement Schedule â€” available quantities</div>
      </div>
      <input type="file" id="mrsInput" accept=".xls,.xlsx" style="display:none;" onchange="handleMRS(this)">
      <div id="mrsEmptyZone" class="upload-zone mrs-zone" onclick="document.getElementById('mrsInput').click()">
        <span class="uz-icon">&#128256;</span>
        <div class="uz-text"><strong>Click to upload MRS Sheet</strong></div>
        <div class="uz-sub">.xls or .xlsx</div>
      </div>
      <div id="mrsChip" class="file-chip mrs-chip" style="display:none;">
        <div class="fc-icon" id="mrsExt">XLS</div>
        <div class="fc-info">
          <div class="fc-name" id="mrsName">&#8212;</div>
          <div class="fc-sub" id="mrsSize">&#8212;</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="clearMRS()">&#10005;</button>
      </div>
      <div class="col-map-card">
        <div class="section-label">MRS Column Mapping</div>
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">Which columns hold the key fields?</div>
        <div class="col-map-grid">
          <div class="col-map-item">
            <span class="col-map-label">Part Number Col</span>
            <input class="col-input" id="mrsColPart" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Section Col</span>
            <input class="col-input" id="mrsColSection" value="G" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Qty Col</span>
            <input class="col-input" id="mrsColQty" value="P" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Make Col</span>
            <input class="col-input" id="mrsColMake" value="E" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Description Col</span>
            <input class="col-input" id="mrsColDesc" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase();saveSettings()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Data Start Row</span>
            <input class="col-input" id="mrsStartRow" value="8" maxlength="4" type="number" min="1" oninput="saveSettings()">
          </div>
        </div>
      </div>
      <div style="background:var(--accent-light);border:1px solid #bfdbfe;border-radius:var(--radius-sm);padding:12px 14px;font-size:.73rem;color:#1e40af;line-height:1.7;">
        <strong>Note:</strong> Panel name in BOM must exactly match Section name in MRS column G.
      </div>
    </div>

  </div>
  <div class="s1-footer">
    <span id="s1hint" style="font-size:.74rem;color:var(--muted);">Upload both BOM and MRS sheets to continue</span>
    <button class="btn btn-primary btn-lg" id="processBtn" onclick="processData()" disabled>Process Data &#8594;</button>
  </div>
</div>

<!-- SCREEN 2 -->
<div class="screen" id="screen2">
  <div class="s2-layout">
    <div class="s2-toolbar">
      <span style="font-size:.74rem;font-weight:600;color:var(--text2);margin-right:4px;">Sections:</span>
      <div id="sectionPills" style="display:flex;gap:6px;flex-wrap:wrap;flex:1;"></div>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-secondary btn-sm" onclick="goTo(1)">&#8249; Back</button>
        <button class="btn btn-primary btn-sm" onclick="goTo(3)">Export &#8594;</button>
      </div>
    </div>
    <div style="padding:16px 24px 0;flex-shrink:0;">
      <div class="stats-bar" id="statsBar"></div>
    </div>
    <div class="s2-content" id="vizContent">
      <div class="empty-state">&#128202;<p>Process data to see visualization</p></div>
    </div>
  </div>
</div>

<!-- SCREEN 3 -->
<div class="screen" id="screen3">
  <div class="s3-layout">
    <div class="export-card">
      <div style="font-size:2.5rem;margin-bottom:12px;">&#128229;</div>
      <h2>Export Procurement Plan</h2>
      <p>Exports 4 sheets: Panel Comparison &middot; Unmatched MRS &middot; Parts to Order &middot; Excess Parts.</p>
      <div class="export-summary" id="exportSummary"></div>
      <div style="margin-bottom:16px;text-align:left;">
        <div style="font-size:.68rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Output File Name</div>
        <div style="display:flex;align-items:center;border:1px solid var(--border2);border-radius:var(--radius-sm);overflow:hidden;">
          <input id="exportFileName" type="text" value="Procurement_Plan" placeholder="Procurement_Plan"
            style="flex:1;border:none;outline:none;padding:9px 12px;font-family:'IBM Plex Sans',sans-serif;font-size:.82rem;color:var(--text);background:transparent;">
          <span style="padding:9px 12px;font-size:.74rem;font-weight:600;color:var(--muted);background:var(--surface2);border-left:1px solid var(--border);">.xlsx</span>
        </div>
        <div style="font-size:.62rem;color:var(--muted);margin-top:4px;">âœ¦ Auto-filled from MRS filename Â· edit freely</div>
      </div>
      <button class="btn btn-success btn-full btn-lg" id="exportBtn" onclick="exportExcel()">&#8595; Download Excel</button>
    </div>
    <button class="btn btn-secondary" onclick="goTo(2)">&#8249; Back to Visualization</button>
  </div>
</div>

<script>
var bomFile = null, mrsFile = null, processedData = null;

function colIdx(l) { return l.toUpperCase().charCodeAt(0) - 65; }
function fmtSz(b) { if(b<1024)return b+' B'; if(b<1048576)return (b/1024).toFixed(1)+' KB'; return (b/1048576).toFixed(1)+' MB'; }
function todayStr() { return new Date().toISOString().slice(0,10); }

// â”€â”€ PERSIST â”€â”€
var PKEYS = ['bomColPart','bomColDesc','bomColMake','bomStartRow','bomColPanelStart','bomPanelCount','mrsColPart','mrsColSection','mrsColQty','mrsColMake','mrsColDesc','mrsStartRow'];
function saveSettings() {
  try {
    var obj = {};
    PKEYS.forEach(function(k){ var el=document.getElementById(k); if(el) obj[k]=el.value; });
    localStorage.setItem('wz-proc-v1', JSON.stringify(obj));
  } catch(e){}
}
function loadSettings() {
  try {
    var saved = localStorage.getItem('wz-proc-v1');
    if (!saved) return;
    var obj = JSON.parse(saved);
    PKEYS.forEach(function(k){
      var el = document.getElementById(k);
      if (el && obj[k] !== undefined && obj[k] !== '') el.value = obj[k];
    });
  } catch(e){}
}

// â”€â”€ Parse OR number from MRS filename â”€â”€
// Format: MRS_FSL_2425_PUN_OR062_02_V0A.xlsx â†’ FSL_2425_PUN_OR062
function parseOrFromMrsFilename(filename) {
  var bare = filename.replace(/\.(xlsx|xls)$/i, '');
  bare = bare.replace(/^MRS_/i, '');
  bare = bare.replace(/_(V[0-9][A-Z0-9]*)$/i, '');
  bare = bare.replace(/_(\d{1,3})$/, '');
  return bare || '';
}

// â”€â”€ FILES â”€â”€
function handleBOM(input) {
  if (!input.files.length) return;
  bomFile = input.files[0]; input.value='';
  document.getElementById('bomEmptyZone').style.display='none';
  document.getElementById('bomChip').style.display='flex';
  document.getElementById('bomExt').textContent = bomFile.name.split('.').pop().toUpperCase();
  document.getElementById('bomName').textContent = bomFile.name;
  document.getElementById('bomSize').textContent = fmtSz(bomFile.size);
  checkReady();
}
function clearBOM() {
  bomFile=null;
  document.getElementById('bomEmptyZone').style.display='';
  document.getElementById('bomChip').style.display='none';
  document.getElementById('bomInput').value='';
  checkReady();
}
function handleMRS(input) {
  if (!input.files.length) return;
  mrsFile = input.files[0]; input.value='';
  document.getElementById('mrsEmptyZone').style.display='none';
  document.getElementById('mrsChip').style.display='flex';
  document.getElementById('mrsExt').textContent = mrsFile.name.split('.').pop().toUpperCase();
  document.getElementById('mrsName').textContent = mrsFile.name;
  document.getElementById('mrsSize').textContent = fmtSz(mrsFile.size);
  // Auto-suggest export filename from MRS filename
  var orPart = parseOrFromMrsFilename(mrsFile.name);
  if (orPart) {
    var expInp = document.getElementById('exportFileName');
    if (expInp) expInp.value = 'Procurement_' + orPart;
  }
  checkReady();
}
function clearMRS() {
  mrsFile=null;
  document.getElementById('mrsEmptyZone').style.display='';
  document.getElementById('mrsChip').style.display='none';
  document.getElementById('mrsInput').value='';
  var expInp = document.getElementById('exportFileName');
  if (expInp) expInp.value = 'Procurement_Plan';
  checkReady();
}
function checkReady() {
  var ok = !!(bomFile && mrsFile);
  document.getElementById('processBtn').disabled = !ok;
  document.getElementById('s1hint').textContent = !bomFile ? 'Upload BOM sheet to continue' : !mrsFile ? 'Upload MRS sheet to continue' : 'Both files ready â€” click Process Data';
}

// â”€â”€ READ EXCEL â”€â”€
function readExcel(file) {
  return new Promise(function(resolve) {
    var reader = new FileReader();
    reader.onload = function(e) {
      try {
        var wb = XLSX.read(e.target.result, {type:'array'});
        var best=[], bestN=0;
        for (var i=0;i<wb.SheetNames.length;i++) {
          var ws = wb.Sheets[wb.SheetNames[i]];
          var data = XLSX.utils.sheet_to_json(ws,{header:1,defval:'',raw:true});
          var n = data.filter(function(r){return r.some(function(v){return v!=='';});}).length;
          if(n>bestN){bestN=n;best=data;}
        }
        resolve(best);
      } catch(err){resolve([]);}
    };
    reader.readAsArrayBuffer(file);
  });
}

// â”€â”€ PROCESS â”€â”€
async function processData() {
  document.getElementById('processBtn').disabled=true;
  document.getElementById('processBtn').textContent='Processing...';

  var bomSR   = parseInt(document.getElementById('bomStartRow').value)||2;
  var mrsSR   = parseInt(document.getElementById('mrsStartRow').value)||8;
  var bCP     = colIdx(document.getElementById('bomColPart').value||'C');
  var bCD     = colIdx(document.getElementById('bomColDesc').value||'D');
  var bCM     = colIdx(document.getElementById('bomColMake').value||'B');
  var bPS     = colIdx(document.getElementById('bomColPanelStart').value||'E');
  var mCP     = colIdx(document.getElementById('mrsColPart').value||'C');
  var mCS     = colIdx(document.getElementById('mrsColSection').value||'G');
  var mCQ     = colIdx(document.getElementById('mrsColQty').value||'P');
  var mCM     = colIdx(document.getElementById('mrsColMake').value||'E');
  var mCDesc  = colIdx(document.getElementById('mrsColDesc').value||'D');
  var bPC     = parseInt(document.getElementById('bomPanelCount').value)||0;

  var res = await Promise.all([readExcel(bomFile), readExcel(mrsFile)]);
  var bomData=res[0], mrsData=res[1];

  // panels from BOM row 1
  var hdr = bomData[0]||[];
  var panels=[];
  for(var c=bPS;c<hdr.length;c++){
    var h=String(hdr[c]||'').trim();
    if(h) panels.push({name:h,col:c});
    if(bPC>0 && panels.length>=bPC) break;
  }

  // BOM parts
  var partsMap=new Map();
  for(var i=bomSR-1;i<bomData.length;i++){
    var row=bomData[i];
    var pn=String(row[bCP]||'').trim(); if(!pn) continue;
    var key=pn.toLowerCase();
    if(!partsMap.has(key)) partsMap.set(key,{partNum:pn,make:String(row[bCM]||'').trim(),desc:String(row[bCD]||'').trim(),panelQtys:{}});
    var ent=partsMap.get(key);
    panels.forEach(function(p){
      var raw=row[p.col];
      var qty=typeof raw==='number'?raw:(parseFloat(String(raw||'').replace(/,/g,''))||0);
      ent.panelQtys[p.name]=(ent.panelQtys[p.name]||0)+qty;
    });
  }

  // MRS rows â€” store {make, desc, sections: Map(section->qty)} per part key
  var mrsMap=new Map();
  for(var j=mrsSR-1;j<mrsData.length;j++){
    var mr=mrsData[j];
    var mp=String(mr[mCP]||'').trim();
    var ms=String(mr[mCS]||'').trim();
    if(!mp||!ms) continue;
    var mraw=mr[mCQ];
    var mq=typeof mraw==='number'?mraw:(parseFloat(String(mraw||'').replace(/,/g,''))||0);
    if(!mq) continue;
    var mk=mp.toLowerCase();
    if(!mrsMap.has(mk)){
      mrsMap.set(mk,{
        make: String(mr[mCM]||'').trim(),
        desc: String(mr[mCDesc]||'').trim(),
        sections: new Map()
      });
    }
    var mrsEntry=mrsMap.get(mk);
    // Fill make/desc from first row that has them if not already set
    if(!mrsEntry.make) mrsEntry.make=String(mr[mCM]||'').trim();
    if(!mrsEntry.desc) mrsEntry.desc=String(mr[mCDesc]||'').trim();
    mrsEntry.sections.set(ms,(mrsEntry.sections.get(ms)||0)+mq);
  }

  // panelRows for viz
  var panelRows=new Map();
  panels.forEach(function(p){panelRows.set(p.name,[]);});
  var gsr=1;
  partsMap.forEach(function(part,key){
    panels.forEach(function(p){
      var rq=part.panelQtys[p.name]||0; if(!rq) return;
      var mq=(mrsMap.has(key)&&mrsMap.get(key).sections.has(p.name))?mrsMap.get(key).sections.get(p.name):0;
      var st,stype;
      if(mq===0)       {st='No MRS';                          stype='nomrs';}
      else if(mq>rq)   {st='+'+(mq-rq)+' Excess';            stype='excess';}
      else if(mq<rq)   {st='-'+(rq-mq)+' Short';             stype='short';}
      else             {st='Exact \u2713';                    stype='exact';}
      panelRows.get(p.name).push({srNo:gsr++,make:part.make,partNum:part.partNum,desc:part.desc,reqQty:rq,mrsQty:mq,status:st,statusType:stype});
    });
  });

  // Unmatched MRS â€” parts in MRS with no match in BOM
  var unmatchedMRS=[];
  mrsMap.forEach(function(mrsEntry,key){
    if(!partsMap.has(key)){
      mrsEntry.sections.forEach(function(qty,panel){
        unmatchedMRS.push({
          partNum: mrsEntry.desc ? key : key,  // keep original key as part number lookup
          partNumDisplay: key,
          make: mrsEntry.make||'',
          desc: mrsEntry.desc||'',
          panel: panel,
          qty: qty
        });
      });
    }
  });

  // Parts to order (consolidated)
  var toOrderMap=new Map();
  partsMap.forEach(function(part,key){
    panels.forEach(function(p){
      var rq=part.panelQtys[p.name]||0; if(!rq) return;
      var mq=(mrsMap.has(key)&&mrsMap.get(key).sections.has(p.name))?mrsMap.get(key).sections.get(p.name):0;
      if(mq<rq){
        if(!toOrderMap.has(key)) toOrderMap.set(key,{partNum:part.partNum,make:part.make,desc:part.desc,totalReq:0});
        toOrderMap.get(key).totalReq+=rq;
      }
    });
  });
  var toOrderParts=Array.from(toOrderMap.values());

  // Excess (consolidated)
  var excessMap=new Map();
  partsMap.forEach(function(part,key){
    panels.forEach(function(p){
      var rq=part.panelQtys[p.name]||0; if(!rq) return;
      var mq=(mrsMap.has(key)&&mrsMap.get(key).sections.has(p.name))?mrsMap.get(key).sections.get(p.name):0;
      if(mq>rq){
        if(!excessMap.has(key)) excessMap.set(key,{partNum:part.partNum,make:part.make,desc:part.desc,totalReq:0,totalMrs:0});
        excessMap.get(key).totalReq+=rq;
        excessMap.get(key).totalMrs+=mq;
      }
    });
  });
  var excessParts=Array.from(excessMap.values()).map(function(p){return{partNum:p.partNum,make:p.make,desc:p.desc,totalReq:p.totalReq,totalMrs:p.totalMrs,excessQty:p.totalMrs-p.totalReq};});

  // shortParts for stats
  var shortParts=[];
  partsMap.forEach(function(part,key){
    panels.forEach(function(p){
      var rq=part.panelQtys[p.name]||0; if(!rq) return;
      var mq=(mrsMap.has(key)&&mrsMap.get(key).sections.has(p.name))?mrsMap.get(key).sections.get(p.name):0;
      if(mq<rq) shortParts.push({partNum:part.partNum,make:part.make,desc:part.desc,panel:p.name,reqQty:rq,mrsQty:mq,shortage:rq-mq});
    });
  });

  processedData={panels:panels,partsMap:partsMap,panelRows:panelRows,mrsMap:mrsMap,unmatchedMRS:unmatchedMRS,excessParts:excessParts,shortParts:shortParts,toOrderParts:toOrderParts};

  document.getElementById('processBtn').disabled=false;
  document.getElementById('processBtn').textContent='Process Data \u2192';
  renderVisualization();
  goTo(2);
}

// â”€â”€ NAV â”€â”€
function goTo(n) {
  document.querySelectorAll('.screen').forEach(function(s,i){s.classList.toggle('active',i===n-1);});
  document.querySelectorAll('.step').forEach(function(s,i){
    s.classList.remove('active','done');
    if(i+1===n) s.classList.add('active');
    else if(i+1<n) s.classList.add('done');
  });
  if(n===3) renderExportSummary();
}

// â”€â”€ VIZ â”€â”€
function renderVisualization() {
  var p=processedData;
  var pillsEl=document.getElementById('sectionPills');
  var ph='<button class="section-pill active" onclick="filterSection(\'all\',this)">All Panels</button>';
  p.panels.forEach(function(pl){
    ph+='<button class="section-pill" onclick="filterSection(\''+pl.name+'\',this)">'+pl.name+' <span style="opacity:.6;font-size:.65rem;">('+((p.panelRows.get(pl.name)||[]).length)+')</span></button>';
  });
  pillsEl.innerHTML=ph;

  var allRows=[];
  p.panelRows.forEach(function(rows){rows.forEach(function(r){allRows.push(r);});});
  var exact=allRows.filter(function(r){return r.statusType==='exact';}).length;

  document.getElementById('statsBar').innerHTML=
    '<div class="stat-card"><span class="stat-icon">&#128203;</span><div><div class="stat-val">'+p.panels.length+'</div><div class="stat-label">Panels</div></div></div>'+
    '<div class="stat-card"><span class="stat-icon">&#128297;</span><div><div class="stat-val">'+p.partsMap.size+'</div><div class="stat-label">Unique Parts</div></div></div>'+
    '<div class="stat-card"><span class="stat-icon">&#9989;</span><div><div class="stat-val" style="color:var(--success)">'+exact+'</div><div class="stat-label">Exact Match</div></div></div>'+
    '<div class="stat-card"><span class="stat-icon">&#128722;</span><div><div class="stat-val" style="color:var(--danger)">'+p.shortParts.length+'</div><div class="stat-label">Need Order</div></div></div>'+
    '<div class="stat-card"><span class="stat-icon">&#128230;</span><div><div class="stat-val">'+p.excessParts.length+'</div><div class="stat-label">Excess Parts</div></div></div>'+
    '<div class="stat-card"><span class="stat-icon">&#9888;</span><div><div class="stat-val" style="color:var(--warning)">'+p.unmatchedMRS.length+'</div><div class="stat-label">Unmatched MRS</div></div></div>';

  filterSection('all',document.querySelector('.section-pill'));
}

function filterSection(name,btn) {
  document.querySelectorAll('.section-pill').forEach(function(p){p.classList.remove('active');});
  if(btn) btn.classList.add('active');
  var p=processedData;
  var show=name==='all'?p.panels:p.panels.filter(function(pl){return pl.name===name;});
  var html='';
  show.forEach(function(pl){
    var rows=p.panelRows.get(pl.name)||[];
    if(!rows.length) return;
    html+='<div class="section-block"><div class="section-head"><h3>'+pl.name+'</h3><span class="section-badge">'+rows.length+' parts</span></div>';
    html+='<div style="overflow-x:auto;"><table class="viz-table"><thead><tr><th>#</th><th>Part Number</th><th>Make</th><th>Description</th><th class="panel-head">Req Qty</th><th class="mrs-head">MRS Qty</th><th class="status-head">Status</th></tr></thead><tbody>';
    rows.forEach(function(r){
      html+='<tr><td>'+r.srNo+'</td><td class="td-mono">'+r.partNum+'</td><td>'+(r.make||'&mdash;')+'</td><td>'+(r.desc||'&mdash;')+'</td><td class="td-center">'+r.reqQty+'</td><td class="td-center">'+(r.mrsQty||'&mdash;')+'</td><td class="td-center">'+statusPill(r.statusType,r.status)+'</td></tr>';
    });
    html+='</tbody></table></div></div>';
  });
  document.getElementById('vizContent').innerHTML=html||'<div class="empty-state">No data for this panel</div>';
}

function statusPill(type,text){
  var cls={excess:'pill-excess',short:'pill-short',exact:'pill-exact',nomrs:'pill-nomrs'}[type]||'pill-nomrs';
  return '<span class="'+cls+'">'+text+'</span>';
}

function renderExportSummary(){
  var p=processedData;
  var total=0; p.panelRows.forEach(function(r){total+=r.length;});
  document.getElementById('exportSummary').innerHTML=
    '<div class="exp-item"><div class="exp-item-val">'+p.panels.length+'</div><div class="exp-item-label">Panels</div></div>'+
    '<div class="exp-item"><div class="exp-item-val">'+total+'</div><div class="exp-item-label">Part Rows</div></div>'+
    '<div class="exp-item"><div class="exp-item-val" style="color:var(--danger)">'+p.toOrderParts.length+'</div><div class="exp-item-label">Parts to Order</div></div>'+
    '<div class="exp-item"><div class="exp-item-val">'+todayStr()+'</div><div class="exp-item-label">Export Date</div></div>';
}

// â”€â”€ EXPORT â”€â”€
async function exportExcel(){
  var btn=document.getElementById('exportBtn');
  btn.textContent='Generating...'; btn.disabled=true;
  await new Promise(function(r){setTimeout(r,50);});
  try {
    var wb=new ExcelJS.Workbook();
    var p=processedData;
    var panels=p.panels, partsMap=p.partsMap, mrsMap=p.mrsMap;
    var unmatchedMRS=p.unmatchedMRS, excessParts=p.excessParts, toOrderParts=p.toOrderParts;

    var C={
      DB:'FF1E3A5F',MB:'FF2563EB',PB:'FFD6E4F7',PH:'FF5B21B6',PP:'FFEDE9FE',
      RL:'FFFAFBFE',RD:'FFF0F4FB',
      GB:'FFDCFCE7',GF:'FF15803D',RRB:'FFFEE2E2',RF:'FFB91C1C',
      AB:'FFFEF3C7',AF:'FF92400E',GB2:'FFF1F5F9',GF2:'FF64748B',WW:'FFFFFFFF'
    };

    function sc(cell,o){
      o=o||{};
      if(o.val!==undefined && o.val!=='') cell.value=o.val;
      if(o.bg) cell.fill={type:'pattern',pattern:'solid',fgColor:{argb:o.bg}};
      cell.font={bold:o.bold||false,size:o.sz||9,color:{argb:o.fg||'FF1F2937'},name:o.font||'Calibri'};
      cell.alignment={vertical:'middle',horizontal:o.halign||'left',wrapText:o.wrap||false};
      cell.border={bottom:{style:'thin',color:{argb:o.bc||'FFE5E7EB'}},right:{style:o.rm?'medium':'thin',color:{argb:o.rm?C.DB:(o.bc||'FFE5E7EB')}}};
    }

    function mkHdr(ws,labels,bg,widths){
      widths.forEach(function(w,i){ws.getColumn(i+1).width=w;});
      ws.views=[{state:'frozen',xSplit:0,ySplit:1}];
      var hr=ws.addRow([]); hr.height=22;
      labels.forEach(function(v,i){
        var c=hr.getCell(i+1);
        c.value=v;
        c.font={bold:true,size:9,color:{argb:'FFFFFFFF'},name:'Calibri'};
        c.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
        c.alignment={vertical:'middle',horizontal:'center',wrapText:true};
        c.border={bottom:{style:'medium',color:{argb:'FFD1D5DB'}},right:{style:'thin',color:{argb:'FFD1D5DB'}}};
      });
    }

    function dRow(ws,vals,ri,accentCol,accentFg,even,odd){
      var r=ws.addRow(vals); r.height=17;
      var bg=ri%2===0?even:odd;
      vals.forEach(function(_,ci){
        var c=r.getCell(ci+1);
        c.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
        var acc=(ci+1===accentCol);
        c.font={size:9,name:ci===2?'Courier New':'Calibri',bold:acc,color:{argb:acc?accentFg:(ci===2?C.DB:'FF1F2937')}};
        c.alignment={vertical:'middle',horizontal:ci>=4?'center':'left',wrapText:ci===3};
        c.border={bottom:{style:'thin',color:{argb:'FFE5E7EB'}},right:{style:'thin',color:{argb:'FFE5E7EB'}}};
      });
    }

    // SHEET 1 â€” Panel Comparison
    var ws1=wb.addWorksheet('Panel Comparison',{views:[{state:'frozen',xSplit:4,ySplit:2,activeCell:'E3'}]});
    ws1.getColumn(1).width=5;ws1.getColumn(2).width=18;ws1.getColumn(3).width=26;ws1.getColumn(4).width=38;
    var cw=5;
    panels.forEach(function(){ws1.getColumn(cw).width=10;ws1.getColumn(cw+1).width=10;ws1.getColumn(cw+2).width=14;cw+=3;});
    var r1=ws1.addRow([]); r1.height=24;
    var r2=ws1.addRow([]); r2.height=22;
    ['SR','Make','Part Number','Description'].forEach(function(h,i){
      sc(r1.getCell(i+1),{val:h,bg:C.DB,fg:C.WW,bold:true,sz:9,halign:'center',bc:'FFD1D5DB'});
      ws1.mergeCells(1,i+1,2,i+1);
    });
    var pcm=new Map(); var pc2=5;
    panels.forEach(function(pl){
      pcm.set(pl.name,pc2);
      sc(r1.getCell(pc2),{val:pl.name,bg:C.MB,fg:C.WW,bold:true,sz:8,halign:'center',bc:'FF93C5FD',rm:true});
      ws1.mergeCells(1,pc2,1,pc2+2);
      var subs=['Req Qty','MRS Qty','Status'];
      var sbg=[C.PB,C.PP,'FFECEEF4']; var sfg=[C.MB,C.PH,'FF374151'];
      subs.forEach(function(s,si){sc(r2.getCell(pc2+si),{val:s,bg:sbg[si],fg:sfg[si],bold:true,sz:8,halign:'center',bc:'FFD1D5DB',rm:si===2});});
      pc2+=3;
    });
    var allParts=Array.from(partsMap.values());
    for(var idx=0;idx<allParts.length;idx++){
      if(idx%100===0&&idx>0) await new Promise(function(r){setTimeout(r,0);});
      var part=allParts[idx]; var key=part.partNum.toLowerCase();
      var rbg=idx%2===0?C.RL:C.RD;
      var dr=ws1.addRow([]); dr.height=17;
      sc(dr.getCell(1),{val:idx+1,bg:rbg,sz:9,halign:'center'});
      sc(dr.getCell(2),{val:part.make||'',bg:rbg,sz:9});
      sc(dr.getCell(3),{val:part.partNum,bg:rbg,sz:9,bold:true,font:'Courier New',fg:C.DB});
      sc(dr.getCell(4),{val:part.desc||'',bg:rbg,sz:9,wrap:true});
      panels.forEach(function(pl){
        var psc=pcm.get(pl.name);
        var rq=part.panelQtys[pl.name]||0;
        var mq=(mrsMap.has(key)&&mrsMap.get(key).sections.has(pl.name))?mrsMap.get(key).sections.get(pl.name):0;
        var st,sb,sf;
        if(rq===0)       {st='';           sb=rbg;   sf=C.GF2;}
        else if(mq===0)  {st='No MRS';     sb=C.GB2;  sf=C.GF2;}
        else if(mq>rq)   {st='+'+(mq-rq)+' Excess';sb=C.GB;sf=C.GF;}
        else if(mq<rq)   {st='-'+(rq-mq)+' Short'; sb=C.RRB;sf=C.RF;}
        else             {st='Exact \u2713';sb=C.AB;sf=C.AF;}
        sc(dr.getCell(psc),  {val:rq||'',bg:rbg,sz:9,bold:rq>0,halign:'center'});
        sc(dr.getCell(psc+1),{val:mq||'',bg:rbg,sz:9,bold:mq>0,halign:'center',fg:C.PH});
        sc(dr.getCell(psc+2),{val:st,bg:sb,sz:9,bold:true,halign:'center',fg:sf,rm:true});
      });
    }
    await new Promise(function(r){setTimeout(r,0);});

    // SHEET 2 â€” Unmatched MRS
    var ws2=wb.addWorksheet('Unmatched MRS Parts');
    var uPanels=[];
    unmatchedMRS.forEach(function(u){if(uPanels.indexOf(u.panel)===-1) uPanels.push(u.panel);});
    uPanels.sort();
    var u2w=[5,18,26,38].concat(uPanels.map(function(){return 14;}));
    var u2h=['SR','Make','Part Number','Part Description'].concat(uPanels);
    mkHdr(ws2,u2h,C.DB,u2w);
    // recolor panel header cols to amber
    var uh=ws2.getRow(1);
    for(var ci=5;ci<=u2h.length;ci++) uh.getCell(ci).fill={type:'pattern',pattern:'solid',fgColor:{argb:C.AF}};

    var uByPart=new Map();
    unmatchedMRS.forEach(function(u){
      var displayKey=u.partNumDisplay||u.partNum;
      if(!uByPart.has(displayKey)) uByPart.set(displayKey,{partNum:displayKey,make:u.make||'',desc:u.desc||'',panels:{}});
      var entry=uByPart.get(displayKey);
      // keep best make/desc if later rows have it
      if(!entry.make && u.make) entry.make=u.make;
      if(!entry.desc && u.desc) entry.desc=u.desc;
      entry.panels[u.panel]=(entry.panels[u.panel]||0)+u.qty;
    });
    var usr2=1;
    Array.from(uByPart.values()).forEach(function(up,ri){
      var vals=[usr2++,up.make||'â€”',up.partNum,up.desc||'â€”'];
      uPanels.forEach(function(pn){vals.push(up.panels[pn]||'');});
      var r=ws2.addRow(vals); r.height=17;
      var bg=ri%2===0?'FFFFFBEB':'FFFEF9C3';
      vals.forEach(function(_,ci2){
        var c=r.getCell(ci2+1);
        c.fill={type:'pattern',pattern:'solid',fgColor:{argb:bg}};
        c.font={size:9,name:ci2===2?'Courier New':'Calibri',bold:ci2>=4,color:{argb:ci2===2?C.DB:'FF1F2937'}};
        c.alignment={vertical:'middle',horizontal:ci2<4?'left':'center',wrapText:ci2===3};
        c.border={bottom:{style:'thin',color:{argb:'FFFDE68A'}},right:{style:'thin',color:{argb:'FFFDE68A'}}};
      });
    });
    if(!uByPart.size){var nr2=ws2.addRow(['No unmatched MRS parts']);nr2.getCell(1).font={italic:true,size:9,color:{argb:C.GF2}};}
    await new Promise(function(r){setTimeout(r,0);});

    // SHEET 3 â€” Parts to Order
    var ws3=wb.addWorksheet('Parts to Order');
    mkHdr(ws3,['SR','Make','Part Number','Part Description','Total Qty Required'],C.RF,[5,20,26,45,18]);
    toOrderParts.forEach(function(pt,i){dRow(ws3,[i+1,pt.make||'â€”',pt.partNum,pt.desc||'â€”',pt.totalReq],i,5,C.RF,'FFFFF5F5','FFFEF2F2');});
    if(!toOrderParts.length){var nr3=ws3.addRow(['No parts need ordering']);nr3.getCell(1).font={italic:true,size:9,color:{argb:C.GF}};}
    await new Promise(function(r){setTimeout(r,0);});

    // SHEET 4 â€” Excess Parts
    var ws4=wb.addWorksheet('Excess Parts');
    mkHdr(ws4,['SR','Make','Part Number','Part Description','Total Req Qty','Total MRS Qty','Excess Qty'],C.GF,[5,20,26,45,14,14,14]);
    excessParts.forEach(function(pt,i){dRow(ws4,[i+1,pt.make||'â€”',pt.partNum,pt.desc||'â€”',pt.totalReq,pt.totalMrs,pt.excessQty],i,7,C.GF,'FFF0FDF4','FFECFDF5');});
    if(!excessParts.length){var nr4=ws4.addRow(['No excess parts']);nr4.getCell(1).font={italic:true,size:9,color:{argb:C.GF2}};}

    var buffer=await wb.xlsx.writeBuffer();
    var blob=new Blob([buffer],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
    var fname=(document.getElementById('exportFileName').value||'Procurement_Plan').trim().replace(/[^a-zA-Z0-9_\-. ]/g,'_');
    saveAs(blob,fname+'.xlsx');

    btn.textContent='\u2193 Download Excel'; btn.disabled=false;
  } catch(err){
    console.error(err);
    alert('Export failed: '+err.message);
    btn.textContent='\u2193 Download Excel'; btn.disabled=false;
  }
}

// â”€â”€ DARK MODE â”€â”€
// Synced with index.html via shared key 'wz-theme'.
// index: default=dark, adds 'light' class for light mode.
// procurement: default=light (no class), adds 'dark' class for dark mode.
// Both read/write 'wz-theme' = 'light' | 'dark'.
function toggleDark(){
  var isDark=document.body.classList.toggle('dark');
  document.getElementById('darkIcon').textContent = isDark?'\u2600\uFE0F':'\uD83C\uDF19';
  document.getElementById('darkLabel').textContent = isDark?'Light Mode':'Dark Mode';
  try{localStorage.setItem('wz-theme',isDark?'dark':'light');}catch(e){}
}

// â”€â”€ INIT â”€â”€
(function(){
  try{
    var saved=localStorage.getItem('wz-theme');
    if(saved==='dark'){
      document.body.classList.add('dark');
      document.getElementById('darkIcon').textContent='\u2600\uFE0F';
      document.getElementById('darkLabel').textContent='Light Mode';
    }
    // default = light (no class), button shows ðŸŒ™ Dark Mode (already in HTML)
  }catch(e){}
  loadSettings();
})();
</script>

  <!-- Footer -->
  <footer style="background:var(--white);border-top:1px solid var(--border);padding:10px 24px;display:flex;align-items:center;justify-content:space-between;flex-shrink:0;box-shadow:0 -1px 4px rgba(30,34,53,.05);">
    <div style="display:flex;align-items:center;gap:8px;">
      <svg width="16" height="16" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
        <rect width="32" height="32" rx="8" fill="#2563eb"/>
        <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="16" cy="13" r="1.5" fill="white"/>
      </svg>
      <span style="font-size:.72rem;font-weight:700;font-family:'Syne',sans-serif;color:var(--text);">Workezz</span>
      <span style="font-size:.68rem;color:var(--muted);">â€” Procurement Planner</span>
    </div>
    <div style="font-size:.68rem;color:var(--muted);">
      Designed & built by <strong style="color:var(--text2);">Krish Makwane</strong> &nbsp;Â·&nbsp; MVP v2.0
    </div>
  </footer>

</body>
</html>
