<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Workezz ‚Äî Procurement Planner</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@700;800&family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
:root{
  --bg:#eef0f5;--white:#fff;--surface:#f7f8fb;--surface2:#eceef4;
  --border:#dde0ea;--border2:#c8ccda;
  --accent:#2563eb;--accent-light:#dbeafe;--accent-hover:#1d4ed8;
  --text:#1e2235;--text2:#4a5072;--muted:#8890aa;
  --success:#15803d;--success-bg:#dcfce7;--success-border:#86efac;
  --danger:#b91c1c;--danger-bg:#fee2e2;--danger-border:#fca5a5;
  --warning:#92400e;--warning-bg:#fef3c7;--warning-border:#fcd34d;
  --purple:#7c3aed;--purple-light:#ede9fe;--purple-border:#c4b5fd;
  --shadow:0 1px 3px rgba(30,34,53,.07),0 1px 2px rgba(30,34,53,.05);
  --shadow-md:0 4px 16px rgba(30,34,53,.09);
  --radius:10px;--radius-sm:6px;
}
html,body{height:100%;font-family:'IBM Plex Sans',sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
header{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;height:54px;display:flex;align-items:center;justify-content:space-between;box-shadow:var(--shadow-md);flex-shrink:0;}
.logo{font-family:'Syne',sans-serif;font-weight:800;font-size:1.3rem;letter-spacing:-.02em;color:var(--text);}
.logo span{color:var(--accent);}
.logo-sub{font-size:.62rem;color:var(--muted);font-weight:500;letter-spacing:.04em;margin-top:-2px;}
.home-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 14px;border-radius:var(--radius-sm);font-size:.78rem;font-weight:600;color:var(--text2);background:var(--surface2);border:1px solid var(--border2);cursor:pointer;text-decoration:none;transition:all .15s;}
.home-btn:hover{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}

/* ‚îÄ‚îÄ STEPPER ‚îÄ‚îÄ */
.stepper{background:var(--white);border-bottom:1px solid var(--border);padding:0 24px;height:46px;display:flex;align-items:center;gap:8px;flex-shrink:0;}
.step{display:flex;align-items:center;gap:8px;padding:5px 14px;border-radius:100px;font-size:.74rem;font-weight:600;color:var(--muted);cursor:default;transition:all .2s;white-space:nowrap;}
.step.active{background:var(--accent-light);color:var(--accent);}
.step.done{color:var(--success);}
.step-num{width:20px;height:20px;border-radius:50%;background:var(--border2);color:var(--white);display:flex;align-items:center;justify-content:center;font-size:.65rem;font-weight:700;flex-shrink:0;}
.step.active .step-num{background:var(--accent);}
.step.done .step-num{background:var(--success);}
.step-arrow{color:var(--border2);font-size:1rem;}

/* ‚îÄ‚îÄ SCREENS ‚îÄ‚îÄ */
.screen{display:none;flex:1;overflow:hidden;}
.screen.active{display:flex;flex-direction:column;}

/* ‚îÄ‚îÄ SECTION LABEL ‚îÄ‚îÄ */
.section-label{font-size:.68rem;font-weight:700;letter-spacing:.09em;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:8px 16px;border-radius:var(--radius-sm);font-family:'IBM Plex Sans',sans-serif;font-size:.8rem;font-weight:600;cursor:pointer;transition:all .15s;border:none;white-space:nowrap;}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 1px 3px rgba(37,99,235,.3);}
.btn-primary:hover{background:var(--accent-hover);transform:translateY(-1px);}
.btn-primary:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;box-shadow:none;}
.btn-success{background:var(--success);color:#fff;box-shadow:0 1px 3px rgba(21,128,61,.25);}
.btn-success:hover{background:#166534;transform:translateY(-1px);}
.btn-success:disabled{background:var(--border2);color:var(--muted);cursor:not-allowed;transform:none;box-shadow:none;}
.btn-secondary{background:var(--white);color:var(--text2);border:1px solid var(--border2);}
.btn-secondary:hover{background:var(--surface2);}
.btn-danger-outline{background:transparent;color:var(--danger);border:1px solid var(--danger-border);}
.btn-danger-outline:hover{background:var(--danger-bg);}
.btn-full{width:100%;}
.btn-lg{padding:11px 22px;font-size:.9rem;}
.btn-sm{padding:4px 10px;font-size:.72rem;}

/* ‚îÄ‚îÄ SCREEN 1 LAYOUT ‚îÄ‚îÄ */
.s1-layout{display:grid;grid-template-columns:1fr 1fr;gap:0;flex:1;overflow:hidden;}
.s1-panel{padding:28px 24px;display:flex;flex-direction:column;gap:18px;overflow-y:auto;}
.s1-panel:first-child{border-right:1px solid var(--border);}
.panel-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;color:var(--text);margin-bottom:2px;}
.panel-sub{font-size:.74rem;color:var(--muted);margin-bottom:16px;}

/* ‚îÄ‚îÄ UPLOAD ZONES ‚îÄ‚îÄ */
.upload-zone{border:2px dashed var(--border2);border-radius:var(--radius);padding:28px 16px;text-align:center;cursor:pointer;transition:all .2s;background:var(--surface);}
.upload-zone:hover{border-color:var(--accent);background:var(--accent-light);}
.upload-zone.bom-zone{border-color:#93c5fd;background:#eff6ff;}
.upload-zone.bom-zone:hover{border-color:var(--accent);background:var(--accent-light);}
.upload-zone.mrs-zone{border-color:var(--purple-border);background:var(--purple-light);}
.upload-zone.mrs-zone:hover{border-color:var(--purple);background:#ddd6fe;}
.uz-icon{font-size:2rem;margin-bottom:8px;display:block;}
.uz-text{font-size:.8rem;line-height:1.5;}
.uz-text strong{color:var(--accent);}
.mrs-zone .uz-text strong{color:var(--purple);}
.uz-sub{font-size:.68rem;color:var(--muted);margin-top:4px;}

/* File chip */
.file-chip{display:flex;align-items:center;gap:10px;border-radius:var(--radius-sm);padding:10px 14px;border:1px solid;}
.file-chip.bom-chip{background:var(--accent-light);border-color:#93c5fd;}
.file-chip.mrs-chip{background:var(--purple-light);border-color:var(--purple-border);}
.fc-icon{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.62rem;font-weight:700;font-family:'IBM Plex Mono',monospace;flex-shrink:0;color:#fff;}
.bom-chip .fc-icon{background:var(--accent);}
.mrs-chip .fc-icon{background:var(--purple);}
.fc-info{flex:1;min-width:0;}
.fc-name{font-size:.8rem;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.bom-chip .fc-name{color:var(--accent);}
.mrs-chip .fc-name{color:var(--purple);}
.fc-sub{font-size:.68rem;color:var(--muted);}

/* Column mapping */
.col-map-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:16px;box-shadow:var(--shadow);}
.col-map-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px;}
.col-map-item{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:7px 10px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);}
.col-map-label{font-size:.74rem;font-weight:600;color:var(--text2);}
.col-input{width:52px;padding:4px 7px;border:1px solid var(--border);border-radius:4px;font-family:'IBM Plex Mono',monospace;font-size:.78rem;text-align:center;outline:none;background:var(--white);color:var(--text);}
.col-input:focus{border-color:var(--accent);}

/* S1 footer */
.s1-footer{padding:16px 24px;background:var(--white);border-top:1px solid var(--border);display:flex;justify-content:flex-end;align-items:center;gap:12px;flex-shrink:0;}

/* ‚îÄ‚îÄ SCREEN 2 ‚Äî VISUALIZATION ‚îÄ‚îÄ */
.s2-layout{display:flex;flex-direction:column;flex:1;overflow:hidden;}
.s2-toolbar{padding:12px 24px;background:var(--white);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:12px;flex-shrink:0;flex-wrap:wrap;}
.section-pill{display:inline-flex;align-items:center;gap:6px;padding:5px 12px;border-radius:100px;border:1.5px solid var(--border2);background:var(--white);font-size:.72rem;font-weight:600;cursor:pointer;transition:all .15s;color:var(--text2);}
.section-pill:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-light);}
.section-pill.active{border-color:var(--accent);background:var(--accent);color:#fff;}
.s2-content{flex:1;overflow:auto;padding:20px 24px;}
.section-block{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:16px;overflow:hidden;box-shadow:var(--shadow);}
.section-head{padding:12px 18px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.section-head h3{font-family:'Syne',sans-serif;font-size:.88rem;font-weight:700;color:var(--text);}
.section-badge{font-size:.62rem;font-weight:700;padding:2px 8px;border-radius:100px;background:var(--accent-light);color:var(--accent);border:1px solid #93c5fd;}
.viz-table{width:100%;border-collapse:collapse;font-size:.75rem;}
.viz-table th{padding:8px 12px;text-align:left;border-bottom:1px solid var(--border);font-size:.64rem;font-weight:700;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);background:var(--surface);white-space:nowrap;}
.viz-table th.section-col-head{background:var(--accent-light);color:var(--accent);text-align:center;}
.viz-table th.panel-head{background:#eff6ff;color:#1d4ed8;text-align:center;}
.viz-table th.mrs-head{background:var(--purple-light);color:var(--purple);text-align:center;}
.viz-table th.status-head{background:var(--surface2);color:var(--text2);text-align:center;}
.viz-table td{padding:8px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.viz-table tr:last-child td{border-bottom:none;}
.viz-table tr:hover td{background:var(--surface);}
.td-mono{font-family:'IBM Plex Mono',monospace;font-size:.72rem;}
.td-center{text-align:center;}
.pill-excess{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:.65rem;font-weight:700;background:var(--success-bg);color:var(--success);border:1px solid var(--success-border);}
.pill-short{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:.65rem;font-weight:700;background:var(--danger-bg);color:var(--danger);border:1px solid var(--danger-border);}
.pill-exact{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:.65rem;font-weight:700;background:var(--warning-bg);color:var(--warning);border:1px solid var(--warning-border);}
.pill-nomrs{display:inline-flex;align-items:center;gap:4px;padding:2px 8px;border-radius:100px;font-size:.65rem;font-weight:700;background:var(--surface2);color:var(--muted);border:1px solid var(--border2);}

/* Stats bar */
.stats-bar{display:flex;gap:12px;margin-bottom:16px;flex-wrap:wrap;}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 16px;display:flex;align-items:center;gap:10px;box-shadow:var(--shadow);flex:1;min-width:120px;}
.stat-icon{font-size:1.1rem;}
.stat-val{font-family:'Syne',sans-serif;font-size:1.2rem;font-weight:700;color:var(--text);}
.stat-label{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.06em;}

/* ‚îÄ‚îÄ SCREEN 3 ‚Äî EXPORT ‚îÄ‚îÄ */
.s3-layout{display:flex;flex-direction:column;align-items:center;justify-content:center;flex:1;padding:32px;gap:20px;}
.export-card{background:var(--white);border:1px solid var(--border);border-radius:var(--radius);padding:32px 36px;width:100%;max-width:560px;box-shadow:var(--shadow-md);text-align:center;}
.export-card h2{font-family:'Syne',sans-serif;font-size:1.3rem;font-weight:800;color:var(--text);margin-bottom:6px;}
.export-card p{font-size:.78rem;color:var(--muted);margin-bottom:24px;line-height:1.6;}
.export-summary{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:24px;text-align:left;}
.exp-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:10px 14px;}
.exp-item-val{font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:700;color:var(--accent);}
.exp-item-label{font-size:.68rem;color:var(--muted);margin-top:2px;}

/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
body.dark{
  --bg:#13151f;--white:#1e2235;--surface:#252840;--surface2:#2d3148;
  --border:#363b58;--border2:#444968;--accent:#4f8eff;--accent-light:#1e2d4a;
  --accent-hover:#6aa3ff;--text:#e8eaf2;--text2:#9ba3c0;--muted:#6b7494;
  --success:#22c55e;--success-bg:#0f2d1a;--success-border:#166334;
  --danger:#f87171;--danger-bg:#2d0f0f;--danger-border:#991b1b;
  --warning:#fbbf24;--warning-bg:#2d2008;--warning-border:#854d0e;
  --purple:#a78bfa;--purple-light:#1e1535;--purple-border:#5b21b6;
  --shadow:0 1px 3px rgba(0,0,0,.3);--shadow-md:0 4px 16px rgba(0,0,0,.4);
}
body.dark header{background:#1a1d2e;border-color:#2a2e45;}
body.dark .stepper{background:#1a1d2e;border-color:#2a2e45;}
body.dark .s1-footer{background:#1a1d2e;}
body.dark .upload-zone.bom-zone{background:#1e2d4a;border-color:#2d4a8a;}
body.dark .upload-zone.mrs-zone{background:#1e1535;border-color:#5b21b6;}
body.dark .col-map-card{background:var(--surface);}
body.dark .col-input{background:var(--surface2);color:var(--text);}
body.dark .s2-toolbar{background:#1a1d2e;}
.dark-toggle{display:flex;align-items:center;gap:8px;background:var(--surface2);border:1px solid var(--border);border-radius:100px;padding:5px 12px;cursor:pointer;font-size:.75rem;font-weight:600;color:var(--text2);transition:all .2s;font-family:'IBM Plex Sans',sans-serif;}
.dark-toggle:hover{background:var(--accent-light);color:var(--accent);border-color:var(--accent);}
.dark-toggle-icon{font-size:.9rem;transition:transform .3s;}
body.dark .dark-toggle-icon{transform:rotate(180deg);}

.empty-state{text-align:center;padding:60px 20px;color:var(--muted);}
.empty-state p{font-size:.8rem;margin-top:8px;line-height:1.6;}
</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div style="display:flex;align-items:center;gap:14px;">
    <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
      <rect width="32" height="32" rx="8" fill="#2563eb"/>
      <path d="M7 10L12 22L16 13L20 22L25 10" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="16" cy="13" r="1.5" fill="white"/>
    </svg>
    <div>
      <div class="logo">Work<span>ezz</span></div>
      <div class="logo-sub">Procurement Planner</div>
    </div>
  </div>
  <div style="display:flex;align-items:center;gap:10px;">
    <button class="dark-toggle" onclick="toggleDark()">
      <span class="dark-toggle-icon" id="darkIcon">üåô</span>
      <span id="darkLabel">Dark Mode</span>
    </button>
    <a class="home-btn" href="index.html">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
      Home
    </a>
  </div>
</header>

<!-- STEPPER -->
<div class="stepper">
  <div class="step active" id="step1"><div class="step-num">1</div> Import & Map</div>
  <span class="step-arrow">‚Ä∫</span>
  <div class="step" id="step2"><div class="step-num">2</div> Data Visualization</div>
  <span class="step-arrow">‚Ä∫</span>
  <div class="step" id="step3"><div class="step-num">3</div> Export</div>
</div>

<!-- ‚ïê‚ïê SCREEN 1 ‚Äî IMPORT & MAP ‚ïê‚ïê -->
<div class="screen active" id="screen1">
  <div class="s1-layout">

    <!-- BOM SIDE -->
    <div class="s1-panel">
      <div>
        <div class="panel-title">üìä BOM Sheet</div>
        <div class="panel-sub">Bill of Materials ‚Äî panel quantities per part</div>
      </div>

      <input type="file" id="bomInput" accept=".xls,.xlsx" style="display:none;" onchange="handleBOM(this)">
      <div id="bomEmptyZone" class="upload-zone bom-zone" onclick="document.getElementById('bomInput').click()">
        <span class="uz-icon">üìä</span>
        <div class="uz-text"><strong>Click to upload BOM Sheet</strong></div>
        <div class="uz-sub">.xls or .xlsx</div>
      </div>
      <div id="bomChip" class="file-chip bom-chip" style="display:none;">
        <div class="fc-icon" id="bomExt">XLS</div>
        <div class="fc-info">
          <div class="fc-name" id="bomName">‚Äî</div>
          <div class="fc-sub" id="bomSize">‚Äî</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="clearBOM()">‚úï</button>
      </div>

      <!-- BOM Column Mapping -->
      <div class="col-map-card">
        <div class="section-label">BOM Column Mapping</div>
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">Part data starts from which row?</div>
        <div class="col-map-grid">
          <div class="col-map-item">
            <span class="col-map-label">Part Number Col</span>
            <input class="col-input" id="bomColPart" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Description Col</span>
            <input class="col-input" id="bomColDesc" value="D" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Make Col</span>
            <input class="col-input" id="bomColMake" value="B" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Data Start Row</span>
            <input class="col-input" id="bomStartRow" value="2" maxlength="4" type="number" min="1">
          </div>
          <div class="col-map-item" style="grid-column:1/-1;">
            <span class="col-map-label">Panel columns start at</span>
            <input class="col-input" id="bomColPanelStart" value="E" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
        </div>
      </div>
    </div>

    <!-- MRS SIDE -->
    <div class="s1-panel">
      <div>
        <div class="panel-title">üîÄ MRS Sheet</div>
        <div class="panel-sub">Material Requirement Schedule ‚Äî available quantities</div>
      </div>

      <input type="file" id="mrsInput" accept=".xls,.xlsx" style="display:none;" onchange="handleMRS(this)">
      <div id="mrsEmptyZone" class="upload-zone mrs-zone" onclick="document.getElementById('mrsInput').click()">
        <span class="uz-icon">üîÄ</span>
        <div class="uz-text"><strong>Click to upload MRS Sheet</strong></div>
        <div class="uz-sub">.xls or .xlsx</div>
      </div>
      <div id="mrsChip" class="file-chip mrs-chip" style="display:none;">
        <div class="fc-icon" id="mrsExt">XLS</div>
        <div class="fc-info">
          <div class="fc-name" id="mrsName">‚Äî</div>
          <div class="fc-sub" id="mrsSize">‚Äî</div>
        </div>
        <button class="btn btn-danger-outline btn-sm" onclick="clearMRS()">‚úï</button>
      </div>

      <!-- MRS Column Mapping -->
      <div class="col-map-card">
        <div class="section-label">MRS Column Mapping</div>
        <div style="font-size:.72rem;color:var(--muted);margin-bottom:10px;">Which columns hold the key fields?</div>
        <div class="col-map-grid">
          <div class="col-map-item">
            <span class="col-map-label">Part Number Col</span>
            <input class="col-input" id="mrsColPart" value="C" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Section Col</span>
            <input class="col-input" id="mrsColSection" value="G" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Qty Col</span>
            <input class="col-input" id="mrsColQty" value="P" maxlength="2" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div class="col-map-item">
            <span class="col-map-label">Data Start Row</span>
            <input class="col-input" id="mrsStartRow" value="9" maxlength="4" type="number" min="1">
          </div>
        </div>
      </div>

      <!-- Info box -->
      <div style="background:var(--accent-light);border:1px solid #bfdbfe;border-radius:var(--radius-sm);padding:12px 14px;font-size:.73rem;color:#1e40af;line-height:1.7;">
        <strong>Section naming rule:</strong> Panel names like <code style="background:#dbeafe;padding:1px 5px;border-radius:3px;">ZA_P1_PANEL1</code> belong to section <code style="background:#dbeafe;padding:1px 5px;border-radius:3px;">ZA_P1</code> ‚Äî first 2 parts before underscore.
      </div>
    </div>

  </div>

  <div class="s1-footer">
    <span id="s1hint" style="font-size:.74rem;color:var(--muted);">Upload both BOM and MRS sheets to continue</span>
    <button class="btn btn-primary btn-lg" id="processBtn" onclick="processData()" disabled>Process Data ‚Üí</button>
  </div>
</div>

<!-- ‚ïê‚ïê SCREEN 2 ‚Äî VISUALIZATION ‚ïê‚ïê -->
<div class="screen" id="screen2">
  <div class="s2-layout">
    <div class="s2-toolbar">
      <span style="font-size:.74rem;font-weight:600;color:var(--text2);margin-right:4px;">Sections:</span>
      <div id="sectionPills" style="display:flex;gap:6px;flex-wrap:wrap;flex:1;"></div>
      <div style="display:flex;gap:8px;margin-left:auto;">
        <button class="btn btn-secondary btn-sm" onclick="goTo(1)">‚Äπ Back</button>
        <button class="btn btn-primary btn-sm" onclick="goTo(3)">Export ‚Üí</button>
      </div>
    </div>

    <!-- Stats bar -->
    <div style="padding:16px 24px 0;flex-shrink:0;">
      <div class="stats-bar" id="statsBar"></div>
    </div>

    <div class="s2-content" id="vizContent">
      <div class="empty-state">üìä<p>Process data to see visualization</p></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê SCREEN 3 ‚Äî EXPORT ‚ïê‚ïê -->
<div class="screen" id="screen3">
  <div class="s3-layout">
    <div class="export-card">
      <div style="font-size:2.5rem;margin-bottom:12px;">üì•</div>
      <h2>Export Procurement Plan</h2>
      <p>Your data is ready. The export will create a multi-column Excel with sections, panels, MRS quantities, and excess/shortage status.</p>

      <div class="export-summary" id="exportSummary"></div>

      <button class="btn btn-success btn-full btn-lg" onclick="exportExcel()">‚¨á Download Excel</button>
    </div>
    <button class="btn btn-secondary" onclick="goTo(2)">‚Äπ Back to Visualization</button>
  </div>
</div>

<script>
// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
let bomFile = null, mrsFile = null;
let processedData = null; // { sections, parts }

function colIdx(letter) { return letter.toUpperCase().charCodeAt(0) - 65; }
function formatSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b/1024).toFixed(1) + ' KB';
  return (b/1048576).toFixed(1) + ' MB';
}
function todayStr() { return new Date().toISOString().slice(0,10); }

// Section name = first 2 underscore-separated parts
function sectionFromPanel(panelName) {
  const parts = panelName.split('_');
  return parts.slice(0, 2).join('_');
}

// ‚îÄ‚îÄ FILE HANDLERS ‚îÄ‚îÄ
function handleBOM(input) {
  if (!input.files.length) return;
  bomFile = input.files[0];
  input.value = '';
  const ext = bomFile.name.split('.').pop().toUpperCase();
  document.getElementById('bomEmptyZone').style.display = 'none';
  document.getElementById('bomChip').style.display = 'flex';
  document.getElementById('bomExt').textContent = ext;
  document.getElementById('bomName').textContent = bomFile.name;
  document.getElementById('bomSize').textContent = formatSize(bomFile.size);
  checkReady();
}
function clearBOM() {
  bomFile = null;
  document.getElementById('bomEmptyZone').style.display = '';
  document.getElementById('bomChip').style.display = 'none';
  document.getElementById('bomInput').value = '';
  checkReady();
}
function handleMRS(input) {
  if (!input.files.length) return;
  mrsFile = input.files[0];
  input.value = '';
  const ext = mrsFile.name.split('.').pop().toUpperCase();
  document.getElementById('mrsEmptyZone').style.display = 'none';
  document.getElementById('mrsChip').style.display = 'flex';
  document.getElementById('mrsExt').textContent = ext;
  document.getElementById('mrsName').textContent = mrsFile.name;
  document.getElementById('mrsSize').textContent = formatSize(mrsFile.size);
  checkReady();
}
function clearMRS() {
  mrsFile = null;
  document.getElementById('mrsEmptyZone').style.display = '';
  document.getElementById('mrsChip').style.display = 'none';
  document.getElementById('mrsInput').value = '';
  checkReady();
}
function checkReady() {
  const ready = bomFile && mrsFile;
  document.getElementById('processBtn').disabled = !ready;
  document.getElementById('s1hint').textContent = !bomFile
    ? 'Upload BOM sheet to continue'
    : !mrsFile ? 'Upload MRS sheet to continue'
    : 'Both files ready ‚Äî click Process Data';
}

// ‚îÄ‚îÄ READ EXCEL ‚îÄ‚îÄ
function readExcel(file) {
  return new Promise(resolve => {
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(e.target.result, { type: 'array' });
        // Pick sheet with most data
        let best = [], bestCount = 0;
        for (const name of wb.SheetNames) {
          const ws = wb.Sheets[name];
          const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '', raw: true });
          const count = data.filter(r => r.some(v => v !== '')).length;
          if (count > bestCount) { bestCount = count; best = data; }
        }
        resolve(best);
      } catch(e) { resolve([]); }
    };
    reader.readAsArrayBuffer(file);
  });
}

// ‚îÄ‚îÄ PROCESS DATA ‚îÄ‚îÄ
async function processData() {
  document.getElementById('processBtn').disabled = true;
  document.getElementById('processBtn').textContent = 'Processing‚Ä¶';

  const bomStartRow = parseInt(document.getElementById('bomStartRow').value) || 9;
  const mrsStartRow = parseInt(document.getElementById('mrsStartRow').value) || 9;
  const bomColPart  = colIdx(document.getElementById('bomColPart').value || 'C');
  const bomColDesc  = colIdx(document.getElementById('bomColDesc').value || 'D');
  const bomColMake  = colIdx(document.getElementById('bomColMake').value || 'B');
  const bomPanelStart = colIdx(document.getElementById('bomColPanelStart').value || 'E');
  const mrsColPart  = colIdx(document.getElementById('mrsColPart').value || 'C');
  const mrsColSect  = colIdx(document.getElementById('mrsColSection').value || 'G');
  const mrsColQty   = colIdx(document.getElementById('mrsColQty').value || 'P');

  const [bomData, mrsData] = await Promise.all([readExcel(bomFile), readExcel(mrsFile)]);

  // ‚îÄ‚îÄ Parse BOM header row ‚Äî row 1 (index 0) always has panel names ‚îÄ‚îÄ
  const headerRow = bomData[0] || []; // row 1 = panel headers
  const panels = [];
  for (let c = bomPanelStart; c < headerRow.length; c++) {
    const h = String(headerRow[c] || '').trim();
    if (h) panels.push({ name: h, col: c });
  }

  console.log('BOM panels found:', panels.map(p => p.name));

  // Determine sections from panels ‚Äî first 2 underscore parts
  const sectionMap = new Map();
  panels.forEach(p => {
    const sec = sectionFromPanel(p.name);
    if (!sectionMap.has(sec)) sectionMap.set(sec, []);
    sectionMap.get(sec).push(p.name);
  });

  console.log('Sections:', [...sectionMap.keys()]);

  // ‚îÄ‚îÄ Parse BOM data rows ‚Äî starts from bomStartRow (default 2 = index 1) ‚îÄ‚îÄ
  const partsMap = new Map();
  for (let i = bomStartRow - 1; i < bomData.length; i++) {
    const row = bomData[i];
    const partNum = String(row[bomColPart] || '').trim();
    if (!partNum) continue;
    const make = String(row[bomColMake] || '').trim();
    const desc = String(row[bomColDesc] || '').trim();
    const key = partNum.toLowerCase();
    if (!partsMap.has(key)) {
      partsMap.set(key, { partNum, make, desc, panelQtys: {} });
    }
    const entry = partsMap.get(key);
    panels.forEach(p => {
      const rawQty = row[p.col];
      const qty = typeof rawQty === 'number' ? rawQty : parseFloat(String(rawQty || '').replace(/,/g,'')) || 0;
      entry.panelQtys[p.name] = (entry.panelQtys[p.name] || 0) + qty;
    });
  }

  console.log('Parts found in BOM:', partsMap.size);

  // ‚îÄ‚îÄ Parse MRS data rows ‚îÄ‚îÄ
  // Primary key = Part Number + Section
  // MRS col G section: strip to first 2 underscore parts ‚Üí ZA_P1_PANE_1 ‚Üí ZA_P1
  // Same part + same section ‚Üí SUM qty
  // Same part + different section ‚Üí separate entry
  const mrsMap = new Map();
  for (let i = mrsStartRow - 1; i < mrsData.length; i++) {
    const row = mrsData[i];
    const partNum = String(row[mrsColPart] || '').trim();
    const rawSection = String(row[mrsColSect] || '').trim();
    if (!partNum || !rawSection) continue;
    const section = rawSection.split('_').slice(0, 2).join('_');
    const rawQty = row[mrsColQty];
    const qty = typeof rawQty === 'number' ? rawQty : parseFloat(String(rawQty || '').replace(/,/g,'')) || 0;
    if (!qty) continue;
    const key = partNum.toLowerCase();
    if (!mrsMap.has(key)) mrsMap.set(key, new Map());
    mrsMap.get(key).set(section, (mrsMap.get(key).get(section) || 0) + qty);
  }

  console.log('Parts found in MRS:', mrsMap.size);
  // Log first 5 MRS entries for debugging
  let mrsDebug = 0;
  for (const [k, v] of mrsMap) {
    if (mrsDebug++ < 5) console.log('MRS entry:', k, [...v.entries()]);
  }

  // ‚îÄ‚îÄ Build final structure ‚îÄ‚îÄ
  // Columns per section: Panel1 qty | Panel2 qty | ... | MRS Qty | Excess/Shortage
  // NO total BOM column ‚Äî just individual panel qtys then MRS then status
  const sections = [];
  for (const [secName, panelNames] of sectionMap) {
    const rows = [];
    let srNo = 1;
    for (const [key, part] of partsMap) {
      // Individual qty per panel in this section
      const bomPanelQtys = panelNames.map(pn => part.panelQtys[pn] || 0);
      const totalBomQty = bomPanelQtys.reduce((a, b) => a + b, 0);
      if (totalBomQty === 0) continue; // part not used in this section at all

      // MRS qty: Part Number + Section = primary key, qty summed
      const mrsQty = mrsMap.get(key)?.get(secName) || 0;

      // Compare total BOM needed vs MRS ordered for this section
      let status, statusType;
      if (mrsQty === 0) { status = 'No MRS'; statusType = 'nomrs'; }
      else if (mrsQty > totalBomQty) { status = `+${mrsQty - totalBomQty} Excess`; statusType = 'excess'; }
      else if (mrsQty < totalBomQty) { status = `-${totalBomQty - mrsQty} Short`; statusType = 'short'; }
      else { status = 'Exact ‚úì'; statusType = 'exact'; }

      rows.push({ srNo: srNo++, make: part.make, partNum: part.partNum, desc: part.desc, bomPanelQtys, mrsQty, status, statusType });
    }
    if (rows.length) sections.push({ name: secName, panels: panelNames, rows });
  }
  console.log('Sections built:', sections.map(s => s.name + ':' + s.rows.length + 'rows'));

  processedData = { sections, sectionMap, panels };

  document.getElementById('processBtn').disabled = false;
  document.getElementById('processBtn').textContent = 'Process Data ‚Üí';

  renderVisualization();
  goTo(2);
}

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ
function goTo(n) {
  document.querySelectorAll('.screen').forEach((s, i) => {
    s.classList.toggle('active', i === n - 1);
  });
  document.querySelectorAll('.step').forEach((s, i) => {
    s.classList.remove('active','done');
    if (i + 1 === n) s.classList.add('active');
    else if (i + 1 < n) s.classList.add('done');
  });
  if (n === 3) renderExportSummary();
}

// ‚îÄ‚îÄ RENDER VISUALIZATION ‚îÄ‚îÄ
let activeSection = 'all';
function renderVisualization() {
  const { sections } = processedData;

  // Build section pills
  const pillsEl = document.getElementById('sectionPills');
  pillsEl.innerHTML = `<button class="section-pill active" onclick="filterSection('all',this)">All Sections</button>` +
    sections.map(s => `<button class="section-pill" onclick="filterSection('${s.name}',this)">${s.name} <span style="opacity:.6;font-size:.65rem;">(${s.rows.length})</span></button>`).join('');

  // Stats
  let totalExcess = 0, totalShort = 0, totalExact = 0, totalNoMrs = 0;
  sections.forEach(s => s.rows.forEach(r => {
    if (r.statusType === 'excess') totalExcess++;
    else if (r.statusType === 'short') totalShort++;
    else if (r.statusType === 'exact') totalExact++;
    else totalNoMrs++;
  }));
  document.getElementById('statsBar').innerHTML = `
    <div class="stat-card"><span class="stat-icon">üìã</span><div><div class="stat-val">${sections.reduce((a,s)=>a+s.rows.length,0)}</div><div class="stat-label">Total Parts</div></div></div>
    <div class="stat-card"><span class="stat-icon">üü¢</span><div><div class="stat-val" style="color:var(--success)">${totalExcess}</div><div class="stat-label">Excess</div></div></div>
    <div class="stat-card"><span class="stat-icon">üî¥</span><div><div class="stat-val" style="color:var(--danger)">${totalShort}</div><div class="stat-label">Shortage</div></div></div>
    <div class="stat-card"><span class="stat-icon">‚úÖ</span><div><div class="stat-val" style="color:var(--warning)">${totalExact}</div><div class="stat-label">Exact</div></div></div>
    <div class="stat-card"><span class="stat-icon">‚ö™</span><div><div class="stat-val">${totalNoMrs}</div><div class="stat-label">No MRS</div></div></div>`;

  renderSections('all');
}

function filterSection(name, el) {
  activeSection = name;
  document.querySelectorAll('.section-pill').forEach(p => p.classList.remove('active'));
  el.classList.add('active');
  renderSections(name);
}

function renderSections(filter) {
  const { sections } = processedData;
  const toShow = filter === 'all' ? sections : sections.filter(s => s.name === filter);
  const content = document.getElementById('vizContent');

  if (!toShow.length) {
    content.innerHTML = '<div class="empty-state">No data for this section.</div>';
    return;
  }

  content.innerHTML = toShow.map(sec => `
    <div class="section-block">
      <div class="section-head">
        <h3>${sec.name}</h3>
        <span class="section-badge">${sec.panels.length} panel${sec.panels.length>1?'s':''}</span>
        <span class="section-badge" style="background:var(--surface2);color:var(--text2);border-color:var(--border2);">${sec.rows.length} parts</span>
      </div>
      <div style="overflow-x:auto;">
        <table class="viz-table">
          <thead>
            <tr>
              <th rowspan="2" style="width:36px;">#</th>
              <th rowspan="2">Make</th>
              <th rowspan="2">Part Number</th>
              <th rowspan="2">Description</th>
              <th colspan="${sec.panels.length + 2}" class="section-col-head">${sec.name}</th>
            </tr>
            <tr>
              ${sec.panels.map(p => `<th class="panel-head">${p}</th>`).join('')}
              <th class="mrs-head">MRS Qty</th>
              <th class="status-head">Status</th>
            </tr>
          </thead>
          <tbody>
            ${sec.rows.map(r => `
              <tr>
                <td class="sr-no td-mono">${String(r.srNo).padStart(2,'0')}</td>
                <td style="font-size:.74rem;">${r.make || '‚Äî'}</td>
                <td class="td-mono">${r.partNum}</td>
                <td style="font-size:.74rem;max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;" title="${r.desc}">${r.desc || '‚Äî'}</td>
                ${r.bomPanelQtys.map(q => `<td class="td-center td-mono" style="font-weight:${q>0?'600':'400'};color:${q>0?'var(--text)':'var(--muted)'};">${q > 0 ? q : '‚Äî'}</td>`).join('')}
                <td class="td-center td-mono" style="color:var(--purple);font-weight:600;">${r.mrsQty > 0 ? r.mrsQty : '‚Äî'}</td>
                <td class="td-center">${statusPill(r.statusType, r.status)}</td>
              </tr>`).join('')}
          </tbody>
        </table>
      </div>
    </div>`).join('');
}

function statusPill(type, text) {
  const cls = {excess:'pill-excess',short:'pill-short',exact:'pill-exact',nomrs:'pill-nomrs'}[type] || 'pill-nomrs';
  return `<span class="${cls}">${text}</span>`;
}

// ‚îÄ‚îÄ EXPORT SUMMARY ‚îÄ‚îÄ
function renderExportSummary() {
  const { sections } = processedData;
  const totalParts = sections.reduce((a,s)=>a+s.rows.length,0);
  document.getElementById('exportSummary').innerHTML = `
    <div class="exp-item"><div class="exp-item-val">${sections.length}</div><div class="exp-item-label">Sections</div></div>
    <div class="exp-item"><div class="exp-item-val">${processedData.panels.length}</div><div class="exp-item-label">Panels</div></div>
    <div class="exp-item"><div class="exp-item-val">${totalParts}</div><div class="exp-item-label">Part Rows</div></div>
    <div class="exp-item"><div class="exp-item-val">${todayStr()}</div><div class="exp-item-label">Export Date</div></div>`;
}

// ‚îÄ‚îÄ EXPORT EXCEL ‚îÄ‚îÄ
async function exportExcel() {
  const btn = document.querySelector('.s3-layout .btn-success');
  btn.textContent = 'Generating‚Ä¶'; btn.disabled = true;

  const wb = new ExcelJS.Workbook();
  const ws = wb.addWorksheet('Procurement Plan');

  const { sections } = processedData;

  // Build header rows
  // Row 1: SR | Make | Part No | Desc | [Section merged headers]
  // Row 2:                             | [Panel cols] | MRS Qty | Status
  const row1 = ws.addRow([]);
  const row2 = ws.addRow([]);

  // Fixed headers ‚Äî row 1 cells, merged across 2 rows
  const fixedHeaders = ['SR', 'Make', 'Part Number', 'Description'];
  fixedHeaders.forEach((h, i) => {
    const cell = row1.getCell(i + 1);
    cell.value = h;
    cell.font = { bold: true, size: 9, color: { argb: 'FF1E2235' } };
    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFECEEF4' } };
    cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
    cell.border = { bottom: { style: 'thin', color: { argb: 'FFDDE0EA' } }, right: { style: 'thin', color: { argb: 'FFDDE0EA' } } };
    ws.mergeCells(1, i + 1, 2, i + 1);
  });

  // Section headers starting from col 5
  let currentCol = 5;
  const sectionColRanges = []; // for data writing

  sections.forEach(sec => {
    const colSpan = sec.panels.length + 2; // panels + MRS Qty + Status
    const startCol = currentCol;

    // Row 1: Section name merged across all its columns
    const secCell = row1.getCell(startCol);
    secCell.value = sec.name;
    secCell.font = { bold: true, size: 9, color: { argb: 'FF1D4ED8' } };
    secCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFDBEAFE' } };
    secCell.alignment = { vertical: 'middle', horizontal: 'center' };
    secCell.border = { bottom: { style: 'thin', color: { argb: 'FF93C5FD' } }, right: { style: 'medium', color: { argb: 'FF2563EB' } } };
    if (colSpan > 1) ws.mergeCells(1, startCol, 1, startCol + colSpan - 1);

    // Row 2: Panel cols + MRS Qty + Status
    sec.panels.forEach((pn, pi) => {
      const cell = row2.getCell(startCol + pi);
      cell.value = pn;
      cell.font = { bold: true, size: 8, color: { argb: 'FF1D4ED8' } };
      cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEFF6FF' } };
      cell.alignment = { vertical: 'middle', horizontal: 'center', wrapText: true };
      cell.border = { bottom: { style: 'thin', color: { argb: 'FF93C5FD' } } };
    });

    // MRS Qty header
    const mrsCell = row2.getCell(startCol + sec.panels.length);
    mrsCell.value = 'MRS Qty';
    mrsCell.font = { bold: true, size: 8, color: { argb: 'FF7C3AED' } };
    mrsCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDE9FE' } };
    mrsCell.alignment = { vertical: 'middle', horizontal: 'center' };
    mrsCell.border = { bottom: { style: 'thin', color: { argb: 'FFC4B5FD' } } };

    // Status header
    const statCell = row2.getCell(startCol + sec.panels.length + 1);
    statCell.value = 'Status';
    statCell.font = { bold: true, size: 8, color: { argb: 'FF4A5072' } };
    statCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFECEEF4' } };
    statCell.alignment = { vertical: 'middle', horizontal: 'center' };
    statCell.border = { bottom: { style: 'thin', color: { argb: 'FFDDE0EA' } }, right: { style: 'medium', color: { argb: 'FF2563EB' } } };

    sectionColRanges.push({ sec, startCol, colSpan });
    currentCol += colSpan;
  });

  row1.height = 22;
  row2.height = 30;

  // ‚îÄ‚îÄ Collect all unique parts across all sections (in order) ‚îÄ‚îÄ
  // Build a master part list maintaining BOM order
  const allPartKeys = [];
  const seenKeys = new Set();
  for (const sec of sections) {
    for (const row of sec.rows) {
      const k = row.partNum.toLowerCase();
      if (!seenKeys.has(k)) { seenKeys.add(k); allPartKeys.push(row); }
    }
  }

  // Build lookup: sectionName ‚Üí Map<partKey, rowData>
  const secPartLookup = new Map();
  for (const sec of sections) {
    const m = new Map();
    sec.rows.forEach(r => m.set(r.partNum.toLowerCase(), r));
    secPartLookup.set(sec.name, m);
  }

  // ‚îÄ‚îÄ Write data rows ‚îÄ‚îÄ
  let excelRowNum = 3;
  allPartKeys.forEach((part, idx) => {
    const dataRow = ws.addRow([]);
    const partKey = part.partNum.toLowerCase();

    // Fixed columns
    dataRow.getCell(1).value = idx + 1;
    dataRow.getCell(2).value = part.make || '';
    dataRow.getCell(3).value = part.partNum;
    dataRow.getCell(4).value = part.desc || '';

    [1,2,3,4].forEach(c => {
      const cell = dataRow.getCell(c);
      cell.font = { size: 9 };
      cell.alignment = { vertical: 'middle', wrapText: c === 4 };
      cell.border = { bottom: { style: 'thin', color: { argb: 'FFDDE0EA' } } };
      if (c === 3) { cell.font = { ...cell.font, name: 'Courier New' }; }
    });

    // Section data columns
    sectionColRanges.forEach(({ sec, startCol }) => {
      const rowData = secPartLookup.get(sec.name)?.get(partKey);

      sec.panels.forEach((pn, pi) => {
        const cell = dataRow.getCell(startCol + pi);
        const qty = rowData ? (rowData.bomPanelQtys[pi] || 0) : 0;
        cell.value = qty > 0 ? qty : '';
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.font = { size: 9, bold: qty > 0 };
        cell.border = { bottom: { style: 'thin', color: { argb: 'FFDDE0EA' } } };
      });

      // MRS Qty
      const mrsCell = dataRow.getCell(startCol + sec.panels.length);
      mrsCell.value = rowData?.mrsQty || '';
      mrsCell.alignment = { horizontal: 'center', vertical: 'middle' };
      mrsCell.font = { size: 9, bold: true, color: { argb: 'FF7C3AED' } };
      mrsCell.border = { bottom: { style: 'thin', color: { argb: 'FFDDE0EA' } } };

      // Status
      const stCell = dataRow.getCell(startCol + sec.panels.length + 1);
      const statusType = rowData?.statusType || 'nomrs';
      const statusText = rowData?.status || '‚Äî';
      stCell.value = statusText;
      stCell.alignment = { horizontal: 'center', vertical: 'middle' };
      stCell.font = { size: 9, bold: true, color: { argb: statusType === 'excess' ? 'FF15803D' : statusType === 'short' ? 'FFB91C1C' : statusType === 'exact' ? 'FF92400E' : 'FF8890AA' } };
      stCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: statusType === 'excess' ? 'FFDCFCE7' : statusType === 'short' ? 'FFFEE2E2' : statusType === 'exact' ? 'FFFEF3C7' : 'FFF7F8FB' } };
      stCell.border = { bottom: { style: 'thin', color: { argb: 'FFDDE0EA' } }, right: { style: 'medium', color: { argb: 'FF2563EB' } } };
    });

    dataRow.height = 18;
    excelRowNum++;
  });

  // Column widths
  ws.getColumn(1).width = 5;
  ws.getColumn(2).width = 20;
  ws.getColumn(3).width = 28;
  ws.getColumn(4).width = 40;
  let c = 5;
  sections.forEach(sec => {
    sec.panels.forEach(() => { ws.getColumn(c).width = 14; c++; });
    ws.getColumn(c).width = 10; c++; // MRS
    ws.getColumn(c).width = 14; c++; // Status
  });

  // Freeze panes
  ws.views = [{ state: 'frozen', xSplit: 4, ySplit: 2, activeCell: 'E3' }];

  const buffer = await wb.xlsx.writeBuffer();
  const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  saveAs(blob, `Procurement_Plan_${todayStr()}.xlsx`);

  btn.textContent = '‚¨á Download Excel';
  btn.disabled = false;
}

// ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ
function toggleDark() {
  const isDark = document.body.classList.toggle('dark');
  document.getElementById('darkIcon').textContent  = isDark ? '‚òÄÔ∏è' : 'üåô';
  document.getElementById('darkLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
  localStorage.setItem('wz-dark', isDark ? '1' : '0');
}
(function(){
  try {
    if (localStorage.getItem('wz-dark') === '1') {
      document.body.classList.add('dark');
      document.getElementById('darkIcon').textContent  = '‚òÄÔ∏è';
      document.getElementById('darkLabel').textContent = 'Light Mode';
    }
  } catch(e) {}
})();
</script>
</body>
</html>
